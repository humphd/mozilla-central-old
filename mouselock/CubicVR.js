try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(u,z,s,r,n){function q(a,c){if(typeof a!=="object")return o("enumerator validation failed, invalid type base object."),n;if(c===n)return n;else if(typeof c==="number")return c;else if(typeof c==="string"){var b=parseInt(c,10);if(c!==""&&isFinite(b))return b;b=c.toUpperCase();b=a[b];if(b!==n)return b;else{o("enumerator validation failed, unknown enum value: "+c);var b="",h;for(h in a)a.hasOwnProperty(h)&&(b!==""&&(b+=", "),b+=h.toLowerCase());o("possible enum values are: "+b);return n}}else return n}
function d(a,c){A.registry[a]=!0;var b=c(A),e;for(e in b)b.hasOwnProperty(e)&&(h[e]=b[e])}var g="";try{for(var a=z.querySelectorAll("script"),b=0,f=a.length;b<f;b++){var e=a[b].src.lastIndexOf("/CubicVR.js");e>-1&&(g=a[b].src.substr(0,e)+"/")}}catch(c){}var h=u.CubicVR={},m={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,emptyLight:null,
resizeList:[],canvasSizeFactor:1},o;try{o=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(y){o=r}var x={quality:{LOW:0,MEDIUM:1,HIGH:2}};u.cubicvr=x;var A={undef:n,nop:r,scriptLocation:g,GLCore:m,Textures:[],Textures_obj:[],Textures_ref:[],Images:[],ShaderPool:[],log:o,registry:{},enums:x,MAX_LIGHTS:6,features:{},quality:x.HIGH},w={low:{antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},medium:{antiAlias:!1,lightPerPixel:!0,
lightShadows:!1,texturePerPixel:!1,postProcess:!1},high:{antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0}};A.features=w.high;m.init=function(a,c,b){var e,f=h.util;c&&b?(c=f.getScriptContents(c),b=f.getScriptContents(b)):h.CubicVRCoreVS&&h.CubicVRCoreFS?(c=h.CubicVRCoreVS,b=h.CubicVRCoreFS):(c=f.getScriptContents(g+"CubicVR_Core.vs"),b=f.getScriptContents(g+"CubicVR_Core.fs"));if(a===n){a=z.createElement("canvas");if(!e)try{e=a.getContext("experimental-webgl",{antialias:A.features.antiAlias})}catch(d){return null}m.gl=
e;if(m.fixed_size!==null)m.width=m.fixed_size[0],m.height=m.fixed_size[1],m.resizeElement(a,m.width,m.height);else if(m.addResizeable(a),m.canvasSizeFactor!==1&&a.getContext!==n){var f=s.round(u.innerWidth*m.canvasSizeFactor),y=s.round(u.innerHeight*m.canvasSizeFactor);m.resizeElement(a,f,y);a.style.top=u.innerHeight/2-y/2+"px";a.style.left=u.innerWidth/2-f/2+"px";a.style.position="absolute"}else m.resizeElement(a,u.innerWidth,u.innerHeight);z.body.appendChild(a)}if(a.getContext!==n&&a.width!==n&&
a.height!==n){try{e||(e=a.getContext("experimental-webgl",{antialias:A.features.antiAlias})),e.viewport(0,0,a.width,a.height),m.canvas=a,m.width=a.width,m.height=a.height,e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)}catch(w){}if(!e)return null}else e=a;m.gl=e;m.CoreShader_vs=c;m.CoreShader_fs=b;e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.frontFace(e.CCW);for(c=x.light.type.NULL;c<x.light.type.MAX;c++)A.ShaderPool[c]=[];b=new h.Texture;a=new h.Material;for(c=0;c<
x.texture.map.MAX;c++)c!==x.texture.map.BUMP&&a.setTexture(b,c);a.opacity=0.5;for(c=1;;){if(!a.use(x.light.type.POINT,c)||c===8){A.MAX_LIGHTS=c;break}c++}a=m.emptyLight=new h.Light(x.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;o("Calibrated maximum lights per pass to: "+c);for(c=x.light.type.NULL;c<x.light.type.MAX;c++)A.ShaderPool[c]=[];if(m.resizeList.length)u.addEventListener("resize",function(){h.GLCore.onResize()},!1),m.resize_active=!0;return e};
m.addResizeable=function(a){h.GLCore.resizeList.push(a)};m.onResize=function(){var a=u.innerWidth,c=u.innerHeight;m.fixed_size!==null&&(a=h.GLCore.fixed_size[0],c=h.GLCore.fixed_size[1]);for(var b=0,e=h.GLCore.resizeList.length;b<e;b++)m.resizeElement(h.GLCore.resizeList[b],a,c)};m.setFixedAspect=function(a){h.GLCore.fixed_aspect=a};m.setFixedSize=function(a,c){h.GLCore.fixed_size=[a,c]};m.getCanvas=function(){return h.GLCore.canvas};m.resizeElement=function(a,c,b){var e=m.gl;if(m.fixed_aspect!==
0){var f=c*(1/h.GLCore.fixed_aspect);f>b&&(f=b,c=b*h.GLCore.fixed_aspect);b=f}if(a.getContext!==n){a.width=c;a.height=b;if(!h.GLCore.fixed_size)a.style.left=(u.innerWidth/2-c/2|0)+"px",a.style.top=(u.innerHeight/2-b/2|0)+"px",a.style.position="absolute";e.viewport(0,0,c,b)}else a.resize(c,b)};m.setDepthAlpha=function(a,c,b){m.depth_alpha=a;m.depth_alpha_near=c;m.depth_alpha_far=b};m.setDefaultFilter=function(a){m.default_filter=q(h.enums.texture.filter,a)};m.setSoftShadows=function(a){m.soft_shadow=
a};m.setCanvasSizeFactor=function(a){m.canvasSizeFactor=a};m.setQuality=function(a){a=q(x.quality,a);if(a===x.quality.HIGH)A.features=w.high;else if(a===x.quality.MEDIUM)A.features=w.medium;else if(a===x.quality.LOW)A.features=w.low;A.quality=a;return A.features};m.getQuality=function(){return A.features};var C=function(a,c,b){for(var h,e=z.getElementsByTagName("script"),f=0;f<e.length;++f){var o=e[f];if(o.getAttribute("data-cubicvr")){var d=o.getAttribute("src");if(d){var x=new XMLHttpRequest;x.open("GET",
d,!1);x.send(null);if(x.status===200||x.status===0)o.text=x.responseText}}}typeof a==="object"?a.getContext?h=a:(h=a.canvas,c=a.vertexShader||c,b=a.fragmentShader||b):a&&(a[0]=="#"&&(a=a.substr(1)),h=z.getElementById(a));return m.init(h,c,b)},O={GLCore:m,init:C,start:function(a,c,b,e,m){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=n);b=b||"Sorry, your browser does not appear to support WebGL :-(";if(a=C(a,e,m))return c&&typeof c==="function"&&c(a,h.getCanvas()),a;if(!a)return b&&typeof b==="function"?
b():alert(b),!1},addResizeable:m.addResizeable,setFixedAspect:m.setFixedAspect,setFixedSize:m.setFixedSize,setCanvasSizeFactor:m.setCanvasSizeFactor,getCanvas:m.getCanvas,enums:x,IdentityMatrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Textures:A.Textures,Textures_obj:A.Textures_obj,Images:A.Images,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){h.globalAmbient=a},setGlobalDepthAlpha:m.setDepthAlpha,setDefaultFilter:m.setDefaultFilter,setSoftShadows:m.setSoftShadows,setQuality:m.setQuality,getQuality:m.getQuality,
RegisterModule:d,getScriptLocation:function(){return g},parseEnum:q};d("Core",function(){return O})})(window,window.document,Math,function(){});
CubicVR.RegisterModule("Math",function(u){function z(a){return this.clearStack(a)}function s(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var r=u.undef,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],q=Math.PI/2,d={length:function(a){var b=a[0],f=a[1],a=a[2];return Math.sqrt(b*b+f*f+a*a)},normalize:function(a){var b=a[0],f=a[1],e=a[2];
if(b=Math.sqrt(b*b+f*f+e*e))return[a[0]/b,a[1]/b,a[2]/b];return[0,0,0]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,
b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,f){f===r&&(f=1.0E-7);if(a===r&&b===r)return!0;if(a===r||b===r)return!1;return Math.abs(a[0]-b[0])<f&&Math.abs(a[1]-b[1])<f&&Math.abs(a[2]-b[2])<f},moveViewRelative:function(a,b,f,e,c){var h=Math.sqrt(f*f+e*e),b=Math.atan2(b[2]-a[2],b[0]-a[0])+Math.atan2(e,f)+q;if(typeof c==="object")return[c[0]+h*Math.cos(b),c[1],c[2]+h*Math.sin(b)];return[a[0]+h*Math.cos(b),a[1],a[2]+h*Math.sin(b)]},trackTarget:function(a,b,f,e){var b=d.subtract(b,a),c=
d.length(b),h;h=d.normalize(b);h=d.multiply(h,f*(1/(1/(c-e))));c>e?a=d.add(a,h):c<e?(h=d.normalize(b),h=d.multiply(h,f*(1/(1/Math.abs(c-e)))),a=d.subtract(a,h)):a=[a[0],a[1]+h[2],a[2]];return a},getClosestTo:function(a,b,f){b=d.subtract(b,a);f=d.subtract(f,a);return d.add(d.multiply(b,d.dot(b,f)/d.dot(b,b)),a)},linePlaneIntersect:function(a,b,f,e){var c=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(e[0]-f[0])+a[1]*(e[1]-f[1])+a[2]*(e[2]-f[2]);if(Math.abs(b)<0.001)return!1;a=-(c+a[0]*f[0]+a[1]*f[1]+a[2]*
f[2])/b;return[f[0]+a*(e[0]-f[0]),f[1]+a*(e[1]-f[1]),f[2]+a*(e[2]-f[2])]}},g={lookat:function(a,b,f,e,c,h,m,o,g){var x=[],A=[],w=[],A=[];x[0]=e-a;x[1]=c-b;x[2]=h-f;w[0]=m;w[1]=o;w[2]=g;x=d.normalize(x);A=d.cross(x,w);A=d.normalize(A);w=d.cross(A,x);A=[A[0],w[0],-x[0],0,A[1],w[1],-x[1],0,A[2],w[2],-x[2],0,0,0,0,1];e=new CubicVR.Transform(A);e.translate([-a,-b,-f]);return e.getResult()},multiply:function(a,b,f){f===r&&(f=[]);f[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];f[1]=a[1]*b[0]+a[5]*b[1]+a[9]*
b[2]+a[13]*b[3];f[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];f[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];f[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];f[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];f[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];f[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];f[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];f[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];f[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];f[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];f[12]=a[0]*
b[12]+a[4]*b[13]+a[8]*b[14]+a[12]*b[15];f[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];f[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];f[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return f},vec4_multiply:function(a,b,f){f===r&&(f=[]);f[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];f[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];f[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];f[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return f},vec3_multiply:function(a,b,f){f===r&&(f=[]);f[0]=b[0]*a[0]+
b[4]*a[1]+b[8]*a[2]+b[12];f[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];f[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return f},perspective:function(a,b,f,e){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(e+f)/(e-f),-1,0,0,-(2*e*f)/(e-f),0]},ortho:function(a,b,f,e,c,h){return[2/(b-a),0,0,0,0,2/(e-f),0,0,0,0,-2/(h-c),0,-(a+b)/(b-a),-(e+f)/(e-f),-(h+c)/(h-c),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*
a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],f=a[0],e=a[1],c=a[2],h=a[4],m=a[5],o=a[6],d=a[8],x=a[9],a=a[10],g=a*m-o*x,w=-a*h+o*d,C=x*h-m*d,n=f*g+e*w+c*C;if(!n)return null;n=1/n;b[0]=g*n;b[1]=
(-a*e+c*x)*n;b[2]=(o*e-c*m)*n;b[3]=w*n;b[4]=(a*f-c*d)*n;b[5]=(-o*f+c*h)*n;b[6]=C*n;b[7]=(-x*f+e*d)*n;b[8]=(m*f-e*h)*n;return b},inverse:function(a,b){var f=a[0]*a[5]-a[1]*a[4],e=a[0]*a[6]-a[2]*a[4],c=a[0]*a[7]-a[3]*a[4],h=a[1]*a[6]-a[2]*a[5],m=a[1]*a[7]-a[3]*a[5],o=a[2]*a[7]-a[3]*a[6],d=a[8]*a[13]-a[9]*a[12],x=a[8]*a[14]-a[10]*a[12],g=a[8]*a[15]-a[11]*a[12],w=a[9]*a[14]-a[10]*a[13],C=a[9]*a[15]-a[11]*a[13],n=a[10]*a[15]-a[11]*a[14],q=f*n-e*C+c*w+h*g-m*x+o*d;if(q!==0)return b===r&&(b=[]),b[0]=0+a[5]*
n-a[6]*C+a[7]*w,b[4]=0-a[4]*n+a[6]*g-a[7]*x,b[8]=0+a[4]*C-a[5]*g+a[7]*d,b[12]=0-a[4]*w+a[5]*x-a[6]*d,b[1]=0-a[1]*n+a[2]*C-a[3]*w,b[5]=0+a[0]*n-a[2]*g+a[3]*x,b[9]=0-a[0]*C+a[1]*g-a[3]*d,b[13]=0+a[0]*w-a[1]*x+a[2]*d,b[2]=0+a[13]*o-a[14]*m+a[15]*h,b[6]=0-a[12]*o+a[14]*c-a[15]*e,b[10]=0+a[12]*m-a[13]*c+a[15]*f,b[14]=0-a[12]*h+a[13]*e-a[14]*f,b[3]=0-a[9]*o+a[10]*m-a[11]*h,b[7]=0+a[8]*o-a[10]*c+a[11]*e,b[11]=0-a[8]*m+a[9]*c-a[11]*f,b[15]=0+a[8]*h-a[9]*e+a[10]*f,f=1/q,b[0]*=f,b[1]*=f,b[2]*=f,b[3]*=f,b[4]*=
f,b[5]*=f,b[6]*=f,b[7]*=f,b[8]*=f,b[9]*=f,b[10]*=f,b[11]*=f,b[12]*=f,b[13]*=f,b[14]*=f,b[15]*=f,b;return null},identity:function(a){if(a==r)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,f,e){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,f,1];if(e===r)return a;g.multiply(e.slice(0),a,e)},rotateAxis:function(a,b,f,e,c){var h=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=
[a+b*b*(1-a),b*f*(1-a)-e*h,b*e*(1-a)+f*h,0,f*b*(1-a)+e*h,a+f*f*(1-a),f*e*(1-a)-b*h,0,e*b*(1-a)-f*h,e*f*(1-a)+b*h,a+e*e*(1-a),0,0,0,0,1];if(c===r)return b;g.multiply(c.slice(0),b,c)},rotate:function(a,b,f,e){var c;e===r&&(e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);f!==0&&(c=Math.sin(f*(Math.PI/180)),f=Math.cos(f*(Math.PI/180)),g.multiply(e.slice(0),[f,c,0,0,-c,f,0,0,0,0,1,0,0,0,0,1],e));b!==0&&(c=Math.sin(b*(Math.PI/180)),f=Math.cos(b*(Math.PI/180)),g.multiply(e.slice(0),[f,0,-c,0,0,1,0,0,c,0,f,0,0,0,0,
1],e));a!==0&&(c=Math.sin(a*(Math.PI/180)),f=Math.cos(a*(Math.PI/180)),g.multiply(e.slice(0),[1,0,0,0,0,f,c,0,0,-c,f,0,0,0,0,1],e));return e},scale:function(a,b,f,e){if(e===r)return[a,0,0,0,0,b,0,0,0,0,f,0,0,0,0,1];g.multiply(e.slice(0),[a,0,0,0,0,b,0,0,0,0,f,0,0,0,0,1],e)},transform:function(a,b,f){var e=g.identity();a&&g.translate(a[0],a[1],a[2],e);b&&(b[0]===0&&b[1]===0&&b[2]===0||g.rotate(b[0],b[1],b[2],e));f&&(f[0]===1&&f[1]===1&&f[2]===1||g.scale(f[0],f[1],f[2],e));return e}};z.prototype={setIdentity:function(){this.m_stack[this.c_stack]=
[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=CubicVR.mat4;if(!this.c_stack)return this.m_stack[0];var b=n;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var f=this.valid;f<this.c_stack+1;f++)b=a.multiply(b,this.m_stack[f]),this.m_cache[f]=b;this.valid=this.c_stack-1;return this.result=
this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:n;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==r?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,f){var e=CubicVR.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var c=this.getIdentity();c[12]=a;c[13]=b;c[14]=f;this.m_stack[this.c_stack]=
e.multiply(this.m_stack[this.c_stack],c);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,f){var e=CubicVR.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);var c=this.getIdentity();c[0]=a;c[5]=b;c[10]=f;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],c);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,f,e){var c=CubicVR.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],
0,1,0),this.rotate(a[2],0,0,1),this;var h,m;if(b||f||e)h=Math.sin(-a*(Math.PI/180)),m=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=m*b,a[9]=h*b,a[6]=-h*b,a[10]=m*b,this.m_stack[this.c_stack]=c.multiply(a,this.m_stack[this.c_stack]));f&&(b=this.getIdentity(),b[0]=m*f,b[8]=-h*f,b[2]=h*f,b[10]=m*f,this.m_stack[this.c_stack]=c.multiply(b,this.m_stack[this.c_stack]));e&&(f=this.getIdentity(),f[0]=m*e,f[4]=h*e,f[1]=-h*e,f[5]=m*e,this.m_stack[this.c_stack]=c.multiply(f,this.m_stack[this.c_stack]));
this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};s.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],f,e,c;b>1.0E-8?(f=Math.sqrt(b)*2,b=(a[9]-a[6])/f,e=(a[2]-a[8])/f,c=(a[4]-a[1])/f,a=0.25*f):a[0]>a[5]&&a[0]>a[10]?(f=Math.sqrt(1+a[0]-a[5]-a[10])*2,b=0.25*f,e=(a[4]+a[1])/f,c=(a[2]+a[8])/f,
a=(a[9]-a[6])/f):a[5]>a[10]?(f=Math.sqrt(1+a[5]-a[0]-a[10])*2,b=(a[4]+a[1])/f,e=0.25*f,c=(a[9]+a[6])/f,a=(a[2]-a[8])/f):(f=Math.sqrt(1+a[10]-a[0]-a[5])*2,b=(a[2]+a[8])/f,e=(a[9]+a[6])/f,c=0.25*f,a=(a[4]-a[1])/f);this.x=b;this.y=e;this.z=c;this.w=a},fromEuler:function(a,b,f){var e=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),c=Math.cos(Math.PI/180*f/2),f=Math.sin(Math.PI/180*f/2),h=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),m=e*c,o=b*f;this.w=m*h-o*a;this.x=m*a+o*h;this.y=b*c*h+
e*f*a;this.z=e*f*h-b*c*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,f=this.y*this.y,e=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-f+e+a),180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-f-e+a)]},multiply:function(a,b){b===r&&(b=a,a=this);return new s(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,
b,f){f===r&&(f=1.0E-8);if(a===r&&b===r)return!0;if(a===r||b===r)return!1;return Math.abs(a[0]-b[0])<f&&Math.abs(a[1]-b[1])<f}},vec3:d,mat3:{transpose_inline:function(a){var b=a[1],f=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=f;a[7]=e},vec3_multiply:function(a,b,f){f===r&&(f=[]);f[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];f[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];f[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return f}},mat4:g,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>
b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var f=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];if(f<0)return-1;else if(f>
0)return 1;return 0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var f=CubicVR.vec3.subtract([a[0],a[1],a[2]],[b[0],b[1],b[2]]),f=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),e=a[3]+b[3];if(f*f<e*e)return!0;return!1}},triangle:{normal:function(a,b,f,e){e===r&&(e=[]);var c=a[0]-b[0],h=a[1]-b[1],a=a[2]-b[2],m=b[0]-f[0],o=b[1]-f[1],b=b[2]-f[2];e[0]=h*b-a*o;e[1]=a*m-c*b;e[2]=c*o-h*m;return e}},Transform:z,Quaternion:s}});
CubicVR.RegisterModule("Utility",function(u){var z=u.undef,s=u.log,r={},n={},q={multiSplit:function(d,g){for(var a=d.split(g[0]),b=1,f=g.length;b<f;b++)for(var e=g[b],c=0,h=a.length;c<h;c++){var m=a[c].trim().split(e),o=!0;if(m.length>1)for(var y=0;y<m.length;y++)m[y].trim()!==""&&(a.splice(c+y,y===0?1:0,m[y]),y&&h++,o=!1);else a[c]=a[c].trim().replace(e,""),a[c]!==""&&(o=!1);o&&(a.splice(c,1),h--,c--)}return a},getJSONScriptObj:function(d,g){if(typeof d==="string"&&d.length>0&&d.charAt(0)==="#"){var a=
document.getElementById(d.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),g&&g(a),a}return d},getScriptContents:function(d){var g=document.getElementById(d),a="",b="";if(g){if(g.src!==""||g.attributes.srcUrl!==z)b=g.src!==""?g.src:g.attributes.srcUrl.value}else b=d;if(b.length!==0){if(d=new XMLHttpRequest,d.open("GET",b,!1),d.send(null),d.status===200||d.status===0)a=d.responseText}else for(b=g.firstChild;b;)b.nodeType===3&&(a+=b.textContent),b=b.nextSibling;return a},xmlNeedsBadgerFish:function(d){for(d=
[d];d.length;){var g=d.pop();if(g.attributes&&g.attributes.length)return!0;for(var a=0,b=g.childNodes.length;a<b;a++)d.push(g.childNodes[a])}return!1},getFirstEntry:function(d){for(var g in d)if(d.hasOwnProperty(g))return d[g]},getURIFileType:function(d){function g(a){for(var c in f)if(f.hasOwnProperty(c)&&f[c].indexOf(a)!==-1)return c;return z}var a=d.toLowerCase(),b=["_ext","ext"],f={json:["js","javascript","json"],xml:["xml"]};if(a.indexOf("?")!==-1){var e=a.split("?"),a=e[0];if(e[1])for(var e=
e[1].indexOf("&")===-1?[e[1]]:e[1].split("&"),c=0,h=e.length;c<h;c++){var m=e[c];if(m.indexOf("=")!==-1&&(m=m.split("="),b.indexOf(m[0])!==-1)){var o=g(m[1]);if(o)return o;else s("Unable to determine extension type '"+m[1]+"' provided for URI: ["+d+"], falling back to filename part.")}}}if(a.indexOf(".")!==-1)return d=a.split("."),g(d[d.length-1]);return z},get:function(d,g){var a=null,b=null,f=null,g=g||null;if(d===z)return z;if(isFinite(d))return d;typeof d==="function"&&(d=d(g));if(typeof d===
"object"){if(g&&!(d instanceof g))return new g(d);return d}if(typeof d=="string"){if(d.indexOf("\n")!==-1)return d;else d[0]=="#"&&(a=d.substr(1),(f=document.getElementById(a))&&(b=f.src||null));!f&&!a&&!b&&d&&(b=d)}if(f&&!b)return CubicVR.util.collectTextNode(f);else if(b){a=null;f=n[b]||null;if(!f){var e=q.getURIFileType(b);if(e===z)return b;e==="json"?f=CubicVR.util.getJSON(b):e==="xml"&&(a=CubicVR.util.getXML(b));a&&a.childNodes?f=q.getFirstEntry(q.xml2json(a)):a&&(f=a)}f&&n[b]===z&&(n[b]=f);
if(g)if(r[b]&&r[b]instanceof g)return r[b];else{if(f)return r[b]=new g(f),r[b]}else if(f)return f;return b}else return a&&!f&&console.log("Unable to retrieve requested ID: '"+d+"'"),z},clearCache:function(){r={};n={}},getURL:function(d){try{var g=new XMLHttpRequest;g.open("GET",d,!1);g.send(null);if(g.status===200||g.status===0)if(g.responseText.length)return g.responseText;else if(g.responseXML)return g.responseXML}catch(a){alert(d+" failed to load.")}return null},getXML:function(d){try{var g=new XMLHttpRequest;
g.open("GET",d,!1);g.overrideMimeType("application/xml");g.send(null);if(g.status===200||g.status===0)return g.responseXML}catch(a){try{alert(d+" failed to load.")}catch(b){throw a;}}return null},getJSON:function(d){try{var g=new XMLHttpRequest;g.open("GET",d,!1);g.overrideMimeType("application/json");g.send(null);if(g.status===200||g.status===0)return eval("("+g.responseText+")")}catch(a){try{alert(d+" failed to load.")}catch(b){throw a;}}return null},repackArray:function(d,g,a){d.length!==parseInt(g,
10)*parseInt(a,10)&&s("array repack error, data size !== stride*count: data.length="+d.length+" stride="+g+" count="+a);for(var a=[],b=0,f=0,e=d.length;f<e;f++){var c=f%g;c===0&&(a[b]=[]);a[b][c]=d[f];c===g-1&&b++}return a},collectTextNode:function(d){if(!d)return"";for(var g="",d=d.childNodes,a=0,b=d.length;a<b;a++)g+=d[a].nodeValue;return g},floatDelimArray:function(d,g){for(var a=d.split(g?g:","),b=0,f=a.length;b<f;b++)a[b]=parseFloat(a[b]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(d,
g){for(var a=d.split(g?g:","),b=0,f=a.length;b<f;b++)a[b]=parseInt(a[b],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(d,g){for(var a=d.split(g?g:","),b=0,f=a.length;b<f;b++)a[b]=a[b];return a},xmlstring2json:function(d){for(var d=d.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],f=[],e={},c=e,h=0,m=d.length;h<m;h++){var o=d[h];if(!(g.test(o)||o==="")&&!/<\?\s?xml[^>]*>/.test(o))if(/<.*?>/.test(o)){a=o.split(/<([^>]*?)(.*)?>/g)[2];
if(a[0]!=="/"&&(o=a.split(" "),a=o[0],o=o.slice(1).join(" "),b.push(a),f.push(e),e[a]&&!(e[a]instanceof Array)?e[a]=[e[a]]:(e[a]||(e[a]={}),e=e[a]),e instanceof Array&&(e.push({}),e=e[e.length-1]),a.substr(a.length-1)==="/"||o.substr(o.length-1)==="/"))a="/"+a;if(a[0]==="/")if(a=a.substr(1),b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;else b.pop(),e=f.length?f[f.length-1]:null,f.pop()}else{var y=f[f.length-1][a];y instanceof Array?(y.pop(),y.push(q.parseNumeric(o))):
f[f.length-1][a]=q.parseNumeric(o)}}return c},xmlstring2badgerfish:function(d){for(var d=d.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],f=[],e={},c=e,h=0,m=d.length;h<m;h++)if(a=d[h],!(g.test(a)||a==="")&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=a.split(/<([^>]*?)(.*)?>/g)[2];if(a[0]!=="/"){var o=a.split(" ");a=o[0];o=o.slice(1).join(" ");b.push(a);f.push(e);e[a]&&!(e[a]instanceof Array)?e[a]=[e[a]]:e[a]||(e[a]={});e=e[a];e instanceof Array&&
(e.push({}),e=e[e.length-1]);if(a.substr(a.length-1)==="/"||o.substr(o.length-1)==="/")a="/"+a;for(var o=q.multiSplit(o,"= "),y="",x=0;x<o.length;x++){var A=o[x];A[A.length-1]==="/"&&(A=A.substr(0,A.length-1));if(x%2===1){if(A[0]==="'"||A[0]==='"'){for(var w=A[0],A=A.substr(1);A[A.length-1]!==w&&o.length+1<x;)A+=o.splice(x+1,1);A[A.length-1]===w&&(A=A.substr(0,A.length-1))}e["@"+y]=A}else y=A}}if(a[0]==="/")if(a=a.substr(1),b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+
b[b.length-1]),!1;else b.pop(),e=f.length?f[f.length-1]:null,f.pop()}else e.$=a;return c},xml2badgerfish:function(d){var g={},a=[],b,f,e,c,h,m=/^\s+|\s+$/g;d.jsonParent=g;for(a.push(d);a.length;){f=a.pop();var o=null;e=f.jsonParent;d=0;for(b=f.childNodes.length;d<b;d++)c=f.childNodes[d],h=c.tagName,h!==z&&(o=o||{},o[h]=o[h]||0,o[h]++);if(f.attributes&&f.attributes.length){d=0;for(b=f.attributes.length;d<b;d++)c=f.attributes[d],e["@"+c.name]=c.value}d=0;for(b=f.childNodes.length;d<b;d++)if(c=f.childNodes[d],
h=c.tagName,c.nodeType===1)o[h]>1?(e[h]=e[h]||[],e[h].push({}),c.jsonParent=e[h][e[h].length-1]):(e[h]=e[h]||{},c.jsonParent=e[h]),a.push(c);else if(c.nodeType===3&&c.nodeValue.replace(m,"")!=="")e.$=e.$||"",e.$+=c.nodeValue}return g},isTextNode:function(d){for(var d=d.childNodes,g=0,a=d.length;g<a;g++)if(d[g].nodeType!==3||d[g].childNodes.length)return!1;return!0},parseNumeric:function(d){var g=null,a,g=d.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g,
" ");if(g==="")return g;if((g.indexOf(" ")!==-1||g.indexOf(",")!==-1)&&/[0-9\.,e\-\+ ]+/g.test(g))if(/[^0-9\-\+]+/g.test(g))if(/[^0-9\- ]+/g.test(g))if(/[^0-9\-,]+/g.test(g))if(/[^0-9\.e\-\+ ]+/g.test(g))if(/[^0-9\.,e\+\-]+/g.test(g))if(/[^0-9,\-\+ ]+/g.test(g)){if(!/[^0-9\.,e\-\+ ]+/g.test(g)){g=g.split(" ");d=0;for(a=g.length;d<a;d++)g[d]=q.floatDelimArray(g[d],",");return g}}else{g=g.split(" ");d=0;for(a=g.length;d<a;d++)g[d]=q.intDelimArray(g[d],",");return g}else return q.floatDelimArray(g,",");
else return q.floatDelimArray(g," ");else return q.intDelimArray(g,",");else return q.intDelimArray(g," ");else return parseInt(g,10);a=parseFloat(g);if(!isNaN(a))return/[^0-9\-\+]+/g.test(g)?a:parseInt(g,10);return d},xml2json:function(d){var g={},a=[],b,f,e,c,h;d.jsonParent=g;for(a.push(d);a.length;){f=a.pop();var m=null;e=f.jsonParent;d=0;for(b=f.childNodes.length;d<b;d++)c=f.childNodes[d],h=c.tagName,h!==z&&(m=m||{},m[h]=m[h]||0,m[h]++);d=0;for(b=f.childNodes.length;d<b;d++){c=f.childNodes[d];
h=c.tagName;var o=q.isTextNode(c);if(c.nodeType===1)m[h]>1?(e[h]=e[h]||[],o?e[h].push(q.parseNumeric(q.collectTextNode(c))):(e[h].push({}),c.jsonParent=e[h][e[h].length-1])):o?e[h]=q.parseNumeric(q.collectTextNode(c)):(e[h]=e[h]||{},c.jsonParent=e[h]),o||a.push(c)}}return g}};return{util:q,get:q.get,clearCache:q.clearCache}});
CubicVR.RegisterModule("COLLADA",function(u){function z(g,a){function b(a){if(!a.color)return!1;return(a=a.color)?e.floatDelimArray(a.$," "):!1}function f(a){var I;if(!a["float"])return!1;return I=(a=a["float"])?parseFloat(a.$):0,a=I}var e=CubicVR.util;new CubicVR.Mesh;new CubicVR.Scene;var c,h,m,o,y;y=typeof g=="object"?g:g.indexOf(".js")!=-1?e.getJSON(g):CubicVR.util.xml2badgerfish(e.getXML(g));var x,A,w,C,n,H,v,t,K,D,B,u=y;y=null;if(!u.COLLADA)throw Error(g+" does not appear to be a valid COLLADA file.");
u=u.COLLADA;y={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(u.asset){var z=u.asset.up_axis.$;if(z==="X_UP")y.up_axis=0;else if(z==="Y_UP")y.up_axis=1;else if(z==="Z_UP")y.up_axis=2}z=y.up_axis;if(u.library_images){if(u.library_images.image&&!u.library_images.image.length)u.library_images.image=[u.library_images.image];if(u.library_images.image.length){h=u.library_images.image;c=0;for(t=h.length;c<t;c++){var F=h[c],E=F["@id"];C=F["@name"];F=
F.init_from;if(F.$)F=F.$,a!==s&&F.lastIndexOf("/")!==-1&&(F=F.substr(F.lastIndexOf("/")+1)),a!==s&&F.lastIndexOf("\\")!==-1&&(F=F.substr(F.lastIndexOf("\\")+1)),y.images[E]={source:F,id:E,name:C}}}}var G,N,J,S,V;if(u.library_effects){var L=u.library_effects.effect;L&&!L.length&&(L=[L]);F=0;for(G=L.length;F<G;F++){t=L[F];C=t["@id"];o={};o.id=C;o.surfaces=[];o.samplers=[];(E=t.profile_COMMON.newparam)&&!E.length&&(E=[E]);if(E){h=0;for(c=E.length;h<c;h++){var P=E[h],M=P["@sid"];if(P.surface){if(o.surfaces[M]=
{},P=P.surface.init_from.$,typeof y.images[P]==="object")o.surfaces[M].source=a+"/"+y.images[P].source}else if(P.sampler2D){o.samplers[M]={};o.samplers[M].source=P.sampler2D.source.$;if(P.sampler2D.minfilter)o.samplers[M].minfilter=P.sampler2D.minfilter.$;if(P.sampler2D.magfilter)o.samplers[M].magfiter=P.sampler2D.magfilter.$}}}(h=t.profile_COMMON.technique)&&!h.length&&(h=[h]);o.material={textures_ref:[]};t=0;for(E=h.length;t<E;t++){c=h[t].blinn;if(!c)c=h[t].phong;if(!c)c=h[t].lambert;if(c)for(v in c){var R=
c[v],M=b(R),P=f(R);R=R.texture?R.texture["@texture"]:!1;M!==!1&&M.length>3&&M.pop();if(v=="emission"){if(M!==!1)o.material.ambient=M}else if(v!="ambient")if(v=="diffuse"){if(M!==!1)o.material.color=M}else if(v=="specular"){if(M!==!1)o.material.specular=M}else if(v=="shininess"&&P!==!1)o.material.shininess=P;if(R!==!1)M=o.surfaces[o.samplers[R].source].source,v=="emission"?o.material.textures_ref.push({image:M,type:r.texture.map.AMBIENT}):v=="ambient"?o.material.textures_ref.push({image:M,type:r.texture.map.AMBIENT}):
v=="diffuse"?o.material.textures_ref.push({image:M,type:r.texture.map.COLOR}):v=="specular"?o.material.textures_ref.push({image:M,type:r.texture.map.SPECULAR}):v!="shininess"&&(v=="reflective"?o.material.textures_ref.push({image:M,type:r.texture.map.REFLECT}):v!="reflectivity"&&v=="transparent"&&o.material.textures_ref.push({image:M,type:r.texture.map.ALPHA}))}y.effects[C]=o}}}t=d.getAllOf(u,"instance_geometry");v=[];if(t.length){c=0;for(h=t.length;c<h;c++)if(E=t[c],C=d.getAllOf(E,"instance_material"),
C.length){B=0;for(H=C.length;B<H;B++)G=C[B],F=G["@symbol"],G=G["@target"].substr(1),v[E["@url"].substr(1)+":"+F]=G}}if((h=u.library_materials)&&h.material){(t=h.material)&&!t.length&&(t=[t]);h=0;for(c=t.length;h<c;h++)if(C=t[h],E=C["@id"],F=C["@name"],C=C.instance_effect)C=C["@url"].substr(1),y.materials.push({id:E,name:F,mat:y.effects[C].material})}h=u.library_geometries;var X;if(h&&((C=h.geometry)&&!C.length&&(C=[C]),C.length)){F=0;for(G=C.length;F<G;F++){var L={id:s,points:[],parts:[]},Z=C[F].mesh;
if(Z){X=C[F]["@id"];o=C[F]["@name"];(c=Z.source)&&!c.length&&(c=[c]);o=[];t=0;for(E=c.length;t<E;t++)if(M=c[t],h=M["@id"],P=M["@name"],(R=M.float_array)&&(o[h]={id:h,name:P,data:e.floatDelimArray(R.$?R.$:""," ")}),M=M.technique_common.accessor)if(o[h].count=M["@count"]|0,o[h].stride=M["@stride"]|0,o[h].count)o[h].data=e.repackArray(o[h].data,o[h].stride,o[h].count);h=Z.vertices;var Q=R=P=M=null,$=null;if(h&&(P=h["@id"],(c=h.input)&&!c.length&&(c=[c]),c)){w=0;for(N=c.length;w<N;w++)J=c[w],J["@semantic"]===
"POSITION"&&(M=J["@source"].substr(1))}var T=Z.triangles;T&&!T.length&&(T=[T]);if(T){t=0;for(E=T.length;t<E;t++){V={material:0,faces:[],normals:[],texcoords:[],colors:[]};h=parseInt(T[t]["@count"],10);(c=T[t].input)&&!c.length&&(c=[c]);S=[];if(c.length){w=0;for(N=c.length;w<N;w++)J=c[w],n=parseInt(J["@offset"],10),m=J["@source"].substr(1),J["@semantic"]==="VERTEX"?(m===P&&(m=M),S[n]=0):J["@semantic"]==="NORMAL"?(R=m,o[R].count&&(S[n]=1)):J["@semantic"]==="TEXCOORD"?($=m,o[$].count&&(S[n]=2)):J["@semantic"]===
"COLOR"?(Q=m,o[Q].count&&(S[n]=3)):S[n]=4}w=S.length;c=X+":"+T[t]["@material"];c===null?V.material=0:v[c]===s?(q("missing material ["+c+"]@"+X+"?"),V.material=0):V.material=v[c];c=T[t].p;w=[];c&&(w=e.intDelimArray(c.$," "));if(w.length&&(c=w.length/S.length/3,c===h)){if(L.points.length===0)L.points=o[M].data;c=n=0;h=w.length;for(n=S.length;c<h;c+=n*3){x=[];A=[];m=[];J=[];for(B=0;B<n*3;B++)N=B%n,S[N]===0?A.push(w[c+B]):S[N]===1?x.push(w[c+B]):S[N]===2?m.push(w[c+B]):S[N]===3&&J.push(w[c+B]);A.length&&
(V.faces.push(A),x.length===3&&V.normals.push([d.fixuaxis(y.up_axis,o[R].data[x[0]]),d.fixuaxis(y.up_axis,o[R].data[x[1]]),d.fixuaxis(y.up_axis,o[R].data[x[2]])]),m.length===3&&V.texcoords.push([o[$].data[m[0]],o[$].data[m[1]],o[$].data[m[2]]]),J.length===3&&V.colors.push([o[Q].data[J[0]],o[Q].data[J[1]],o[Q].data[J[2]]]))}}L.parts.push(V)}}T=Z.polylist;if(!T)T=Z.polygons;T&&!T.length&&(T=[T]);if(T){t=0;for(E=T.length;t<E;t++){V={material:0,faces:[],normals:[],texcoords:[],colors:[]};B=parseInt(T[t]["@count"],
10);(c=T[t].input)&&!c.length&&(c=[c]);S=[];if(c.length){w=0;for(N=c.length;w<N;w++)J=c[w],h=J["@offset"],h===null&&(h=J["@idx"]),n=parseInt(h,10),m=J["@source"].substr(1),J["@semantic"]==="VERTEX"?(m===P&&(m=M),S[n]=0):J["@semantic"]==="NORMAL"?(R=m,S[n]=1):J["@semantic"]==="TEXCOORD"?($=m,S[n]=2):J["@semantic"]==="COLOR"?(Q=m,S[n]=3):S[n]=4}h=T[t].vcount;Z=[];h&&(Z=e.intDelimArray(h.$," "));c=X+":"+T[t]["@material"];V.material=c===s?0:v[c];J=T[t].p;w=S.length;N=[];if(J.length>1&&!Z.length){h=0;
for(c=J.length;h<c;h++)n=e.intDelimArray(J[h].$," "),Z[h]=parseInt(n.length/w,10),N.splice(N.length,0,n)}else J&&(N=e.intDelimArray(J.$," "));if(N.length)if(c=Z.length,c!==B)q("poly vcount data doesn't add up, skipping object load: "+c+" !== "+B);else{if(L.points.length===0)L.points=o[M].data;c=n=0;for(h=Z.length;c<h;c++){x=[];A=[];m=[];J=[];B=0;for(H=Z[c]*w;B<H;B++)S[B%w]===0?A.push(N[n]):S[B%w]===1?x.push(N[n]):S[B%w]===2?m.push(N[n]):S[B%w]===3&&J.push(N[n]),n++;if(A.length){V.faces.push(A);if(x.length){B=
[];H=0;for(A=x.length;H<A;H++)B.push(d.fixuaxis(y.up_axis,o[R].data[x[H]]));V.normals.push(B)}if(m.length){B=[];H=0;for(A=m.length;H<A;H++)B.push(o[$].data[m[H]]);V.texcoords.push(B)}if(J.length){B=[];H=0;for(A=J.length;H<A;H++)B.push(o[Q].data[J[H]]);V.colors.push(B)}}}}L.parts.push(V)}}if(z!==1){c=0;for(h=L.points.length;c<h;c++)L.points[c]=d.fixuaxis(y.up_axis,L.points[c])}L.id=X;y.meshes.push(L)}}}if(h=u.library_cameras){(C=h.camera)&&!C.length&&(C=[C]);v=0;for(t=C.length;v<t;v++){h=C[v];F=h["@id"];
G=E=c=0;if(h.optics&&h.optics.technique_common&&h.optics.technique_common.perspective)c=h.optics.technique_common.perspective.yfov,E=h.optics.technique_common.perspective.znear,G=h.optics.technique_common.perspective.zfar;var U;if(!c&&!E&&!G){(E=h.param)&&!E.length&&(E=[E]);c=0;for(h=E.length;c<h;c++)G=E[c].$,L=E[c]["@name"],L=="YFOV"?U=parseFloat(G):L=="ZNEAR"?K=parseFloat(G):L=="ZFAR"&&(D=parseFloat(G))}else U=c?parseFloat(c.$):60,K=E?parseFloat(E.$):0.1,D=G?parseFloat(G.$):1E3;y.cameras.push({id:F,
targeted:!1,fov:parseFloat(U),nearclip:parseFloat(K),farclip:parseFloat(D)})}}if(U=u.library_lights)if((U=U.light)&&!U.length&&(U=[U]),U){K=0;for(D=U.length;K<D;K++)if(c=U[K],v=(h=c.technique_common.point)?h:null,h=c["@id"],v!==null)c=(c=v.intensity)?parseFloat(c.$):1,t=(t=v.distance)?parseFloat(t.$):10,v=v.color,J=[1,1,1],v&&(J=e.floatDelimArray(v.$," ")),y.lights.push({id:h,name:h,type:r.light.type.POINT,method:r.light.method.STATIC,diffuse:J,specular:[0,0,0],distance:t,intensity:c})}if(K=u.library_visual_scenes){U=
null;(U=K.visual_scene)&&!U.length&&(U=[U]);K=0;for(D=U.length;K<D;K++){C=U[K];v={id:C["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};t=[];var E=[],W;if(h=u.library_nodes){(G=h.node)&&!G.length&&(G=[G]);t=[];c=0;for(h=G.length;c<h;c++)F=G[c],mnodeId=F["@id"],t[W]=F;for(F=[C];F.length;){G=F.pop();if(G.node&&((B=G.node)&&!B.length&&(B=[B]),B)){c=0;for(h=B.length;c<h;c++)F.push(B[c])}if(G.instance_node){(L=G.instance_node)&&!L.length&&(L=[L]);c=0;for(h=L.length;c<h;c++)if(o=L[c]["@url"].substr(1),
t[o]){if(G.node&&G.node.length)G.node=[G.node];G.node?G.node.push(t[o]):G.node=[t[o]]}}}}for(F=[C];F.length;)if(G=F.pop(),G.node&&((B=G.node)&&!B.length&&(B=[B]),B)){c=0;for(h=B.length;c<h;c++)B[c].parentNode=G,E.push(B[c]),F.push(B[c])}if(E.length){C=0;for(F=E.length;C<F;C++){M=E[C];P=M.instance_geometry;c=E[C].instance_light;h=E[C].instance_camera;W=M["@id"];G=M["@name"];L=d.cl_getInitalTransform(y.up_axis,M);if(z===2)L.rotation=d.quaternionFilterZYYZ(L.rotation,h?[-90,0,0]:s);Q=R=null;if(P){P&&
!P.length&&(P=[P]);c=0;for(h=P.length;c<h;c++){o=P[c]["@url"].substr(1);Q={};Q.name=(G?G:W)+(c?c:"");Q.id=(W?W:G)+(c?c:"");Q.meshId=X;Q.meshName=o;if(!R)Q.position=L.position,Q.rotation=L.rotation,Q.scale=L.scale,Q.matrix=L.matrix;v.sceneObjects.push(Q);t[Q.id]=!0;M.parentNode&&((o=M.parentNode["@id"])&&t[o]?v.parentMap.push({parent:o,child:Q.id}):P.length>1&&(R?t[R.id]&&v.parentMap.push({parent:R.id,child:Q.id}):(R=Q,Q={})))}}else h?(h=h["@url"].substr(1),v.cameras.push({name:G?G:W,id:G?G:W,source:h,
position:L.position,rotation:L.rotation})):c?(h=c["@url"].substr(1),v.lights.push({name:G?G:W,id:G?G:W,source:h,position:L.position})):(Q={position:L.position,rotation:L.rotation,scale:L.scale,matrix:L.matrix},Q.name=G?G:W,Q.id=W?W:G,v.sceneObjects.push(Q),t[Q.id]=!0,M.parentNode&&(o=M.parentNode["@id"])&&t[o]&&v.parentMap.push({parent:o,child:Q.id}))}}y.scenes.push(v)}}if(X=u.library_animations)if((W=X.animation)&&!W.length&&(W=[W]),W){z=0;for(U=W.length;z<U;z++){v=W[z];X=v["@id"];y.animations[X]=
{};y.animations[X].sources=[];(t=v.source)&&!t.length&&(t=[t]);if(t.length){K=0;for(D=t.length;K<D;K++){c=t[K];h=c["@id"];L=c.technique_common;C=E=null;c.name_array?E=e.textDelimArray(c.name_array.$," "):c.Name_array?E=e.textDelimArray(c.Name_array.$," "):c.float_array&&(C=e.floatDelimArray(c.float_array.$," "));c=0;G="";F=1;if(L)c=L,L=c.accessor,c=parseInt(L["@count"],10),G=L["@source"].substr(1),(L=L["@stride"])&&(F=parseInt(L,10));y.animations[X].sources[h]={data:E?E:C,count:c,source:G,stride:F};
if(F!==1)y.animations[X].sources[h].data=e.repackArray(y.animations[X].sources[h].data,F,c)}}(t=v.sampler)&&!t.length&&(t=[t]);if(t){y.animations[X].samplers=[];K=0;for(D=t.length;K<D;K++)if(h=t[K],E=h["@id"],(c=h.input)&&!c.length&&(c=[c]),c){F=[];C=0;for(h=c.length;C<h;C++)J=c[C],F[J["@semantic"]]=J["@source"].substr(1);y.animations[X].samplers[E]=F}}(K=v.channel)&&!K.length&&(K=[K]);if(K){y.animations[X].channels=[];v=0;for(t=K.length;v<t;v++)h=K[v],D=h["@source"].substr(1),h=h["@target"],E=h.split("/"),
c=E[0],E=E[1].split("."),y.animations[X].channels.push({source:D,target:h,targetName:c,paramName:E[0],typeName:E[1]})}}}if(u=u.scene)if(C=u.instance_visual_scene)u=C["@url"].substr(1),y.scene=u;return y}var s=u.undef,r=CubicVR.enums,n=u.GLCore,q=u.log,d={fixuaxis:function(d,a){if(d===0)return[a[1],a[0],a[2]];else if(d===1)return a;else if(d===2)return[a[0],a[2],-a[1]]},fixscaleaxis:function(d,a){if(d===0)return[a[1],a[0],a[2]];else if(d===1)return a;else if(d===2)return[a[0],a[2],a[1]]},fixukaxis:function(d,
a,b,f){if(a===r.motion.POS&&b===r.motion.Z&&d===r.motion.Z)return-f;return f},getAllOf:function(d,a){for(var b=[d],f=[],e,c,h,m;b.length;)for(c in e=b.pop(),e)if(e.hasOwnProperty(c)){if(c===a)if(e[c].length){h=0;for(m=e[c].length;h<m;h++)f.push(e[c][h])}else f.push(e[c]);if(typeof e[c]=="object")if(e[c].length){h=0;for(m=e[c].length;h<m;h++)b.push(e[c][h])}else b.push(e[c])}return f},quaternionFilterZYYZ:function(d,a){var b=CubicVR.vec3,f=d,e=new CubicVR.Quaternion;a!==s&&(f=b.add(d,a));e.fromEuler(f[0],
f[2],-f[1]);return e.toEuler()},cl_getInitalTransform:function(g,a){var b=CubicVR.util,f={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e=a.translate,c=a.rotate,h=a.scale;if(a.matrix&&!e&&!c&&!h)return f;if(e)f.position=d.fixuaxis(g,b.floatDelimArray(e.$," "));if(c)for(var e=0,m=c.length;e<m;e++){var o=c[e],y=o["@sid"],o=b.floatDelimArray(o.$," ");if(y=="rotateX"||y=="rotationX")f.rotation[0]=o[3];else if(y=="rotateY"||y=="rotationY")f.rotation[1]=o[3];else if(y=="rotateZ"||y=="rotationZ")f.rotation[2]=
o[3]}if(h)f.scale=d.fixscaleaxis(g,b.floatDelimArray(h.$," "));return f}};return{loadCollada:function(g,a,b){var a=z(g,a,b),f=a.up_axis,e=[],c,h,m,o,y,x,A,w;h=0;for(m=a.materials.length;h<m;h++){y=a.materials[h];A=new CubicVR.Material(y.mat);x=0;for(o=y.mat.textures_ref.length;x<o;x++){w=y.mat.textures_ref[x];var C=null,C=u.Textures_ref[w.image]===void 0?new CubicVR.Texture(w.image,n.default_filter,b,g):u.Textures_obj[u.Textures_ref[w.image]];A.setTexture(C,w.type)}e[y.id]=A}x=[];h=0;for(m=a.meshes.length;h<
m;h++){var C=a.meshes[h],q=new CubicVR.Mesh({name:C.id});q.points=C.points;var H=!1;A=0;for(w=C.parts.length;A<w;A++){var v=C.parts[A];v.material!==0&&((o=e[v.material])||(o=new CubicVR.Material({name:v.material})),q.setFaceMaterial(o));var t=v.normals.length?!0:!1,K=v.texcoords.length?!0:!1,D=v.colors.length?!0:!1;if(D)e[v.material].color_map=!0;o=0;for(y=v.faces.length;o<y;o++){var B=q.addFace(v.faces[o]);if(t)q.faces[B].point_normals=v.normals[o];if(K)q.faces[B].uvs=v.texcoords[o];if(D)q.faces[B].point_colors=
v.colors[o]}H|=t}q.faces.length&&(b?b.addMesh(g,g+":"+meshId,q):(H||q.calcNormals(),q.triangulateQuads(),q.compile()),x[C.id]=q)}m=[];g=0;for(o=a.cameras.length;g<o;g++)m[a.cameras[g].id]=a.cameras[g];C=[];o=0;for(y=a.lights.length;o<y;o++)C[a.lights[o].id]=a.lights[o];b={};e={};h={};g={};A=0;for(w=a.scenes.length;A<w;A++){q=a.scenes[A];H=new CubicVR.Scene;o=0;for(y=q.sceneObjects.length;o<y;o++)v=q.sceneObjects[o],t=new CubicVR.SceneObject(v),t.obj=(x[v.meshName]?x[v.meshName]:x[v.meshId])||null,
v.matrix&&t.setMatrix(v.matrix),b[v.id]=t,H.bindSceneObject(t);o=0;for(y=q.lights.length;o<y;o++)v=q.lights[o],t=new CubicVR.Light(C[v.source]),t.position=v.position,e[v.id]=t,H.bindLight(t);if(q.cameras.length)o=q.cameras[0],y=new CubicVR.Camera(m[o.source]),y.position=o.position,y.rotation=o.rotation,h[o.id]=y,H.camera=y;o=0;for(y=q.parentMap.length;o<y;o++)v=q.parentMap[o],b[v.parent].bindChild(b[v.child]);g[q.id]=H}for(var Y in a.animations)if(a.animations.hasOwnProperty(Y)&&(x=a.animations[Y],
x.channels.length)){cCount=0;for(o=x.channels.length;cCount<o;cCount++){m=x.channels[cCount];v=x.samplers[m.source];y=x.sources[v.INPUT];A=x.sources[v.OUTPUT];w=x.sources[v.INTERPOLATION];var C=x.sources[v.IN_TANGENT],q=x.sources[v.OUT_TANGENT],H=v.IN_TANGENT!==s,v=v.OUT_TANGENT!==s,t=null,D=b[m.targetName],K=h[m.targetName],I=e[m.targetName];if(D){if(D.motion===null)D.motion=new CubicVR.Motion;t=D.motion}else if(K){if(K.motion===null)K.motion=new CubicVR.Motion;t=K.motion}else if(I){if(I.motion===
null)I.motion=new CubicVR.Motion;t=I.motion}if(t!==null){D=r.motion.POS;B=r.motion.X;if(f===2)t.yzflip=!0;c=m.paramName;if(c==="rotateX"||c==="rotationX")D=r.motion.ROT,B=r.motion.X;else if(c==="rotateY"||c==="rotationY")D=r.motion.ROT,B=r.motion.Y;else if(c==="rotateZ"||c==="rotationZ")D=r.motion.ROT,B=r.motion.Z;else if(c==="location"){D=r.motion.POS;if(m.typeName==="X")B=r.motion.X;if(m.typeName==="Y")B=r.motion.Y;if(m.typeName==="Z")B=r.motion.Z}else if(c==="translate"){D=r.motion.POS;if(m.typeName===
"X")B=r.motion.X;if(m.typeName==="Y")B=r.motion.Y;if(m.typeName==="Z")B=r.motion.Z}else if(c==="LENS")continue;else if(c==="FOV")D=r.motion.FOV,B=3;else if(c==="ZNEAR")D=r.motion.NEARCLIP,B=3;else if(c==="ZFAR")D=r.motion.FARCLIP,B=3;else if(c==="intensity")D=r.motion.INTENSITY,B=3;if(I&&D<3)I.method=r.light.method.DYNAMIC;mCount=0;for(m=y.data.length;mCount<m;mCount++)if(k=null,typeof A.data[mCount]==="object"){i=0;for(iMax=A.data[mCount].length;i<iMax;i++)if(I=i,f===2&&i===2?I=1:f===2&&i===1&&(I=
2),k=t.setKey(D,I,y.data[mCount],d.fixukaxis(a.up_axis,D,I,A.data[mCount][i])),w)if(c=w.data[mCount][i],c==="LINEAR")k.shape=r.envelope.shape.LINE;else if(c==="BEZIER")k.shape=!H&&!v?r.envelope.shape.LINEAR:r.envelope.shape.BEZI}else if(I=B,ofs=0,K&&D===r.motion.ROT&&f===2&&I===0&&(ofs=-90),D===r.motion.ROT?k=t.setKey(D,I,y.data[mCount],A.data[mCount]+ofs):(f===2&&B===2?I=1:f===2&&B===1&&(I=2),k=t.setKey(D,I,y.data[mCount],d.fixukaxis(a.up_axis,D,I,A.data[mCount]))),w)if(c=w.data[mCount],c==="LINEAR")k.shape=
r.envelope.shape.LINE;else if(c==="BEZIER")if(!H&&!v)k.shape=r.envelope.shape.LINEAR,k.continutity=1;else{k.shape=r.envelope.shape.BEZ2;c=C.data[mCount][0];var F,E=q.data[mCount][0];D===r.motion.ROT?(F=C.data[mCount][1],I=q.data[mCount][1],k.param[0]=c-k.time,k.param[1]=F-k.value+ofs,k.param[2]=E-k.time,k.param[3]=I-k.value+ofs):(F=d.fixukaxis(a.up_axis,D,I,C.data[mCount][1]),I=d.fixukaxis(a.up_axis,D,I,q.data[mCount][1]),k.param[0]=c-k.time,k.param[1]=F-k.value,k.param[2]=E-k.time,k.param[3]=I-k.value)}}}}Y=
null;return Y=a.scene?g[a.scene]:g.pop()},parseCollada:z}});
CubicVR.RegisterModule("CVRXML",function(u){function z(a,e,c,h){var m=CubicVR.util,o=null,d=null;h.triangles&&(d=m.intDelimArray(b.getTextNode(h,"triangles")," "));if(d&&(h.segments&&(o=m.intDelimArray(b.getTextNode(h,"segments")," ")),o===null&&(o=[0,parseInt(d.length/3,10)]),h=0,a.setFaceMaterial(e),d.length)){p=0;for(pMax=o.length;p<pMax;p+=2){e=o[p+1]*3;a.setSegment(o[p]);j=h;for(jMax=h+e;j<jMax;j+=3)m=a.addFace([d[j],d[j+1],d[j+2]]),c&&a.faces[m].setUV([c[j],c[j+1],c[j+2]]);h+=e}}}function s(a){var e=
CubicVR.util,c=new CubicVR.UVMapper,h=null,m=null;if(a.type)switch(h=b.getTextNode(a,"type"),h){case "planar":c.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":c.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":c.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":c.projection_mode=g.uv.projection.CUBIC}if(!h)return null;h==="uv"&&a.uv&&(m=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":c.projection_axis=g.uv.axis.X;break;case "y":c.projection_axis=
g.uv.axis.Y;break;case "z":c.projection_axis=g.uv.axis.Z}if(a.center)c.center=e.floatDelimArray(b.getTextNode(a,"center"));if(a.rotation)c.rotation=e.floatDelimArray(b.getTextNode(a,"rotation"));if(a.scale)c.scale=e.floatDelimArray(b.getTextNode(a,"scale"));if(a.wrap_w)c.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w"));if(a.wrap_h)c.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h"));return h!==""&&h!=="uv"?c:m}function r(f,e){if(a[f]!==d)return a[f];var c=CubicVR.util,h,m,o,y;h=null;h=typeof f==
"object"?f:f.indexOf(".js")!=-1?c.getJSON(f):CubicVR.util.xml2badgerfish(c.getXML(f));if(h.root)h=h.root;if(h.properties)h=h.properties;c=new CubicVR.Mesh;h.points&&(o=b.getPoints(h,"points"))&&c.addPoint(o);var x=h.material;x&&!x.length&&(x=[x]);var A=[];if(x){h=0;for(o=x.length;h<o;h++){var w=x[h],C;C=w;var n=e,q=new CubicVR.Material({name:C.name?C.name.$:null});if(C.shininess)q.shininess=b.getFloatNode(C,"shininess",q.shininess)/100;q.opacity=b.getFloatNode(C,"alpha",q.opacity);q.max_smooth=b.getFloatNode(C,
"max_smooth",q.max_smooth);q.color=b.getFloatDelimNode(C,"color",q.color);q.ambient=b.getFloatDelimNode(C,"ambient",q.ambient);q.diffuse=b.getFloatDelimNode(C,"diffuse",q.diffuse);q.specular=b.getFloatDelimNode(C,"specular",q.specular);m=void 0;if(m=b.getTextNode(C,"texture"))m=(n?n:"")+m,tex=u.Textures_ref[m]!==d?u.Textures_obj[u.Textures_ref[m]]:new CubicVR.Texture(m),q.setTexture(tex,g.texture.map.COLOR);if(m=b.getTextNode(C,"texture_luminosity"))m=(n?n:"")+m,tex=u.Textures_ref[m]!==d?u.Textures_obj[u.Textures_ref[m]]:
new CubicVR.Texture(m),q.setTexture(tex,g.texture.map.AMBIENT);if(m=b.getTextNode(C,"texture_normal"))m=(n?n:"")+m,tex=u.Textures_ref[m]!==d?u.Textures_obj[u.Textures_ref[m]]:new CubicVR.Texture(m),q.setTexture(tex,g.texture.map.NORMAL);if(m=b.getTextNode(C,"texture_specular"))m=(n?n:"")+m,tex=u.Textures_ref[m]!==d?u.Textures_obj[u.Textures_ref[m]]:new CubicVR.Texture(m),q.setTexture(tex,g.texture.map.SPECULAR);if(m=b.getTextNode(C,"texture_bump"))m=(n?n:"")+m,tex=u.Textures_ref[m]!==d?u.Textures_obj[u.Textures_ref[m]]:
new CubicVR.Texture(m),q.setTexture(tex,g.texture.map.BUMP);if(m=b.getTextNode(C,"texture_envsphere"))m=(n?n:"")+m,tex=u.Textures_ref[m]!==d?u.Textures_obj[u.Textures_ref[m]]:new CubicVR.Texture(m),q.setTexture(tex,g.texture.map.ENVSPHERE);if(m=b.getTextNode(C,"texture_alpha"))m=(n?n:"")+m,tex=u.Textures_ref[m]!==d?u.Textures_obj[u.Textures_ref[m]]:new CubicVR.Texture(m),q.setTexture(tex,g.texture.map.ALPHA);C=q;var v=null;m=n=null;w.uvmapper&&((n=s(w.uvmapper))&&!n.length?A.push([n,C]):m=n);(q=w.part)&&
!q.length&&(q=[q]);if(q&&q.length){var t=null,r=null;m=0;for(y=q.length;m<y;m++){var D=q[m],t=null;if(v=D.uvmapper)if(t=s(v),w.triangles)r=v=c.faces.length,t&&!t.length?(z(c,C,null,D),r=c.faces.length-1,c.calcFaceNormals(v,r),t.apply(c,C,d,v,r)):t&&t.length?z(c,C,t,D):n&&!n.length&&(z(c,C,null,D),r=c.faces.length-1,c.calcFaceNormals(v,r),n.apply(c,C,d,v,r));if(D.procedural){(v=D.uvmapper)&&(t=s(v));var r=D.transform?b.getTransform(D.transform):d,v=d,D=D.procedural,B=b.getTextNode(D,"type");r&&(v=
new CubicVR.Transform,v.translate(r.position),v.pushMatrix(),v.rotate(r.rotation),v.pushMatrix(),v.scale(r.scale));n||(n=d);t={material:C,uvmapper:n||t};if(B==="box"||B==="cube")t.size=b.getFloatNode(D,"size"),c.booleanAdd(CubicVR.primitives.box(t),v);else if(B==="sphere")t.radius=b.getFloatNode(D,"radius"),t.lat=b.getIntNode(D,"lat"),t.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.sphere(t),v);else if(B==="cone")t.base=b.getFloatNode(D,"base"),t.height=b.getFloatNode(D,"height"),t.lon=
b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.cone(t),v);else if(B==="plane")t.size=b.getFloatNode(D,"size"),c.booleanAdd(CubicVR.primitives.plane(t),v);else if(B==="cylinder")t.radius=b.getFloatNode(D,"radius"),t.height=b.getFloatNode(D,"height"),t.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.cylinder(t),v);else if(B==="torus")t.innerRadius=b.getFloatNode(D,"innerRadius"),t.outerRadius=b.getFloatNode(D,"outerRadius"),t.lat=b.getIntNode(D,"lat"),t.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.torus(t),
v);else if(B==="lathe")t.points=b.getPoints(D,"p"),t.lon=b.getIntNode(D,"lon"),c.booleanAdd(CubicVR.primitives.lathe(t),v);else if(B==="polygon"){r=b.getPoints(D,"p");r=new CubicVR.Polygon(r);(B=D.cut)&&!B.length&&(B=[B]);if(B.length){m=0;for(o=B.length;m<y;m++)r.cut(new CubicVR.Polygon(b.getPoints(B[m])))}t.front=0;t.back=0;t.frontShift=0;t.backShift=0;t.frontDepth=0;t.backDepth=0;if(D.extrude){D=D.extrude;t.front=b.getFloatNode(D,"front",0);t.back=b.getFloatNode(D,"back",0);t.frontShift=b.getFloatNode(D,
"frontBevelShift",0);t.backShift=b.getFloatNode(D,"backBevelShift",0);t.frontDepth=b.getFloatNode(D,"frontBevelDepth",0);t.backDepth=b.getFloatNode(D,"backBevelDepth",0);t.depth=b.getFloatNode(D,"depth",0);t.shift=b.getFloatNode(D,"shift",0);t.bevel=b.getFloatNode(D,"bevel",0);if(t.depth&&!t.backDepth&&!t.frontDepth)t.front=-t.depth/2,t.back=t.depth/2;if(t.shift&&!t.backShift&&!t.frontShift)t.frontShift=t.shift,t.backShift=t.shift;if(t.bevel&&!t.backDepth&&!t.frontDepth)t.frontDepth=t.bevel,t.backDepth=
t.bevel}D=r.toExtrudedBeveledMesh(new CubicVR.Mesh,t);D.setFaceMaterial(t.material);c.booleanAdd(D,v)}}}}else z(c,C,m,w)}}c.triangulateQuads();c.calcNormals();h=0;for(o=A.length;h<o;h++)A[h][0].apply(c,A[h][1]);c.compile();return a[f]=c}function n(a){if(a===null)return!1;return a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function q(a,b,c){var h=CubicVR.util,m=[];m[0]=a.getElementsByTagName("x");m[1]=
a.getElementsByTagName("y");m[2]=a.getElementsByTagName("z");m[3]=a.getElementsByTagName("fov");var o,y,x,A,w,n;for(n in m)if(m.hasOwnProperty(n)&&m[n]!==d&&m[n].length){o=m[n][0].getElementsByTagName("time");y=m[n][0].getElementsByTagName("value");x=m[n][0].getElementsByTagName("in");A=m[n][0].getElementsByTagName("out");w=m[n][0].getElementsByTagName("tcb");var q=null,r=null,v=null,t=a=null;x.length&&(a=h.collectTextNode(x[0]));A.length&&(t=h.collectTextNode(A[0]));o.length&&(q=h.floatDelimArray(h.collectTextNode(o[0]),
" "));y.length&&(r=h.floatDelimArray(h.collectTextNode(y[0])," "));w.length&&(v=h.floatDelimArray(h.collectTextNode(w[0])," "));if(q!==null&&r!==null){o=0;for(y=q.length;o<y;o++)if(x=c.setKey(b,n,q[o],r[o]),v)x.tension=v[o*3],x.continuity=v[o*3+1],x.bias=v[o*3+2]}r=q=g.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":q=g.envelope.behavior.RESET;break;case "constant":q=g.envelope.behavior.CONSTANT;break;case "repeat":q=g.envelope.behavior.REPEAT;break;case "oscillate":q=g.envelope.behavior.OSCILLATE;
break;case "offset":q=g.envelope.behavior.OFFSET;break;case "linear":q=g.envelope.behavior.LINEAR}if(t)switch(t){case "reset":r=g.envelope.behavior.RESET;break;case "constant":r=g.envelope.behavior.CONSTANT;break;case "repeat":r=g.envelope.behavior.REPEAT;break;case "oscillate":r=g.envelope.behavior.OSCILLATE;break;case "offset":r=g.envelope.behavior.OFFSET;break;case "linear":r=g.envelope.behavior.LINEAR}c.setBehavior(b,n,q,r)}}var d=u.undef,g=CubicVR.enums,a=[],b={getPoints:function(a,e,c){a=e?
b.getTextNode(a,e):a.$;if(!a)return d;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);c&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var c={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},h;postition=a.position;h=a.rotation;a=a.scale;if(h)c.rotation=b.floatDelimArray(h.$);if(a)c.scale=b.floatDelimArray(a.$);if(h||a)return c;return null},getTextNode:function(a,b,c){a=a[b];
if(!a)return c;a.length&&(a=a[0]);if(a.$)return a.$;return c},getFloatNode:function(a,e,c){if(a=b.getTextNode(a,e)){a=parseFloat(a);if(a!=a)return c;return a}return c},getIntNode:function(a,e,c){if(a=b.getTextNode(a,e)){a=parseInt(a,10);if(a!=a)return c;return a}return c},getFloatDelimNode:function(a,e,c,h){var m=CubicVR.util;if(a=b.getTextNode(a,e))return m.floatDelimArray(a,h);return c},getIntDelimNode:function(a,e,c,h){var m=CubicVR.util;if(a=b.getTextNode(a,e))return m.intDelimArray(a,h);return c}};
return{loadMesh:r,loadScene:function(a,b,c){var h=CubicVR.util;b===d&&(b="");c===d&&(c="");for(var m=new CubicVR.Mesh,o=h.getXML(a),a=new CubicVR.Scene,y=[],x=o.getElementsByTagName("sceneobjects"),A,w,C,s=0,H=x[0].childNodes.length;s<H;s++){var v=x[0].childNodes[s];if(v.tagName==="sceneobject"){var t="unnamed",u="",D="",m=v.getElementsByTagName("name");m.length&&(t=h.collectTextNode(m[0]));m=v.getElementsByTagName("parent");m.length&&(u=h.collectTextNode(m[0]));m=v.getElementsByTagName("model");
m.length&&(D=h.collectTextNode(m[0]));C=w=A=null;m=v.getElementsByTagName("position");m.length&&(A=m[0]);m=v.getElementsByTagName("rotation");m.length&&(w=m[0]);m=v.getElementsByTagName("scale");m.length&&(C=m[0]);m=null;D!==""&&(m=r(b+D,c));m=new CubicVR.SceneObject(m,t);if(n(A)){if(!m.motion)m.motion=new CubicVR.Motion;q(A,g.motion.POS,m.motion)}else if(A)m.position=h.floatDelimArray(h.collectTextNode(A));if(n(w)){if(!m.motion)m.motion=new CubicVR.Motion;q(w,g.motion.ROT,m.motion)}else m.rotation=
h.floatDelimArray(h.collectTextNode(w));if(n(C)){if(!m.motion)m.motion=new CubicVR.Motion;q(C,g.motion.SCL,m.motion)}else m.scale=h.floatDelimArray(h.collectTextNode(C));a.bindSceneObject(m);u!==""&&y.push([m,u])}}for(var B in y)y.hasOwnProperty(B)&&a.getSceneObject(y[B][1]).bindChild(y[B][0]);b=o.getElementsByTagName("camera");if(b.length){w=A=null;c="";m=b[0].getElementsByTagName("name");B=a.camera;o=null;if(m.length)c=m[0].firstChild.nodeValue;m=b[0].getElementsByTagName("target");if(m.length)c=
m[0].firstChild.nodeValue;if(c!=="")B.targetSceneObject=a.getSceneObject(c);m=b[0].getElementsByTagName("position");m.length&&(A=m[0]);m=b[0].getElementsByTagName("rotation");m.length&&(w=m[0]);m=b[0].getElementsByTagName("fov");m.length&&(o=m[0]);if(n(A)){if(!B.motion)B.motion=new CubicVR.Motion;q(A,g.motion.POS,B.motion)}else if(A)B.position=h.floatDelimArray(A.firstChild.nodeValue);if(n(w)){if(!B.motion)B.motion=new CubicVR.Motion;q(w,g.motion.ROT,B.motion)}else if(w)B.rotation=h.floatDelimArray(w.firstChild.nodeValue);
if(n(o)){if(!B.motion)B.motion=new CubicVR.Motion;q(o,g.motion.FOV,B.motion)}else if(o)B.fov=parseFloat(o.firstChild.nodeValue)}return a}}});
CubicVR.RegisterModule("Camera",function(u){function z(a,b,f,e,c){var h=CubicVR.mat4;this.frustum=new CubicVR.Frustum;typeof a=="object"?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==n?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==n?a.calcNormalMatrix:!0,this.name=a.name||"camera"+g,b=a.height?a.height:
n,a=a.width?a.width:n):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=f!==n?f:60,this.nearclip=e!==n?e:0.1,this.farclip=c!==n?c:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+g);this.motion=this.targetSceneObject=null;this.transform=new CubicVR.Transform;this.manual=!1;this.setDimensions(a!==n?a:512,b!==n?b:512);this.mvMatrix=h.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++g}
function s(a){this.position=a!==n?a:[0,0,0]}function r(a,b,f){this.camPath=new CubicVR.Motion;this.targetPath=new CubicVR.Motion;this.start_position=a!==n?a:[8,8,8];this.target=b!==n?b:[0,0,0];this.bounds=f!==n?f:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var n=u.undef,q=CubicVR.enums,d=[1,0,0,0,0,
1,0,0,0,0,1,0,0,0,0,1],g=0;z.prototype={trackTarget:function(a,b,f){this.position=CubicVR.vec3.trackTarget(this.position,a,b,f)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return this.parent!==null&&this.mvMatrix&&this.parent.tMatrix?CubicVR.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(a,b,f,e){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=
b;this.ortho_view.bottom=f;this.ortho_view.top=e},control:function(a,b,f){a===q.motion.ROT?this.rotation[b]=f:a===q.motion.POS?this.position[b]=f:a===q.motion.FOV?this.setFOV(f):a===q.motion.LENS?this.setLENS(f):a===q.motion.NEARCLIP?this.setClip(f,this.farclip):a===q.motion.FARCLIP&&this.setClip(this.nearclip,f)},makeFrustum:function(a,b,f,e,c,h){return[2*c/(b-a),0,0,0,0,2*c/(e-f),0,0,(b+a)/(b-a),(e+f)/(e-f),-(h+c)/(h-c),-1,0,0,-2*h*c/(h-c),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=
CubicVR.mat4,b=CubicVR.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted&&this.mvMatrix)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),
a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()},resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},
setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,f,e,c,h,m,o,g){var x=CubicVR.mat4,A=CubicVR.mat3;if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=x.lookat(a,b,f,e,c,h,m,o,g);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.parent!==null&&x.multiply(this.mvMatrix.slice(0),
x.inverse(this.parent.tMatrix),this.mvMatrix);this.calc_nmatrix?(this.nMatrix=x.inverse_mat3(this.mvMatrix),A.transpose_inline(this.nMatrix)):this.nMatrix=d;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,b,f){var e=CubicVR.mat4,c=CubicVR.vec3,h=[0,0,this.width,this.height],a=e.vec4_multiply(e.vec4_multiply([(a-h[0])/h[2]*2-1,-((b-h[1])/h[3]*2-1),1,1],e.inverse(this.pMatrix)),e.inverse(this.mvMatrix)),a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];if(f!==n)return b=this.getParentedPosition(),
c.add(b,c.multiply(c.normalize(c.subtract(a,b)),f));return a},project:function(a,b,f){var e=CubicVR.mat4,e=e.vec4_multiply(e.vec4_multiply([a,b,f,1],this.mvMatrix),this.pMatrix);e[2]=CubicVR.vec3.length(CubicVR.vec3.subtract([a,b,f],this.position));return[(e[0]/e[3]+1)/2*this.width,(-e[1]/e[3]+1)/2*this.height,e[2]]}};s.prototype={control:function(a,b,f){a===q.motion.POS&&(this.position[b]=f)}};r.prototype={inBounds:function(a){var b=CubicVR.vec3;if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&
a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var f=0,e=this.avoid_sphere.length;f<e;f++)if(b.length(a,this.avoid_sphere[f][0])<this.avoid_sphere[f][1])return!1;return!0},findNextNode:function(a,b){var f=CubicVR.vec3,e=[0,0,0],c=[0,0,0],h=e=0,m=!1;do if(c[0]=Math.random()-0.5,c[1]=Math.random()-0.5,c[2]=Math.random()-0.5,c=f.normalize(c),e=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,e=f.add(b.position,f.multiply(c,
e)),m=this.inBounds(e),h++,h>30){e=b.position;break}while(!m);return e},run:function(a){this.current_time=a;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(q.motion.POS,q.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(q.motion.POS,q.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(q.motion.POS,q.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;
var b=new s,f=new s;this.path_length&&this.camPath.apply(this.path_time-this.segment_time*2,b);this.camPath.apply(this.path_time-this.segment_time,f);b=this.findNextNode(b,f);this.camPath.setKey(q.motion.POS,q.motion.X,this.path_time,b[0]);this.camPath.setKey(q.motion.POS,q.motion.Y,this.path_time,b[1]);this.camPath.setKey(q.motion.POS,q.motion.Z,this.path_time,b[2]);this.path_length++}b=new s;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,b])},addAvoidSphere:function(a,
b){this.avoid_sphere.push([a,b])}};return{Camera:z,AutoCamera:r}});
CubicVR.RegisterModule("CollisionMap",function(){var u=CubicVR.enums;u.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var z=function(s){this.shapes=[];this.result=null;if(s){s&&!s.length&&(s=[s]);for(var r=0,n=s.length;r<n;r++)this.addShape(s[r])}};z.prototype={addShape:function(s){s.type=CubicVR.parseEnum(u.collision.shape,s.type);s.position=s.position||[0,0,0];s.rotation=s.rotation||[0,0,0];s.size=s.size||[1,1,1];s.radius=s.radius||1;s.height=s.height||
1;s.margin=s.margin||0;s.mesh=s.mesh||null;this.shapes.push(s)},getShapes:function(){return this.shapes},setResult:function(s){this.result=s},getResult:function(){return this.result}};return{CollisionMap:z}});
CubicVR.RegisterModule("GML",function(u){function z(r){var n=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(r!==s){var r=n.getXML(r),q=r.getElementsByTagName("header");if(!q.length)return null;var d=q[0],q=r.getElementsByTagName("environment");if(!q.length)return null;this.name=null;d=d.getElementsByTagName("name");if(d.length)this.name=n.collectTextNode(d[0]);d=q[0].getElementsByTagName("screenBounds");if(d.length)this.bounds=
[parseFloat(n.collectTextNode(d[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(d[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(d[0].getElementsByTagName("z")[0]))];d=q[0].getElementsByTagName("origin");if(d.length)this.origin=[parseFloat(n.collectTextNode(d[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(d[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(d[0].getElementsByTagName("z")[0]))];q=q[0].getElementsByTagName("up");if(q.length)this.upvector=
[parseFloat(n.collectTextNode(q[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(q[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(q[0].getElementsByTagName("z")[0]))];r=r.getElementsByTagName("drawing");q=0;for(d=r.length;q<d;q++)for(var g=r[q].getElementsByTagName("stroke"),a=0,b=0,f=0,e=0,c=0,h=g.length;c<h;c++){for(var m=g[c].getElementsByTagName("pt"),o=m.length,y=Array(o),x,A,w,C=0,O=o;C<O;C++)w=m[C],o=parseFloat(n.collectTextNode(w.getElementsByTagName("x")[0])),
x=parseFloat(n.collectTextNode(w.getElementsByTagName("y")[0])),A=parseFloat(n.collectTextNode(w.getElementsByTagName("z")[0])),w=parseFloat(n.collectTextNode(w.getElementsByTagName("time")[0])),this.upvector[0]===1?y[C]=[x!==x?0:x,o!==o?0:-o,A!==A?0:A,w]:this.upvector[1]===1?y[C]=[o!==o?0:o,x!==x?0:x,A!==A?0:A,w]:this.upvector[2]===1&&(y[C]=[o!==o?0:o,A!==A?0:-A,x!==x?0:x,w]),a<o&&(a=o),b<x&&(b=x),f<A&&(f=A),e<w&&(e=w);if(f>e){m=0;for(C=y.length;m<C;m++)o=y[m][3],y[m][3]=y[m][2],y[m][2]=o/this.bounds[2]}this.strokes[c]=
y}}}var s=u.undef;z.prototype={addStroke:function(r,n){var q=[];n===s&&(n=0.1);for(var d=0,g=r.length;d<g;d++){var a=[r[d][0],r[d][1],r[d][2]];this.manual_pos+=n;a.push(this.manual_pos);q.push(a)}this.strokes.push(q)},recenter:function(){var r=CubicVR.vec3,n=[0,0,0],q=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],d,g,a,b;a=0;for(b=this.strokes.length;a<b;a++){d=0;for(g=this.strokes[a].length;d<g;d++)n[0]>this.strokes[a][d][0]&&(n[0]=this.strokes[a][d][0]),n[1]>this.strokes[a][d][1]&&
(n[1]=this.strokes[a][d][1]),n[2]>this.strokes[a][d][2]&&(n[2]=this.strokes[a][d][2]),q[0]<this.strokes[a][d][0]&&(q[0]=this.strokes[a][d][0]),q[1]<this.strokes[a][d][1]&&(q[1]=this.strokes[a][d][1]),q[2]<this.strokes[a][d][2]&&(q[2]=this.strokes[a][d][2])}r=r.multiply(r.subtract(q,n),0.5);a=0;for(b=this.strokes.length;a<b;a++){d=0;for(g=this.strokes[a].length;d<g;d++)this.strokes[a][d][0]-=r[0],this.strokes[a][d][1]-=this.upvector[1]?r[1]:-r[1],this.strokes[a][d][2]-=r[2]}},generateObject:function(r,
n,q,d,g){var a=CubicVR.vec3;r===s&&(r=0);n===s&&(n=0);g===s&&(g=!1);d===s&&(d=0.02);q===s&&(q=0.015);for(var b=n!==0,f=0,e=0,c=new CubicVR.Mesh(this.name),h,m,o,y,x,A,w=0,C=this.strokes.length;w<C;w++){A=new CubicVR.Envelope;var O=new CubicVR.Envelope,H=new CubicVR.Envelope,v=this.strokes[w].length,t=0,u=[],D=[],B=0,z=this.strokes[w];for(x=0;x<v;x++){var I=z[x],F=A.addKey(I[3],I[0]),E=O.addKey(I[3],I[1]),G;G=g?H.addKey(I[3],I[2]):H.addKey(I[3],0);F.tension=0.5;E.tension=0.5;G.tension=0.5;x!==0?(h=
I[0]-h,m=I[1]-m,o=I[2]-o,y=I[3]-y,o=Math.sqrt(h*h+m*m+o*o),t+=o,u[x-1]=o,D[x-1]=y):B=I[3];h=I[0];m=I[1];o=I[2];y=I[3]}t=B;v=c.points.length;for(x=0;x<u.length;x++){B=D[x];z=t;I=t+B;for(F=B/Math.ceil(u[x]/d*3);z<I-F;z+=F){z===t&&(h=A.evaluate(z),m=O.evaluate(z),o=H.evaluate(z));var N,E=A.evaluate(z+F);G=O.evaluate(z+F);N=H.evaluate(z+F);var J;J=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([E-h,G-m,N-o]))),q/2);c.addPoint([h-J[0],-(m-J[1]),o-J[2]+(b?n/2:0)]);c.addPoint([h+J[0],-(m+J[1]),
o+J[2]+(b?n/2:0)]);h=E;m=G;o=N}t+=B}O=c.points.length;if(b){x=v;for(A=O;x<A;x++)c.addPoint([c.points[x][0],c.points[x][1],c.points[x][2]-(b?n/2:0)])}x=0;for(A=O-v;x<=A-4;x+=2)f%r===0&&e++,c.setSegment(e),H=[v+x,v+x+1,v+x+3,v+x+2],c.addFace(H),b&&(H=[H[3]+O-v,H[2]+O-v,H[1]+O-v,H[0]+O-v],c.addFace(H),H=[v+x,v+x+2,v+x+2+O-v,v+x+O-v],c.addFace(H),H=[v+x+1+O-v,v+x+3+O-v,v+x+3,v+x+1],c.addFace(H),x===0&&(H=[v+x+O-v,v+x+1+O-v,v+x+1,v+x],c.addFace(H)),x===A-4&&(H=[v+x+2,v+x+3,v+x+3+O-v,v+x+2+O-v],c.addFace(H))),
f++}c.calcFaceNormals();c.triangulateQuads();c.calcNormals();c.compile();return c}};return{GML:z}});
CubicVR.RegisterModule("Landscape",function(u){function z(n,d,g,a){this.doTransform=function(){};this.tMatrix=r;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.rotation=[0,0,0];this.size=n;this.divisions_w=d;this.divisions_h=g;this.matRef=a;this.children=null;this.visible=!0;this.obj=new CubicVR.Mesh({dynamic:!0,buildWireframe:!0});this.divisions_w>this.divisions_h?(this.size_w=n,this.size_h=n/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?n/this.divisions_h*
this.divisions_w:n,this.size_h=n);for(d=-(this.size_h/2);d<this.size_h/2;d+=this.size_h/this.divisions_h)for(n=-(this.size_w/2);n<this.size_w/2;n+=this.size_w/this.divisions_w)this.obj.addPoint([n+this.size_w/this.divisions_w/2,0,d+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(d=0;d<this.divisions_h-1;d++)for(n=0;n<this.divisions_w-1;n++)this.obj.addFace([n+(d+1)*this.divisions_w,n+1+d*this.divisions_w,n+d*this.divisions_w]),this.obj.addFace([n+(d+1)*this.divisions_w,
n+1+(d+1)*this.divisions_w,n+1+d*this.divisions_w])}var s=u.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],n=Math.PI/2;z.prototype={isWireframe:function(){return!1},getMesh:function(){return this.obj},getEventHandler:function(){return s},setIndexedHeight:function(n,d,g){obj.points[n+d*this.divisions_w][1]=g},mapGen:function(n,d,g,a,b){if(d!==s&&g!==s&&a!==s&&b!==s){if(!(d>=this.divisions_w)&&!(g>=this.divisions_h)&&(d+a>=this.divisions_w&&(a=this.divisions_w-1-d),g+b>=this.divisions_h&&(b=this.divisions_h-
1-g),!(a<=0||b<=0)))for(var f=d,a=d+a;f<a;f++)for(var e=g,c=g+b;e<c;e++){var h=f+e*this.divisions_w,d=this.obj.points[h];d[1]=n(d[0],d[2],h)}}else{g=0;for(b=this.obj.points.length;g<b;g++)d=this.obj.points[g],d[1]=n(d[0],d[2],g)}},getFaceAt:function(n,d){if(typeof n==="object")return this.getFaceAt(n[0],n[2]);var g=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((n+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),g=parseInt(Math.floor((d+g)/this.size_h*
this.divisions_h),10);if(a<0)return-1;if(a>=this.divisions_w-1)return-1;if(g<0)return-1;if(g>=this.divisions_h-1)return-1;var a=parseInt(a+g*(this.divisions_w-1),10)*2,g=parseInt(a+1,10),b=this.obj.points[this.obj.faces[a].points[0]];return Math.abs(d-b[2])/Math.abs(n-b[0])>=1?a:g},getHeightValue:function(n,d){var g=CubicVR.triangle;if(typeof n==="object")return this.getHeightValue(n[0],n[2]);var a,b=this.getFaceAt(n,d);if(b===-1)return 0;a=this.obj.points[this.obj.faces[b].points[0]];var f=g.normal(this.obj.points[this.obj.faces[b].points[0]],
this.obj.points[this.obj.faces[b].points[1]],this.obj.points[this.obj.faces[b].points[2]]),g=f[0],b=f[1],f=f[2];return(g*n+f*d+(-(g*a[0])-b*a[1]-f*a[2]))/-b},orient:function(q,d,g,a,b,f){f===s&&(f=0);var e,c,h=[];e=g/2;var m=a/2;c=Math.sqrt(m*m+e*e);m=Math.atan2(m,e);b*=Math.PI/180;e=q+Math.sin(b)*f;f=d+Math.cos(b)*f;h[0]=this.getHeightValue([e+c*Math.cos(-m-n+b),0,f+c*-Math.sin(-m-n+b)]);h[1]=this.getHeightValue([e+c*Math.cos(m-n+b),0,f+c*-Math.sin(m-n+b)]);h[2]=this.getHeightValue([e+c*Math.cos(-m+
n+b),0,f+c*-Math.sin(-m+n+b)]);h[3]=this.getHeightValue([e+c*Math.cos(m+n+b),0,f+c*-Math.sin(m+n+b)]);c=-Math.atan2(h[1]-h[2],g);f=-Math.atan2(h[0]-h[1],a);c+=-Math.atan2(h[0]-h[3],g);f+=-Math.atan2(h[3]-h[2],a);c/=2;f/=2;return[[q,(h[2]+h[3]+h[1]+h[0])/4,d],[c*(180/Math.PI),b,f*(180/Math.PI)]]}};return{Landscape:z}});
CubicVR.RegisterModule("Layout",function(){function u(s){this.texture=s.texture?s.texture:null;this.width=s.width?s.width:128;this.height=s.height?s.height:128;this.x=s.x?s.x:0;this.y=s.y?s.y:0;this.blend=s.blend?s.blend:!1;this.opacity=typeof s.opacity!=="undefined"?s.opacity:1;this.tint=s.tint?s.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function z(s){this.texture=s.texture?s.texture:null;this.width=s.width?s.width:128;this.height=s.height?s.height:128;
this.x=s.x?s.x:0;this.y=s.y?s.y:0;this.blend=s.blend?s.blend:!1;this.opacity=typeof s.opacity!=="undefined"?s.opacity:1;this.tint=s.tint?s.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}u.prototype={addSubview:function(s){this.childViews.push(s);s.superView=this},makePanel:function(s){return this.superView.makePanel(s)}};z.prototype={resize:function(s,r){this.width=s;this.height=r},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(s){s.setInt("srcTex",0);s.addVector("screen");s.addVector("position");s.addVector("tint");s.addVector("size")}})},addSubview:function(s){this.childViews.push(s);s.superView=this},removeSubview:function(s){s=this.childViews.indexOf(s);s>-1&&this.childViews.splice(s,
1)},makePanel:function(s){var r=CubicVR.GLCore.gl,n={};n.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);n.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);n.gl_points=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n.gl_points);r.bufferData(r.ARRAY_BUFFER,n.vbo_points,r.STATIC_DRAW);n.gl_uvs=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n.gl_uvs);r.bufferData(r.ARRAY_BUFFER,n.vbo_uvs,r.STATIC_DRAW);s.panel=n},renderPanel:function(s){if(!s.texture)return!1;s.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(s){if(s.texture){var r=CubicVR.GLCore.gl,n=s.offsetLeft,q=s.offsetTop;n||(n=0);q||(q=0);var d=this.shader.shader;d.use();d.setVector("screen",[this.width,this.height,0]);d.setVector("position",[s.x+n,s.y+q,0]);d.setVector("size",[s.width,s.height,0]);d.setVector("tint",s.tint);s.blend&&(r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA));s.texture.use(r.TEXTURE0);r.drawArrays(r.TRIANGLES,0,6);s.blend&&(r.disable(r.BLEND),r.blendFunc(r.ONE,r.ZERO))}},render:function(){var s=
CubicVR.GLCore.gl;s.disable(s.DEPTH_TEST);this.texture&&this.renderView(this);var r=[];this.offsetTop=this.offsetLeft=0;r.push(this);var n=this.shader.shader;n.use();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null);s.bindBuffer(s.ARRAY_BUFFER,this.panel.gl_points);s.vertexAttribPointer(n.uniforms.aVertex,3,s.FLOAT,!1,0,0);s.enableVertexAttribArray(n.uniforms.aVertex);s.bindBuffer(s.ARRAY_BUFFER,this.panel.gl_uvs);s.vertexAttribPointer(n.uniforms.aTex,2,s.FLOAT,!1,0,0);s.enableVertexAttribArray(n.uniforms.aTex);
for(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null);r.length;){var q=r.pop();this.renderView(q);if(q.childViews.length)for(var d=q.childViews.length-1;d>=0;d--)q.childViews[d].offsetLeft=q.x+q.offsetLeft,q.childViews[d].offsetTop=q.y+q.offsetTop,r.push(q.childViews[d])}s.disableVertexAttribArray(n.uniforms.aTex);s.enable(s.DEPTH_TEST)}};return{Layout:z,View:u}});
CubicVR.RegisterModule("Light",function(u){function z(d,g){var a=CubicVR.aabb,d=CubicVR.get(d)||{};if(d===n)d=r.light.type.POINT;if(g===n)g=r.light.method.DYNAMIC;typeof d=="object"?(this.light_type=d.type!==n?CubicVR.parseEnum(r.light.type,d.type):r.light.type.POINT,this.diffuse=d.diffuse!==n?d.diffuse:[1,1,1],this.specular=d.specular!==n?d.specular:[1,1,1],this.intensity=d.intensity!==n?d.intensity:1,this.position=d.position!==n?d.position:[0,0,0],this.direction=d.direction!==n?d.direction:[0,0,
0],this.distance=d.distance!==n?d.distance:this.light_type===r.light.type.AREA?30:10,this.cutoff=d.cutoff!==n?d.cutoff:60,this.map_res=d.map_res!==n?d.map_res:this.light_type===r.light.type.AREA?2048:512,this.map_res=d.mapRes!==n?d.mapRes:this.map_res,this.method=d.method!==n?CubicVR.parseEnum(r.light.method,d.method):g,this.areaCam=d.areaCam!==n?d.areaCam:null,this.areaCeiling=d.areaCeiling!==n?d.areaCeiling:40,this.areaFloor=d.areaFloor!==n?d.areaFloor:-40,this.areaAxis=d.areaAxis!==n?d.areaAxis:
[1,1,0],this.projectorTex=d.projector!==n?d.projector:null):(this.light_type=CubicVR.parseEnum(r.light.type,d),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===r.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===r.light.type.AREA?2048:512,this.method=CubicVR.parseEnum(r.light.method,g),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&
typeof this.projectorTex==="string"){var b=this.projectorTex;this.projectorTex=u.Textures_ref[b]!==n?u.Textures_obj[u.Textures_ref[b]]:new CubicVR.Texture(b)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=CubicVR.SceneObject.prototype.adjust_octree;
this.motion=null;this.rotation=[0,0,0];(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.AREA&&u.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var s=u.GLCore,r=CubicVR.enums,n=u.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];r.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,
DYNAMIC:2}};z.prototype={setType:function(d){if(d===r.light.type.AREA&&!u.features.lightShadows)this.dummyCam=new CubicVR.Camera,this.areaCam=new CubicVR.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,d=r.light.type.DIRECTIONAL;else if((d===r.light.type.SPOT_SHADOW||d===r.light.type.SPOT_SHADOW_PROJECTOR)&&!u.features.lightShadows)d=r.light.type.SPOT;this.light_type=d},setParent:function(d){this.parent=d},setMethod:function(d){this.method=d},setDiffuse:function(d){this.diffuse=d},setSpecular:function(d){this.specular=
d},setIntensity:function(d){this.intensity=d},setPosition:function(d){this.position=d},setDistance:function(d){this.distance=d},setCutoff:function(d){this.cutoff=d},prepare:function(d){var g=CubicVR.mat4,a=CubicVR.mat3,b=this.light_type;if(this.parent)if(b===r.light.type.SPOT||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR)b=g.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,d.nMatrix),this.lPos=
g.vec3_multiply(this.position,g.multiply(d.mvMatrix,this.parent.tMatrix));else{if(b===r.light.type.POINT)this.lPos=g.vec3_multiply(this.position,g.multiply(d.mvMatrix,this.parent.tMatrix))}else if(b===r.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,d.nMatrix);else if(b===r.light.type.SPOT||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=a.vec3_multiply(this.direction,d.nMatrix),this.lPos=g.vec3_multiply(this.position,d.mvMatrix);else if(b===r.light.type.POINT)this.lPos=
g.vec3_multiply(this.position,d.mvMatrix);else if(b===r.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,d.nMatrix)},control:function(d,g,a){if(d===r.motion.POS)this.position[g]=a;else if(d===r.motion.INTENSITY)this.intensity=a},getAABB:function(){var d=CubicVR.vec3,g=CubicVR.aabb,a=[[0,0,0],[0,0,0]];g.engulf(a,[this.distance,this.distance,this.distance]);g.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=d.add(a[0],this.position);a[1]=d.add(a[1],this.position);return this.aabb=
a},setDirection:function(d,g,a){var b=CubicVR.vec3;if(typeof d==="object")this.setDirection(d[0],d[1],d[2]);else return this.direction=b.normalize([d,g,a]),this},lookat:function(d,g,a){var b=CubicVR.vec3;if(typeof d==="object")this.lookat(d[0],d[1],d[2]);else return this.direction=b.normalize(b.subtract([d,g,a],this.position)),this},setRotation:function(d,g,a){var b=CubicVR.mat4,f=CubicVR.vec3;if(typeof d==="object")this.setRotation(d[0],d[1],d[2]);else{var e=new CubicVR.Transform;e.rotate([-d,-g,
-a]);e.pushMatrix();this.direction=f.normalize(b.vec3_multiply([1,0,0],e.getResult()));this.rotation=[d,g,a];return this}},setupShader:function(d,g){var a=s.gl;a.uniform3fv(d.lightDiffuse[g],this.diffuse);a.uniform3fv(d.lightSpecular[g],this.specular);this.lPos&&a.uniform3fv(d.lightPosition[g],this.lPos);this.lDir&&a.uniform3fv(d.lightDirection[g],this.lDir);a.uniform1f(d.lightIntensity[g],this.intensity);a.uniform1f(d.lightDistance[g],this.distance);(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===
r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.SPOT)&&a.uniform1f(d.lightCutOffAngle[g],this.cutoff);if(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.AREA)this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(s.gl.TEXTURE0+g*2),a.uniform1i(d.lightShadowMap[g],g*2),this.projectorTex.use(s.gl.TEXTURE0+g*2+1),a.uniform1i(d.lightProjectionMap[g],g*2+1)):(this.shadowMapTex.texture.use(s.gl.TEXTURE0+
g),a.uniform1i(d.lightShadowMap[g],g)),a.uniform3fv(d.lightDepthClip[g],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(d.lightShadowMatrix[g],!1,this.spMatrix)},setShadow:function(d){if(u.features.lightShadows)this.map_res=d,this.shadowMapTex=new CubicVR.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(r.texture.filter.NEAREST),this.dummyCam=new CubicVR.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=
!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},setProjector:function(d){this.projectorTex=d},hasProjector:function(){return this.projectorTex!==null?!0:!1},shadowBegin:function(){var d=s.gl,g=CubicVR.mat4,a=CubicVR.mat3;this.shadowMapTex.use();d.viewport(0,0,this.map_res,this.map_res);d.clear(d.DEPTH_BUFFER_BIT|d.COLOR_BUFFER_BIT);this.light_type!==r.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();
if(this.parent){var b=g.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,b);g.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);g.multiply(this.dummyCam.mvMatrix.slice(0),g.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],
this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);d.cullFace(d.FRONT)},shadowEnd:function(){var d=s.gl;d.bindFramebuffer(d.FRAMEBUFFER,null);d.cullFace(d.BACK);this.setupTexGen()},setupTexGen:function(){var d=CubicVR.mat4;this.spMatrix=d.multiply(q,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=d.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=d.multiply(this.spMatrix,this.dummyCam.mvMatrix)},
setAreaAxis:function(d){this.areaAxis=d},updateAreaLight:function(){var d=CubicVR.vec3,g=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=d.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=d.normalize(b);d.normalize(d.cross(b,[0,1,0]));var f=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);b=d.multiply(b,a);a=[Math.tan(this.areaAxis[1]*
(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];f-=Math.atan2(a[0],a[2]);this.position=d.add(d.add(this.areaCam.position,b),d.multiply(a,g));this.position[1]=this.areaCeiling;this.target=d.add(d.add(this.areaCam.position,b),d.multiply(a,-g));this.target[1]=this.areaFloor;this.direction=d.normalize(d.subtract(this.target,this.position));this.dummyCam.rotation[2]=f*(180/Math.PI);d=this.dummyCam.nearclip;g=this.dummyCam.farclip*Math.abs(this.direction[1])*g;d=this.orthoBounds(this.position,
this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);d=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);d[1][1]>this.areaFloor&&(d=d[1][1]-this.areaFloor,g+=d/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=g;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(d,g,a,b,f,e){var b=CubicVR.vec3,
c=b.normalize([f[0],f[4],f[8]]),h=b.normalize([f[1],f[5],f[9]]),f=b.normalize(b.cross(h,c)),m;m=a/2;a=[];g=b.multiply(c,g/2);c=b.multiply(h,m);e=b.multiply(f,e);a[0]=b.add(b.subtract(d,g),b.add(c,e));a[1]=b.add(b.add(d,g),b.add(c,e));a[2]=b.subtract(b.subtract(d,g),b.add(c,e));a[3]=b.subtract(b.add(d,g),b.add(c,e));aabb1=a[0];aabb2=a[0];for(d=1;d<4;d++)aabb1[0]>a[d][0]&&(aabb1[0]=a[d][0]),aabb1[1]>a[d][1]&&(aabb1[1]=a[d][1]),aabb1[2]>a[d][2]&&(aabb1[2]=a[d][2]),aabb2[0]<a[d][0]&&(aabb2[0]=a[d][0]),
aabb2[1]<a[d][1]&&(aabb2[1]=a[d][1]),aabb2[2]<a[d][2]&&(aabb2[2]=a[d][2]);return[aabb1,aabb2]}};return{Light:z}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(u){if(!u.src)throw"PDF Error: you must specify a src url for a PDF.";var z=u.src,s=u.callback||function(){},r,n=[],q=[];this.__defineGetter__("pages",function(){return r?r.numPages:0});this.getPage=function(d){var g=r.numPages,d=d<1?1:d,d=d>g?g:d;d-=1;return n[d]};this.getPageTexture=function(d,g,a){d=this.getPage(d);g=g||d.width;a=a||d.height;return new CubicVR.PdfTexture(d,{width:g,height:a})};getPdf({url:z,error:function(){console.log("PDF Error: error loading pdf `"+
z+"`")}},function(d){r=new PDFDoc(d);for(var d=1,g=r.numPages;d<=g;d++){var a=r.getPage(d);n.push(a);q.push(a)}s()})}}});
CubicVR.RegisterModule("MainLoop",function(u){function z(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function s(){CubicVR.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(s),CubicVR.GLCore.mainloop.interval())}function r(a,b,f){if(window.requestAnimationFrame===q)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(CubicVR.GLCore.mainloop!==null)!window.requestAnimationFrame&&CubicVR.GLCore.mainloop&&clearInterval(CubicVR.GLCore.mainloop.interval),CubicVR.GLCore.mainloop=null;if(a===null)CubicVR.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],c=new z;c.start();this.timer=c;this.func=a;this.doclear=b!==q?b:!0;CubicVR.GLCore.mainloop=this;if(g.resizeList.length&&!CubicVR.GLCore.resize_active)window.addEventListener("resize",
function(){CubicVR.GLCore.onResize()},!1),CubicVR.GLCore.resize_active=!0;b=function(){return function(){var b=CubicVR.GLCore.gl;c.update();CubicVR.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);a(c,CubicVR.GLCore.gl);var m=e[e.length-1],o=m.scenes;m.update&&m.update(c,b);if(o){b=0;for(m=o.length;b<m;++b){var f=o[b];f.paused||(f.update&&f.update(c,CubicVR.GLCore.gl),f.render())}}}}();f?this.loopFunc=b:window.requestAnimationFrame?(this.interval=b,window.requestAnimationFrame(s)):
this.interval=setInterval(b,20)}}function n(a,b,f){this.canvas=a;this.camera=b;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];for(var c in d.keyboard)this.keyState[c]=!1;this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];
e.mEvents.mouseUp&&e.mEvents.mouseUp(e,e.mpos,e.keyState)}}();this.onMouseMove=function(){return function(a){var c=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];c[0]=a[0]-e.mpos[0];c[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,c,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(a){var a=
a.keyCode,c=null;e.mEvents.keyPress?(c=e.mEvents.keyPress(e,e.mpos,a,e.keyState),e.keyState[a]=c!==q?!!c:!0):e.keyState[a]=!0;e.keyState[a]&&e.mEvents.keyDown&&(c=e.mEvents.keyDown(e,e.mpos,a,e.keyState),e.keyState[a]=c!==q?!!c:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;e.mEvents.keyUp&&e.mEvents.keyUp(e,e.mpos,a,e.keyState);e.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,c,b){a.mdown&&a.orbitView(b)},mouseWheel:function(a,c,b){a.zoomView(b)},mouseDown:null,mouseUp:null,
keyDown:null,keyUp:null,keyPress:null};f!==!1&&this.setEvents(f===q?this.eventDefaults:f);this.bind()}var q=u.undef,d=CubicVR.enums,g=u.GLCore;d.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,
KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,
SEMICOLON:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};z.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=
!0},unlock:function(){var a=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=this.lock_rate*1E3|0:this.system_milliseconds=Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);
this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(a*1E3|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-
this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};r.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},
resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var b=0;b<a.scenes.length;++b)a.scenes[b].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],b=0;b<a.scenes.length;++b)a.scenes[b].disable();this.renderStack.length>1&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var b=
renderStack[renderStack.length-1],f,e=0,c=b.scenes.length;e<c;++e)if(b.scenes[e].scene.name===a){f=b.scenes[e];break}return f},resumeScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var b=renderStack[renderStack.length-1];typeof a==="string"&&(a=this.getScene(a));var f=b.scenes.indexOf(a);f>-1&&b.scenes.splice(f,1);return a},runOnce:function(){this.loopFunc()}};
n.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents={};for(var b in a)this.bindEvent(b,a[b])},orbitView:function(a){var b=CubicVR.vec3,f=b.subtract(this.camera.target,this.camera.position),f=b.length(f);this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-f*a[0]/300,0);this.camera.position[1]+=f*a[1]/300;this.camera.position=b.add(this.camera.target,b.multiply(b.normalize(b.subtract(this.camera.position,this.camera.target)),
f))},panView:function(a,b){var f=CubicVR.vec3;b||(b=!1);var e=f.subtract(this.camera.target,this.camera.position),e=f.length(e),c=this.camera.position;b?this.camera.position=f.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,-e*a[1]/300):(this.camera.position=f.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0),this.camera.position[1]+=e*a[1]/300);e=f.subtract(this.camera.position,c);this.camera.target=f.add(this.camera.target,e)},zoomView:function(a,b,f){var e=
CubicVR.vec3,c=e.subtract(this.camera.target,this.camera.position),c=e.length(c);c-=a/1E3;b||(b=0.1);f||(f=1E3);c<b&&(c=b);c>f&&(c=f);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),c))},bindEvent:function(a,b){this.mEvents[a]=b===q?this.eventDefaults[a]:b},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,
!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,
!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:z,MainLoop:r,MouseViewController:n,setMainLoop:function(a){CubicVR.GLCore.mainloop=a},keyboard:d.keyboard}});
CubicVR.RegisterModule("Texture",function(u){function z(a,c){if(a===1||c===1)return!1;else{if(a!==1)for(;a%2===0;)a/=2;if(c!==1)for(;c%2===0;)c/=2;if(a>1)return!1;if(c>1)return!1}return!0}function s(a){var c=CubicVR.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;
this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new CubicVR.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var e=this.canvasSource;z(e.width,e.height)?(this.setFilter(b.texture.filter.LINEAR_MIP),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,
c.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE));a.nodeName==="IMG"&&this.update()}function r(a,c){if(!a)throw"PDF Texture Error: page is null.";var e=this,f=CubicVR.GLCore.gl,d=this.canvasSource=document.createElement("canvas"),g;d.mozOpaque=!0;d.width=c.width;d.height=c.height;g=this.canvasContext=d.getContext("2d");g.save();g.fillStyle="rgb(255, 255, 255)";g.fillRect(0,
0,d.width,d.height);g.restore();a.startRendering(g,function(){e.update()});this.texture=new CubicVR.Texture;this.updateFunction=c.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;z(d.width,d.height)?(this.setFilter(b.texture.filter.LINEAR_MIP),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE))}function n(a,c,e){var f=CubicVR.GLCore.gl;this.texture=new CubicVR.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=c;this.canvas.height=e;this.pjs=new Processing(this.canvas,CubicVR.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;
this.filterType=this.texture.filterType;z(this.canvas.width,this.canvas.height)?this.setFilter(b.texture.filter.LINEAR_MIP):(this.setFilter(b.texture.filter.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE))}function q(c,e,o){var f=a.gl;this.width=e;this.height=o;this.srcTex=c;this.outTex=new CubicVR.RenderBuffer(e,o);z(e,o);c=[1/e,1/o,0];this.outputBuffer=new CubicVR.RenderBuffer(e,o,!1);this.fsQuad=CubicVR.fsQuad.make(e,
o);shaderNMap=new CubicVR.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",c);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(f.TEXTURE0);this.setFilter(b.texture.filter.LINEAR);
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT)}function d(c,e,o){var f=a.gl;this.width=c;this.height=e;this.outTex=new CubicVR.RenderBuffer(c,e,o);this.texture=this.outTex.texture;var d=z(c,e);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(f.TEXTURE0);d?(this.setFilter(b.texture.filter.LINEAR),
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE));this.dims=[c,e];this.depth=o?!0:!1}function g(a,c){this.scene=a;this.renderTex=new d(c?c.width:a.camera.width,c?c.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=u.GLCore,b=CubicVR.enums,f=u.undef;b.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var e=function(a,c){this.img_path=a;this.filter_type=c};e.prototype={getTexture:function(a,b){return new c(this.img_path,this.filter_type,a,b)}};var c=function(c,e,o,d,x){var g=a.gl;
this.tex_id=u.Textures.length;this.filterType=-1;this.onready=x;this.loaded=!1;u.Textures[this.tex_id]=g.createTexture();u.Textures_obj[this.tex_id]=this;if(c)typeof c==="string"?u.Images[this.tex_id]=new Image:typeof c==="object"&&c.nodeName==="IMG"&&(u.Images[this.tex_id]=c),u.Textures_ref[c]=this.tex_id;g.bindTexture(g.TEXTURE_2D,u.Textures[this.tex_id]);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR);if(c){var w=this.tex_id,
n=e!==f?e:a.default_filter,q=this;u.Images[this.tex_id].onload=function(){g.bindTexture(g.TEXTURE_2D,u.Textures[w]);g.pixelStorei(g.UNPACK_FLIP_Y_WEBGL,!0);g.pixelStorei(g.UNPACK_COLORSPACE_CONVERSION_WEBGL,g.NONE);var a=u.Images[w];g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,a);(a=z(a.width,a.height))?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.REPEAT),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.REPEAT)):(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,
g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE));if(u.Textures_obj[w].filterType===-1){if(a)n=b.texture.filter.LINEAR_MIP;else if(n===b.texture.filter.LINEAR_MIP)n=b.texture.filter.LINEAR;u.Textures_obj[w].filterType===-1&&u.Textures_obj[w].setFilter(n)}else u.Textures_obj[w].setFilter(u.Textures_obj[w].filterType);if(q.onready)q.onready();g.bindTexture(g.TEXTURE_2D,null);q.loaded=!0};if(o)u.Images[this.tex_id].deferredSrc=c,o.addImage(d,c,u.Images[this.tex_id]);else if(typeof c==="string")u.Images[this.tex_id].src=
c}this.active_unit=-1};c.prototype={setFilter:function(a){var c=CubicVR.GLCore.gl;c.bindTexture(c.TEXTURE_2D,u.Textures[this.tex_id]);a===b.texture.filter.LINEAR?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR)):a===b.texture.filter.LINEAR_MIP?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D)):a===b.texture.filter.NEAREST?
(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST)):a===b.texture.filter.NEAREST_MIP&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST_MIPMAP_LINEAR),c.generateMipmap(c.TEXTURE_2D));this.filterType=a},use:function(c){a.gl.activeTexture(c);a.gl.bindTexture(a.gl.TEXTURE_2D,u.Textures[this.tex_id]);this.active_unit=c},clear:function(){if(this.active_unit!==
-1)a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1}};s.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,u.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,
null)}};r.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,u.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};n.prototype={update:function(){var a=CubicVR.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,
u.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){var c=a.gl,b=c.getParameter(c.VIEWPORT);this.outputBuffer.use();c.viewport(0,0,this.width,this.height);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.srcTex.use(c.TEXTURE0);CubicVR.fsQuad.render(this.shaderNorm,
this.fsQuad);c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(b[0],b[1],b[2],b[3])}};d.prototype={begin:function(){var c=a.gl;this.dims=c.getParameter(c.VIEWPORT);this.outTex.use();c.viewport(0,0,this.width,this.height);this.depth?c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT):c.clear(c.COLOR_BUFFER_BIT)},end:function(){var c=a.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();
this.scene.render();this.renderTex.end()}};return{Texture:c,DeferredLoadTexture:e,CanvasTexture:s,PdfTexture:r,TextTexture:function(a,c){var b=c&&c.color||"#fff",e=c&&c.bgcolor,d=c&&c.font||"18pt Arial",g=c&&c.align||"start",w=c&&c.y||0,n=c&&c.width||f,q=c&&c.height||f,r,v=document.createElement("CANVAS"),t=v.getContext("2d"),u=0,u=typeof a==="string"?1:a.length;t.font=d;var D=c&&c.lineHeight||t.measureText("OO").width,B;if(u===1)B=t.measureText(a).width;else for(r=B=0;r<u;++r){var z=t.measureText(a[r]).width;
z>B&&(B=z)}v.width=n||B;v.height=q||D*u;if(e)t.fillStyle=e,t.fillRect(0,0,v.width,v.height);t.fillStyle=b;t.font=d;t.textAlign=g;t.textBaseline="top";if(u===1)b=c&&c.x||g==="center"?v.width/2:g==="right"?v.width:0,t.fillText(a,b,w);else for(r=0;r<u;++r)b=c&&c.x||g==="center"?v.width/2:g==="right"?v.width:0,t.fillText(a[r],b,w+r*D);t.fill();this.use=s.prototype.use;this.clear=s.prototype.clear;this.update=s.prototype.update;s.apply(this,[v]);this.update();this.canvasSource=null},PJSTexture:n,NormalMapGen:q,
RenderTexture:d,SceneRenderTexture:g}});
CubicVR.RegisterModule("Material",function(u){function z(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=CubicVR.get(a)||{},a.shader||null);q===null&&(q=new CubicVR.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
q._init_shader(q._vertex,q._fragment,!1));if(this.customShader&&!this.customShader._init_shader&&typeof this.customShader==="object")this.customShader=new CubicVR.CustomShader(this.customShader);this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.opacity=a.opacity===s?1:a.opacity;this.shininess=a.shininess===s?1:a.shininess;this.max_smooth=a.max_smooth===s?60:a.max_smooth;this.env_amount=a.env_amount===
s?0.75:a.env_amount;this.morph=a.morph===s?!1:a.morph;this.color_map=a.colorMap===s?!1:a.colorMap;this.uvOffset=a.uvOffset===s?[0,0]:a.uvOffset;if(a.textures)for(var f in a.textures)this.setTexture(a.textures[f],f)}var s=u.undef,r=u.GLCore,n=CubicVR.enums,q=null,d=[n.texture.map.REFLECT,n.texture.map.SPECULAR,n.texture.map.NORMAL,n.texture.map.BUMP],g=[],a=["textureColor","textureEnvSphere","textureNormal","textureBump","textureReflect","textureSpecular","textureAmbient","textureAlpha","matrixModelView",
"matrixProjection","matrixObject","matrixNormal","vertexPosition","vertexNormal","vertexColor","vertexTexCoord","materialTexOffset","vertexMorphPosition","vertexMorphNormal","materialMorphWeight","lightDiffuse","lightSpecular","lightIntensity","lightDistance","lightPosition","lightDirection","lightCutOffAngle","lightShadowMap","lightProjectionMap","lightDepthClip","lightShadowMatrix","lightAmbient","materialDiffuse","materialColor","materialAmbient","materialSpecular","materialShininess","materialEnvironment",
"materialAlpha","postDepthInfo"];z.prototype={clone:function(){var a=new CubicVR.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,name:this.name}),f;for(f in this.textures)this.textures.hasOwnProperty(f)&&a.setTexture(this.textures[f],f);return a},setTexture:function(a,f){if(a&&(f=CubicVR.parseEnum(n.texture.map,f)||
0,u.features.texturePerPixel||d.indexOf(f)===-1))!a.use&&typeof a==="string"&&(a=u.Textures_ref[a]!==s?u.Textures_obj[u.Textures_ref[a]]:new CubicVR.Texture(a)),this.textures[f]=a},calcShaderMask:function(){var a=0;a+=typeof this.textures[n.texture.map.COLOR]==="object"?n.shader.map.COLOR:0;a+=typeof this.textures[n.texture.map.SPECULAR]==="object"?n.shader.map.SPECULAR:0;a+=typeof this.textures[n.texture.map.NORMAL]==="object"?n.shader.map.NORMAL:0;a+=typeof this.textures[n.texture.map.BUMP]==="object"?
n.shader.map.BUMP:0;a+=typeof this.textures[n.texture.map.REFLECT]==="object"?n.shader.map.REFLECT:0;a+=typeof this.textures[n.texture.map.ENVSPHERE]==="object"?n.shader.map.ENVSPHERE:0;a+=typeof this.textures[n.texture.map.AMBIENT]==="object"?n.shader.map.AMBIENT:0;a+=typeof this.textures[n.texture.map.ALPHA]==="object"?n.shader.map.ALPHA:0;a+=this.opacity!==1?n.shader.map.ALPHA:0;a+=this.color_map?n.shader.map.COLORMAP:0;if(this.opacity!==1)this.blendEnabled=!0;return a},getShaderHeader:function(a,
f){return(f!==s?"#define LIGHT_COUNT "+f+"\n":"")+"#define TEXTURE_COLOR "+(typeof this.textures[n.texture.map.COLOR]==="object"?1:0)+"\n#define TEXTURE_SPECULAR "+(typeof this.textures[n.texture.map.SPECULAR]==="object"?1:0)+"\n#define TEXTURE_NORMAL "+(typeof this.textures[n.texture.map.NORMAL]==="object"?1:0)+"\n#define TEXTURE_BUMP "+(typeof this.textures[n.texture.map.BUMP]==="object"?1:0)+"\n#define TEXTURE_REFLECT "+(typeof this.textures[n.texture.map.REFLECT]==="object"?1:0)+"\n#define TEXTURE_ENVSPHERE "+
(typeof this.textures[n.texture.map.ENVSPHERE]==="object"?1:0)+"\n#define TEXTURE_AMBIENT "+(typeof this.textures[n.texture.map.AMBIENT]==="object"?1:0)+"\n#define TEXTURE_ALPHA "+(typeof this.textures[n.texture.map.ALPHA]==="object"?1:0)+"\n#define MATERIAL_ALPHA "+(this.opacity!==1?1:0)+"\n#define LIGHT_IS_POINT "+(a===n.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===n.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===n.light.type.SPOT||a===n.light.type.SPOT_SHADOW||a===
n.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(a===n.light.type.SPOT_SHADOW||a===n.light.type.SPOT_SHADOW_PROJECTOR||a===n.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===n.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(r.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===n.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===n.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(r.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?
1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define LIGHT_PERPIXEL "+(u.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(a,f){var e=r.gl,c=f.vertexPosition,h=f.vertexTexCoord,m=f.vertexNormal,o=f.vertexColor;e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_points);e.vertexAttribPointer(c,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(c);h!==null&&a.compiled.gl_uvs!==null&&h!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_uvs),e.vertexAttribPointer(h,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(h));
g.uv=h;m!==null&&a.compiled.gl_normals!==null&&m!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_normals),e.vertexAttribPointer(m,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(m));g.un=m;o!==null&&a.compiled.gl_colors!==null&&o!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_colors),e.vertexAttribPointer(o,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(o));g.uc=o;if(a.morphTarget)c=f.vertexMorphPosition,m=f.vertexMorphNormal,e.bindBuffer(e.ARRAY_BUFFER,a.morphTarget.gl_points),e.vertexAttribPointer(c,
3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(c),m!==null&&a.morphTarget.gl_normals!==null&&m!==-1&&(e.bindBuffer(e.ARRAY_BUFFER,a.morphTarget.gl_normals),e.vertexAttribPointer(m,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(m)),e.uniform1f(f.materialMorphWeight,a.morphWeight);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,f){var e=r.gl;g.uv!==s&&g.uv!==-1&&e.disableVertexAttribArray(g.uv);g.un!==s&&g.un!==-1&&e.disableVertexAttribArray(g.un);g.uc!==s&&g.uc!==-1&&
e.disableVertexAttribArray(g.uc);if(a.morphTarget&&f)up=f.vertexMorphPosition,e.disableVertexAttribArray(up),un=f.vertexMorphNormal,un!==null&&a.compiled.gl_normals!==null&&un!==-1&&e.disableVertexAttribArray(un)},use:function(b,f){var e,c=r.gl,h=this.textures,m=!0,f=f||0,b=b||0;this.shader[b]||(this.shader[b]=[]);var o=this.shader[b][f];e=this.customShader&&b===n.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();if(o&&this.opacity!==1&&this.blendEnabled!==!0)this.dirtyFlag=!0;if(this.dirtyFlag===
!0)o=null,this.dirtyFlag=!1;if(o)m=o!==q,o.use(),this.customShader&&!e&&this.customShader._doUpdate();else{var d=this.calcShaderMask(b);if(!this.customShader||e)u.ShaderPool[b][d]||(u.ShaderPool[b][d]=[]),o=u.ShaderPool[b][d][f];if(!o){var g=this.getShaderHeader(b,f),A=g+r.CoreShader_vs;g+=r.CoreShader_fs;this.customShader&&!e?this.customShader._initialized||(this.customShader._init_shader(A,g,a),o=this.customShader.getShader(),o.isCompiled()||(m=!1,o=q.getShader())):(o=new CubicVR.Shader(A,g),o.isCompiled()||
(m=!1,o=q.getShader()),u.ShaderPool[b][d][f]=o);e=0;if(b!==n.light.type.DEPTH_PACK){if(b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)e+=f,b===n.light.type.SPOT_SHADOW_PROJECTOR&&(e+=f);typeof h[n.texture.map.COLOR]==="object"&&o.addInt("textureColor",e++);typeof h[n.texture.map.ENVSPHERE]==="object"&&o.addInt("textureEnvSphere",e++);typeof h[n.texture.map.NORMAL]==="object"&&o.addInt("textureNormal",e++);typeof h[n.texture.map.BUMP]==="object"&&o.addInt("textureBump",
e++);typeof h[n.texture.map.REFLECT]==="object"&&o.addInt("textureReflect",e++);typeof h[n.texture.map.SPECULAR]==="object"&&o.addInt("textureSpecular",e++);typeof h[n.texture.map.AMBIENT]==="object"&&o.addInt("textureAmbient",e++)}typeof h[n.texture.map.ALPHA]==="object"&&o.addInt("textureAlpha",e++);o.addMatrix("matrixModelView");o.addMatrix("matrixProjection");o.addMatrix("matrixObject");o.addMatrix("matrixNormal");o.addVertexArray("vertexPosition");o.addVertexArray("vertexNormal");this.color_map&&
o.addVertexArray("vertexColor");this.morph&&(o.addVertexArray("vertexMorphPosition"),o.addVertexArray("vertexMorphNormal"),o.addFloat("materialMorphWeight",0));for(e=0;e<f;e++)if(o.addVector("lightDiffuse["+e+"]"),o.addVector("lightSpecular["+e+"]"),o.addFloat("lightIntensity["+e+"]"),o.addFloat("lightDistance["+e+"]"),o.addVector("lightPosition["+e+"]"),o.addVector("lightDirection["+e+"]"),(b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.SPOT)&&o.addFloat("lightCutOffAngle["+
e+"]"),b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)o.addInt("lightShadowMap["+e+"]"),b===n.light.type.SPOT_SHADOW_PROJECTOR&&o.addInt("lightProjectionMap["+e+"]"),o.addVector("lightDepthClip["+e+"]"),o.addMatrix("lightShadowMatrix["+e+"]");b!==n.light.type.DEPTH_PACK&&(o.addVector("lightAmbient"),o.addVector("materialDiffuse"),o.addVector("materialColor"),o.addVector("materialAmbient"),o.addVector("materialSpecular"),o.addFloat("materialShininess"),
o.addFloat("materialEnvironment"));o.addFloat("materialAlpha");(r.depth_alpha||b===n.light.type.DEPTH_PACK||b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)&&o.addVector("postDepthInfo");o.addUVArray("vertexTexCoord");o.addVector("materialTexOffset")}this.shader[b][f]=o;o.use();o.materialTexOffset!=-1&&c.uniform2fv(o.materialTexOffset,[0,0]);this.customShader&&this.customShader._doUpdate()}e=0;var w;if(b!==n.light.type.DEPTH_PACK){if(b===n.light.type.SPOT_SHADOW||
b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)e+=f,b===n.light.type.SPOT_SHADOW_PROJECTOR&&(e+=f);if(w=h[n.texture.map.COLOR])w.use(r.gl.TEXTURE0+e),e++;if(w=h[n.texture.map.ENVSPHERE])w.use(r.gl.TEXTURE0+e),e++,c.uniform1f(o.materialEnvironment,this.env_amount);if(w=h[n.texture.map.NORMAL])w.use(r.gl.TEXTURE0+e),e++;if(w=h[n.texture.map.BUMP])w.use(r.gl.TEXTURE0+e),e++;if(w=h[n.texture.map.REFLECT])w.use(r.gl.TEXTURE0+e),e++;if(w=h[n.texture.map.SPECULAR])w.use(r.gl.TEXTURE0+e),e++;
if(w=h[n.texture.map.AMBIENT])w.use(r.gl.TEXTURE0+e),e++}(w=h[n.texture.map.ALPHA])&&w.use(r.gl.TEXTURE0+e);b!==n.light.type.DEPTH_PACK?(c.uniform3fv(o.materialColor,this.color),c.uniform3fv(o.materialDiffuse,this.diffuse),c.uniform3fv(o.materialAmbient,this.ambient),c.uniform3fv(o.materialSpecular,this.specular),c.uniform1f(o.materialShininess,this.shininess*128),c.uniform3fv(o.lightAmbient,CubicVR.globalAmbient),this.opacity!==1&&c.uniform1f(o.materialAlpha,this.opacity),(r.depth_alpha||b===n.light.type.SPOT_SHADOW||
b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)&&c.uniform3fv(o.postDepthInfo,[r.depth_alpha_near,r.depth_alpha_far,0])):c.uniform3fv(o.postDepthInfo,[r.shadow_near,r.shadow_far,0]);o.materialTexOffset&&c.uniform2fv(o.materialTexOffset,this.uvOffset);return m}};return{Material:z}});
CubicVR.RegisterModule("Mesh",function(u){function z(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function s(d){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;d=CubicVR.get(d)||
{};if(d instanceof CubicVR.Mesh)this.booleanAdd(d),d._clones=d._clones||1,d._clones++,this.name=d.name?d.name+"_copy"+d._clones:null;else{this.name=d.name||null;this.dynamic=d.dynamic||!1;if(d.material){var g=d.material;g.length?this.materials=g:typeof g==="object"&&(g.use?this.setFaceMaterial(g):this.setFaceMaterial(new CubicVR.Material(g)))}d.points&&this.build(d);d.part?this.build(d.part):d.parts&&this.build(d.parts);if((this.primitives=d.primitives||d.primitive||null)&&!this.primitives.length||
typeof this.primitives==="string")this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var g=0,a=this.primitives.length;g<a;g++){var b=this.primitives[g];typeof b==="string"&&(b=CubicVR.get(b));var f=CubicVR.primitives[b.type];if(b.type&&f)this.booleanAdd(f(b));else if(b.type){q("Mesh error, primitive "+b.type+" is unknown.");var b="",e;for(e in CubicVR.primitives)CubicVR.primitives.hasOwnProperty(e)&&(b!==""&&(b+=", "),b+=e);q("Available primitive types are: "+b)}else q("Mesh error, primitive "+
(g+1)+" lacks type.")}this.buildWireframe=d.buildWireframe||d.wireframe||!!d.wireframeMaterial||d.triangulateWireframe||!1;this.triangulateWireframe=d.triangulateWireframe||null;this.wireframeMaterial=CubicVR.get(d.wireframeMaterial,CubicVR.Material)||null;this.wireframe=d.wireframe||!1;d.flipFaces&&this.faces.length&&this.flipFaces();(d.prepare||d.compile&&this.faces.length)&&this.prepare();(d.clean||d.compile&&this.faces.length&&!this.dynamic)&&this.clean();d.calcNormals&&!d.compile&&!d.prepare&&
this.calcNormals()}}var r=u.undef,n=u.GLCore,q=u.log;z.prototype={setUV:function(d,g){g!==r?this.uvs[g]=d:d.length!==2?this.uvs=d:this.uvs.push(d)},setColor:function(d,g){g!==r?this.point_colors[g]=d:typeof d[0]!=="number"?this.point_colors=d:this.point_colors.push(d)},flip:function(){for(var d=0,g=this.point_normals.length;d<g;d++)this.point_normals[d]=[-this.point_normals[d][0],-this.point_normals[d][1],-this.point_normals[d][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();
this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};s.prototype={setWireframe:function(d){this.wireframe=d},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(d){this.wireframeMaterial=d},build:function(d,g){var a,b;typeof d==="string"&&(d=CubicVR.get(d));d&&!d.length&&(d=[d]);var f=this.faces.length;g&&g.length&&this.points.concat(g);for(var e=0,c=d.length;e<c;e++){var h=d[e];a=h.material;b=h.points;var m=h.faces,o=h.uv,y=h.color,h=h.segment||null;h!==null&&this.setSegment(parseInt(h,
10));if(b&&b.length&&(this.points=this.points.concat(b),m&&f)){m=m.slice(0);b=0;for(h=m.length;b<h;b++)for(var x=m[b],A=0,w=m.length;A<w;A++)x[A]+=f}if(a)a.length?this.materials=a:typeof a==="object"&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new CubicVR.Material(a)));m&&m.length&&this.addFace(m);if(m&&o&&typeof o==="object"){h=null;if(o.length&&o.length===m.length)if(o.length===m.length){a=0;for(b=o.length;a<b;a++)this.faces[a+f].setUV(o[a])}else q("Mesh error in part, face count: "+m.length+
", uv count:"+o.length);else h=o.apply?o:new CubicVR.UVMapper(o);h&&h.apply(this,this.currentMaterial,this.currentSegment,f,this.faces.length-f)}if(m&&y&&typeof y==="object")if(y.length&&y.length===m.length){a=0;for(b=y.length;a<b;a++)this.faces[a+f].setColor(y[a]);this.materials[this.currentMaterial].colorMap=!0}else q("Mesh error in part, face count: "+m.length+", color count:"+y.length)}return this},showAllSegments:function(){for(var d in this.segment_state)this.segment_state.hasOwnProperty(d)&&
(this.segment_state[d]=!0)},hideAllSegments:function(){for(var d in this.segment_state)this.segment_state.hasOwnProperty(d)&&(this.segment_state[d]=!1)},setSegment:function(d,g){g!==r?this.segment_state[d]=g:this.currentSegment=d},addPoint:function(d){if(d.length!==3||typeof d[0]==="object")for(var g=0,a=d.length;g<a;g++)this.points.push(d[g]);else this.points.push(d);return this.points.length-1},getMaterialIndex:function(d){return this.materials.indexOf(d)},setFaceMaterial:function(d,g){var a;typeof d==
"number"?a=d:(a=this.materials.indexOf(d),a===-1&&(this.materials.push(d),a=this.materials.length-1));if(g!==r){if(this.faces[g]!==r)this.faces[g].material=a}else this.currentMaterial=a;return this},addFace:function(d,g,a,b){if(typeof d[0]!=="number"){g=0;for(a=d.length;g<a;g++)this.addFace(d[g])}else{g===r?(this.currentFace=this.faces.length,this.faces.push(new z)):(this.faces[g]===r&&(this.faces[g]=new z),this.currentFace=g);if(typeof d==="object")this.faces[this.currentFace].points=d;a!==r?this.setFaceMaterial(a,
this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=b!==r?b:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var d=0,g=this.faces.length;d<g;d++)this.faces[d].flip()},triangulateQuads:function(){for(var d=0,g=this.faces.length;d<g;d++)if(this.faces[d].points.length===4){var a=this.faces.length;this.addFace([this.faces[d].points[2],this.faces[d].points[3],this.faces[d].points[0]],this.faces.length,this.faces[d].material,
this.faces[d].segment);this.faces[d].points.pop();this.faces[a].normal=this.faces[d].normal.slice(0);this.faces[d].point_colors.length===4&&(this.faces[a].setColor(this.faces[d].point_colors[2],0),this.faces[a].setColor(this.faces[d].point_colors[3],1),this.faces[a].setColor(this.faces[d].point_colors[0],2),this.faces[d].point_colors.pop());this.faces[d].uvs.length===4&&(this.faces[a].setUV(this.faces[d].uvs[2],0),this.faces[a].setUV(this.faces[d].uvs[3],1),this.faces[a].setUV(this.faces[d].uvs[0],
2),this.faces[d].uvs.pop());this.faces[d].point_normals.length===4&&(this.faces[a].point_normals[0]=this.faces[d].point_normals[2],this.faces[a].point_normals[1]=this.faces[d].point_normals[3],this.faces[a].point_normals[2]=this.faces[d].point_normals[0],this.faces[d].point_normals.pop())}return this},booleanAdd:function(d,g){var a=CubicVR.mat4,b=this.points.length,f,e,c,h;f=g;g=f===r?r:typeof f==="array"?f:typeof f==="object"?f.getResult?f.getResult():f.position||f.rotation||f.scale?CubicVR.mat4.transform(f.position,
f.rotation,f.scale):r:void 0;if(d.wireframeMaterial)this.wireframeMaterial=d.wireframeMaterial;if(g!==r){e=g;f=0;for(c=d.points.length;f<c;f++)this.addPoint(a.vec3_multiply(d.points[f],e))}else{f=0;for(c=d.points.length;f<c;f++)this.addPoint([d.points[f][0],d.points[f][1],d.points[f][2]])}a=[];f=0;for(c=d.materials.length;f<c;f++)e=this.materials.indexOf(d.materials[f]),e===-1?(this.materials.push(d.materials[f]),a[f]=this.materials.length-1):a[f]=e;f=0;for(c=d.faces.length;f<c;f++){var m=[];e=0;
for(h=d.faces[f].points.length;e<h;e++)m.push(d.faces[f].points[e]+b);m=this.faces[this.addFace(m)];m.segment=d.faces[f].segment;m.material=a[d.faces[f].material];if(m.material===r)m.material=0;e=0;for(h=d.faces[f].uvs.length;e<h;e++)m.uvs[e]=[d.faces[f].uvs[e][0],d.faces[f].uvs[e][1]];e=0;for(h=d.faces[f].point_normals.length;e<h;e++)m.point_normals[e]=[d.faces[f].point_normals[e][0],d.faces[f].point_normals[e][1],d.faces[f].point_normals[e][2]]}return this},calcFaceNormals:function(d,g){var a=CubicVR.vec3,
b=CubicVR.triangle,f=0,e=this.faces.length,c,h=this.points,m;d&&(f=d);for(g&&(e=g+1);f<e;f++)c=this.faces[f],m=c.points,m.length<3?c.normal=[0,0,0]:a.normalize(b.normal(h[m[0]],h[m[1]],h[m[2]],c.normal));return this},getMaterial:function(d){for(var g=0,a=this.materials.length;g<a;g++)if(this.materials[g].name===d)return this.materials[g];return null},bindInstanceMaterials:function(d){this.instanceMaterials=d},calcNormals:function(d){var g=CubicVR.vec3,a=!1,b;this.dynamic&&(b=[],d=d||{});d!==r&&(b=
[],a=!0);this.calcFaceNormals();var f,e,c,h,m=Array(this.points.length);f=0;for(h=m.length;f<h;f++)m[f]=[];h=this.faces.length;for(f=0;f<h;f++){c=this.faces[f].points.length;for(e=0;e<c;e++)m[this.faces[f].points[e]].push([f,e])}f=0;for(h=this.points.length;f<h;f++){var o=m[f].length;for(e=0;e<o;e++){var y=1,x=m[f][e][0],A=m[f][e][1],w=this.materials.length?this.materials[this.faces[x].material].max_smooth:60,n=this.faces[x];a&&(b[x]===r&&(b[x]=[]),b[x][A]===r&&(b[x][A]=[]));var q=Array(3);q[0]=n.normal[0];
q[1]=n.normal[1];q[2]=n.normal[2];if(w!==0)for(c=0;c<o;c++)if(e!==c){var s=m[f][c][0],v=this.faces[s],t=g.angle(v.normal,n.normal);if(t!==t||t*(180/Math.PI)<=w)a&&b[x][A].push(s),q[0]+=v.normal[0],q[1]+=v.normal[1],q[2]+=v.normal[2],y++}q[0]/=y;q[1]/=y;q[2]/=y;this.faces[x].point_normals[A]=g.normalize(q)}}if(a){f=g=0;for(h=b.length;f<h;f++){e=0;for(c=b[f].length;e<c;e++)g+=b[f][e].length}if(!d.faceCount)d.faceCount=new Uint8Array(this.faces.length*3);if(!d.faceNorm)d.faceNorm=new Uint16Array(g);
f=g=0;for(h=this.faces.length;f<h;f++)for(e=0;e<3;e++)if(a=b[f][e],d.faceCount[f*3+e]=a?a.length:0,a){c=0;for(a=a.length;c<a;c++)d.faceNorm[g++]=b[f][e][c]}else g++;this.normalMapRef=d}return this},recalcNormals:function(d){var g,a,b,f,e,c,h,m,o,y;if(d=d||this.normalMapRef){this.calcFaceNormals();var x=0,A=0,w=0,n;g=0;for(a=this.faces.length;g<a;g++){o=this.faces[g];n=o.normal;for(j=0;j<3;j++){m=o.point_normals[j];e=n[0];c=n[1];h=n[2];y=d.faceCount[A++];b=0;for(iMax=y;b<iMax;b++)f=d.faceNorm[x++],
f=this.faces[f],f=f.normal,e+=f[0],c+=f[1],h+=f[2];y?(b=y+1,e/=b,c/=b,h/=b,b=Math.sqrt(e*e+c*c+h*h),e/=b,c/=b,h/=b,m[0]=e,m[1]=c,m[2]=h):w++}}return this}},removeDoubles:function(d){var g=[],a=[],b,f,e,c;b=0;for(f=this.points.length;b<f;b++){var h=-1,m=this.points[b];e=0;for(c=g.length;e<c;e++)if(CubicVR.vec3.equal(m,g[e],d)){h=e;break}h!=-1?a[b]=h:(a[b]=g.length,g.push(this.points[b]))}this.points=g;b=0;for(f=this.faces.length;b<f;b++){d=this.faces[b];e=0;for(c=d.points.length;e<c;e++)d.points[e]=
a[d.points[e]]}return this},buildEdges:function(){var d,g,a,b,f=[],e=[];d=0;for(a=this.faces.length;d<a;d++){var c=this.faces[d];g=0;for(b=c.points.length;g<b;g++){var h,m,o;o=c.segment;matId=c.material;g?(m=c.points[g],h=c.points[g-1]):(m=c.points[g],h=c.points[b-1]);f[h]=f[h]||{};f[h][matId]=f[h][matId]||{};f[h][matId][o]=f[h][matId][o]||{};!f[h][matId][o][m]&&(!f[m]||!f[m][matId][o][h])&&e.push([matId,o,h,m])}}this.edges=e;return this},subdivide:function(d,g){var a=CubicVR.vec3,g=g===r?!0:g;d===
r&&(d=1);if(d!==0){var b,f,e,c,h,m={},o=[],y=[],x=this.points.length,A=this.faces.length,w=[],n=[],s=[],H=[];b=0;for(e=A;b<e;b++)if(h=this.faces[b],h.points&&(h.points.length===3||h.points.length===4)){var v=[0,0,0];f=0;for(c=h.points.length;f<c;f++){var t=this.points[h.points[f]];v[0]+=t[0];v[1]+=t[1];v[2]+=t[2]}v[0]/=c;v[1]/=c;v[2]/=c;w[b]=this.addPoint(v);if(h.uvs.length===h.points.length){v=[0,0];f=0;for(c=h.uvs.length;f<c;f++)t=h.uvs[f],v[0]+=t[0],v[1]+=t[1];v[0]/=c;v[1]/=c;n[b]=v}if(h.point_colors.length===
h.points.length){v=[0,0,0];f=0;for(c=h.point_colors.length;f<c;f++)t=h.point_colors[f],v[0]+=t[0],v[1]+=t[1],v[2]+=t[2];v[0]/=c;v[1]/=c;v[2]/=c;s[b]=v}if(h.point_normals.length===h.points.length){v=[0,0,0];f=0;for(c=h.point_normals.length;f<c;f++)t=h.point_normals[f],v[0]+=t[0],v[1]+=t[1],v[2]+=t[2];v[0]/=c;v[1]/=c;v[2]/=c;H[b]=v}}b=0;for(e=this.faces.length;b<e;b++){h=this.faces[b];f=0;for(c=h.points.length;f<c;f++){var u,D;f?(u=f,D=f-1):(u=f,D=c-1);t=h.points[u];v=h.points[D];m[v]=m[v]||{};o[v]=
o[v]||[];o[v].push(b);m[v][t]={face:b,a:v,b:t,fpa:u,fpb:D}}}for(b in m)if(m.hasOwnProperty(b))for(f in m[b])if(m[b].hasOwnProperty(f)){e=m[b][f];h=m[f][b];if(h===r){q("Mesh.subdivide error. Hole at face #"+e.face+", Edge:["+e.fpa+"->"+e.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}if(!e.edge_point)c=a.multiply(a.add(this.points[e.a],this.points[e.b]),0.5),g?(v=a.multiply(a.add(this.points[w[e.face]],this.points[w[h.face]]),0.5),e.edge_point=a.multiply(a.add(c,v),0.5)):
e.edge_point=c,h.edge_point=e.edge_point,e.edge_avg=c,h.edge_avg=c,e.ep_idx=this.addPoint(e.edge_point),h.ep_idx=e.ep_idx;y[e.a]=y[e.a]||[];y[e.a].push(e.edge_avg);c=this.faces[e.face].uvs;if(c.length)h=c[e.fpa],c=c[e.fpb],e.uv=[(h[0]+c[0])/2,(h[1]+c[1])/2];h=this.faces[e.face].point_colors;if(h.length)e.color=a.multiply(a.add(h[e.fpa],h[e.fpb]),0.5);h=this.faces[e.face].point_normals;if(h.length)e.normal=a.normalize(a.multiply(a.add(h[e.fpa],h[e.fpb]),0.5))}if(g){h=[];b=0;for(e=x;b<e;b++)if(v=[0,
0,0],o[b]){f=0;for(c=o[b].length;f<c;f++)t=this.points[w[o[b][f]]],v[0]+=t[0],v[1]+=t[1],v[2]+=t[2];v[0]/=c;v[1]/=c;v[2]/=c;h[b]=v}v=[];b=0;for(e=x;b<e;b++)if(t=[0,0,0],y[b]){f=0;for(c=y[b].length;f<c;f++)u=y[b][f],t[0]+=u[0],t[1]+=u[1],t[2]+=u[2];t[0]/=c;t[1]/=c;t[2]/=c;v[b]=t}b=0;for(e=x;b<e;b++)if(o[b])x=o[b].length,f=1/x,y=2/x,x=a.multiply(this.points[b],(x-3)/x),x=a.add(x,a.multiply(h[b],f)),x=a.add(x,a.multiply(v[b],y)),this.points[b]=x}for(b=0;b<A;b++)if(h=this.faces[b],!(h.points.length!==
3&&h.points.length!==4))if(a=h.points.slice(0),o=h.uvs.slice(0),f=h.point_colors.slice(0),y=h.point_normals.slice(0),x=o.length===a.length,e=f.length===a.length,c=y.length===a.length,h=h.material,a.length===3){this.setFaceMaterial(h);v=m[a[0]][a[1]];t=m[a[2]][a[0]];this.addFace([a[0],v.ep_idx,w[b],t.ep_idx],b);if(x)this.faces[b].uvs=[o[0],v.uv,n[b],t.uv];if(e)this.faces[b].point_colors=[f[0],v.color,s[b],t.color];if(c)this.faces[b].point_normals=[y[0],v.normal,H[b],t.normal];v=m[a[1]][a[2]];t=m[a[0]][a[1]];
h=this.addFace([a[1],v.ep_idx,w[b],t.ep_idx]);if(x)this.faces[h].uvs=[o[1],v.uv,n[b],t.uv];if(e)this.faces[h].point_colors=[f[1],v.color,s[b],t.color];if(c)this.faces[h].point_normals=[y[1],v.normal,H[b],t.normal];v=m[a[2]][a[0]];t=m[a[1]][a[2]];h=this.addFace([a[2],v.ep_idx,w[b],t.ep_idx]);if(x)this.faces[h].uvs=[o[2],v.uv,n[b],t.uv];if(e)this.faces[h].point_colors=[f[2],v.color,s[b],t.color];if(c)this.faces[h].point_normals=[y[2],v.normal,H[b],t.normal]}else{this.setFaceMaterial(h);v=m[a[0]][a[1]];
t=m[a[3]][a[0]];this.addFace([a[0],v.ep_idx,w[b],t.ep_idx],b);if(x)this.faces[b].uvs=[o[0],v.uv,n[b],t.uv];if(e)this.faces[b].point_colors=[f[0],v.color,s[b],t.color];if(c)this.faces[b].point_normals=[y[0],v.normal,H[b],t.normal];v=m[a[1]][a[2]];t=m[a[0]][a[1]];h=this.addFace([a[1],v.ep_idx,w[b],t.ep_idx]);if(x)this.faces[h].uvs=[o[1],v.uv,n[b],t.uv];if(e)this.faces[h].point_colors=[f[1],v.color,s[b],t.color];if(c)this.faces[h].point_normals=[y[1],v.normal,H[b],t.normal];v=m[a[2]][a[3]];t=m[a[1]][a[2]];
h=this.addFace([a[2],v.ep_idx,w[b],t.ep_idx]);if(x)this.faces[h].uvs=[o[2],v.uv,n[b],t.uv];if(e)this.faces[h].point_colors=[f[2],v.color,s[b],t.color];if(c)this.faces[h].point_normals=[y[2],v.normal,H[b],t.normal];v=m[a[3]][a[0]];t=m[a[2]][a[3]];h=this.addFace([a[3],v.ep_idx,w[b],t.ep_idx]);if(x)this.faces[h].uvs=[o[3],v.uv,n[b],t.uv];if(e)this.faces[h].point_colors=[f[3],v.color,s[b],t.color];if(c)this.faces[h].point_normals=[y[3],v.normal,H[b],t.normal]}d--;if(d!==0)this.subdivide(d,g);else return this}},
removeInternals:function(){var d,g,a,b,f,e={},c=this.faces.length,h,m,o,y;d=0;for(a=this.faces.length;d<a;d++){f=this.faces[d];g=0;for(b=f.points.length;g<b;g++)g?(o=g,y=g-1):(o=g,y=b-1),h=f.points[o],m=f.points[y],e[h]=e[h]||{},e[h][m]===r?e[h][m]=[d]:e[h][m].push(d)}a=function(a){return e[m][h].indexOf(a)!==-1};for(d=0;d<c;d++){f=this.faces[d];var x=null;g=0;for(b=f.points.length;g<b;g++)g?(o=g,y=g-1):(o=g,y=b-1),h=f.points[o],m=f.points[y],x=x?x.filter(a):e[m][h];x.length&&(this.faces.splice(d,
1),c--,d--)}return this},prepare:function(d){d===r&&(d=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads().calcNormals();this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();d&&!this.dynamic&&this.clean();return this},clean:function(){var d,g;d=0;for(g=this.points.length;d<g;d++)delete this.points[d],this.points[d]=null;this.points=[];d=0;for(g=this.faces.length;d<g;d++)delete this.faces[d].points,delete this.faces[d].point_normals,
delete this.faces[d].uvs,delete this.faces[d].normal,delete this.faces[d],this.faces[d]=null;this.faces=[];return this},compileMap:function(d){var g=CubicVR.vec3,a=CubicVR.vec2;d===r&&(d=1.0E-5);var b={segments:[],bounds:[]},f=[],e,c,h,m,o,y,x,n;this.materials.length||this.materials.push(new CubicVR.Material);e=0;for(y=this.materials.length;e<y;e++)f[e]=[];e=0;for(y=this.faces.length;e<y;e++)if(this.faces[e].points.length===3)h=this.faces[e].material,m=this.faces[e].segment,f[h][m]===r&&(f[h][m]=
[],b.segments.push(m)),f[h][m].push(e);var w=[],q=0,s=!1,H=!1,v=!1,t;e=0;for(y=f.length;e<y;e++)for(c in f[e])if(f[e].hasOwnProperty(c))for(h=0;h<f[e][c].length;h++)t=f[e][c][h],s=s||this.faces[t].uvs.length!==0,H=H||this.faces[t].point_normals.length!==0,v=v||this.faces[t].point_colors.length!==0;if(s)for(e=0;e<this.faces.length;e++)if(!this.faces[e].uvs.length)for(c=0;c<this.faces[e].points.length;c++)this.faces[e].uvs.push([0,0]);if(H)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_normals.length)for(c=
0;c<this.faces[e].points.length;c++)this.faces[e].point_normals.push([0,0,0]);if(v)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_colors.length)for(c=0;c<this.faces[e].points.length;c++)this.faces[e].point_colors.push([0,0,0]);e=0;for(y=f.length;e<y;e++)for(c in f[e])if(f[e].hasOwnProperty(c)){h=0;for(x=f[e][c].length;h<x;h++){t=f[e][c][h];for(m=0;m<3;m++){var u=this.faces[t].points[m],D=-1;if(w[u]!==r){o=0;for(n=w[u].length;o<n;o++){var B=w[u][o][0],z=w[u][o][1],D=w[u][o][2];H&&(D=g.equal(this.faces[B].point_normals[z],
this.faces[t].point_normals[m],d)?D:-1);s&&(D=a.equal(this.faces[B].uvs[z],this.faces[t].uvs[m],d)?D:-1);v&&(D=g.equal(this.faces[B].point_colors[z],this.faces[t].point_colors[m],d)?D:-1)}}if(D!==-1){if(b.elements===r)b.elements=[];b.elements[e]===r&&(b.elements[e]=[]);b.elements[e][c]===r&&(b.elements[e][c]=[]);b.elements[e][c].push(D)}else{if(b.points===r)b.points=[];b.points.push(u);b.bounds.length===0?(b.bounds[0]=[this.points[u][0],this.points[u][1],this.points[u][2]],b.bounds[1]=[this.points[u][0],
this.points[u][1],this.points[u][2]]):(this.points[u][0]<b.bounds[0][0]&&(b.bounds[0][0]=this.points[u][0]),this.points[u][1]<b.bounds[0][1]&&(b.bounds[0][1]=this.points[u][1]),this.points[u][2]<b.bounds[0][2]&&(b.bounds[0][2]=this.points[u][2]),this.points[u][0]>b.bounds[1][0]&&(b.bounds[1][0]=this.points[u][0]),this.points[u][1]>b.bounds[1][1]&&(b.bounds[1][1]=this.points[u][1]),this.points[u][2]>b.bounds[1][2]&&(b.bounds[1][2]=this.points[u][2]));if(H){if(b.normals===r)b.normals=[];b.normals.push([t,
m])}if(v){if(b.colors===r)b.colors=[];b.colors.push([t,m])}if(s){if(b.uvs===r)b.uvs=[];b.uvs.push([t,m])}if(b.elements===r)b.elements=[];b.elements[e]===r&&(b.elements[e]=[]);b.elements[e][c]===r&&(b.elements[e][c]=[]);b.elements[e][c].push(q);w[u]===r&&(w[u]=[]);w[u].push([t,m,q]);q++}}}}if(this.edges){b.line_elements=[];e=0;for(y=this.edges.length;e<y;e++)g=this.edges[e],h=g[0],m=g[1],d=g[2],g=g[3],b.line_elements[h]=b.line_elements[h]||[],b.line_elements[h][m]=b.line_elements[h][m]||[],b.line_elements[h][m].push(w[d][0][2]),
b.line_elements[h][m].push(w[g][0][2])}b.dynamic=this.dynamic;return b},compileVBO:function(d,g,a,b,f,e,c,h){if(typeof g=="object")g=g.element!==r?g.element:!0,a=g.vertex!==r?g.vertex:!0,e=g.color!==r?g.color:!0,b=g.normal!==r?g.normal:!0,f=g.uv!==r?g.uv:!0,c=g.lines!==r?g.lines:!!d.line_elements,h=g.dynamic!==r?g.dynamic:d.dynamic;else if(g===r&&(g=!0),a===r&&(a=!0),e===r&&(e=!0),b===r&&(b=!0),f===r&&(f=!0),c===r&&(c=!!d.line_elements),h===r)h=d.dynamic;var m={},o,y,x,n;if(h)n={points:new Int16Array(d.points.length),
face_points:new Int16Array(d.points.length*2)},m.dynamicMap=n,m.dynamic=!0;if(d.points&&a){o=d.points.length;m.vbo_points=new Float32Array(o*3);for(a=0;a<o;a++)y=d.points[a],m.vbo_points[a*3]=this.points[y][0],m.vbo_points[a*3+1]=this.points[y][1],m.vbo_points[a*3+2]=this.points[y][2],h&&(n.points[a]=y)}if(h){h=d.normals||d.colors||d.uvs;a=0;for(o=h.length;a<o;a++)y=h[a],n.face_points[a*2]=y[0],n.face_points[a*2+1]=y[1]}if(d.normals&&b){o=d.normals.length;m.vbo_normals=new Float32Array(o*3);for(a=
b=0;a<o;a++)y=d.normals[a],m.vbo_normals[b++]=this.faces[y[0]].point_normals[y[1]][0],m.vbo_normals[b++]=this.faces[y[0]].point_normals[y[1]][1],m.vbo_normals[b++]=this.faces[y[0]].point_normals[y[1]][2]}if(d.colors&&e){o=d.colors.length;m.vbo_colors=new Float32Array(o*3);for(a=b=0;a<o;a++)y=d.colors[a],m.vbo_colors[b++]=this.faces[y[0]].point_colors[y[1]][0],m.vbo_colors[b++]=this.faces[y[0]].point_colors[y[1]][1],m.vbo_colors[b++]=this.faces[y[0]].point_colors[y[1]][2]}if(d.uvs&&f){o=d.uvs.length;
m.vbo_uvs=new Float32Array(o*2);for(a=b=0;a<o;a++)y=d.uvs[a],m.vbo_uvs[b++]=this.faces[y[0]].uvs[y[1]][0],m.vbo_uvs[b++]=this.faces[y[0]].uvs[y[1]][1]}if(g){m.elements_ref=[];m.vbo_elements=[];a=0;for(o=d.elements.length;a<o;a++)for(x in m.elements_ref[a]=[],g=0,d.elements[a])if(d.elements[a].hasOwnProperty(x)){b=d.elements[a][x];f=0;for(e=b.length;f<e;f++)m.vbo_elements.push(b[f]);m.elements_ref[a][g]=[x|0,b.length|0];g++}m.vbo_elements=new Uint16Array(m.vbo_elements)}if(c){m.line_elements_ref=[];
m.vbo_line_elements=[];a=0;for(o=d.line_elements.length;a<o;a++)for(x in m.line_elements_ref[a]=[],g=0,d.line_elements[a])if(d.line_elements[a].hasOwnProperty(x)){b=d.line_elements[a][x];f=0;for(e=b.length;f<e;f++)m.vbo_line_elements.push(b[f]);m.line_elements_ref[a][g]=[x|0,b.length|0];g++}m.vbo_line_elements=new Uint16Array(m.vbo_line_elements)}m.segments=d.segments;m.bounds=d.bounds;return m},updateVBO:function(d,g){if(!d.dynamic)return!1;var a,b,f=d.dynamicMap,e=g.points&&!!d.vbo_points,c=g.normals&&
!!d.vbo_normals,h=g.uvs&&!!d.vbo_uvs,m=g.colors&&!!d.vbo_colors,o,y,x;a=0;for(b=f.points.length;a<b;a++)y=this.faces[f.face_points[a*2]],x=f.face_points[a*2+1],e&&(o=this.points[f.points[a]],d.vbo_points[a*3]=o[0],d.vbo_points[a*3+1]=o[1],d.vbo_points[a*3+2]=o[2]),c&&(o=y.point_normals[x],d.vbo_normals[a*3]=o[0],d.vbo_normals[a*3+1]=o[1],d.vbo_normals[a*3+2]=o[2]),m&&(o=y.point_colors[x],d.vbo_colors[a*3]=o[0],d.vbo_colors[a*3+1]=o[1],d.vbo_colors[a*3+2]=o[2]),h&&(o=y.uvs[x],d.vbo_uvs[a*2]=o[0],d.vbo_uvs[a*
2+1]=o[1]);return this},rebufferVBO:function(d,g,a){var b=n.gl;a.points&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_points),b.bufferData(b.ARRAY_BUFFER,d.vbo_points,b.DYNAMIC_DRAW));a.normals&&d.vbo_normals&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_normals),b.bufferData(b.ARRAY_BUFFER,d.vbo_normals,b.DYNAMIC_DRAW));a.uvs&&d.vbo_uvs&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_uvs),b.bufferData(b.ARRAY_BUFFER,d.vbo_uvs,b.DYNAMIC_DRAW));a.colors&&d.vbo_colors&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_colors),b.bufferData(b.ARRAY_BUFFER,
d.vbo_colors,b.DYNAMIC_DRAW));b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(d,g){var a=n.gl,b={};g===r&&(g={});b.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_points);a.bufferData(a.ARRAY_BUFFER,d.vbo_points,a.STATIC_DRAW);d.vbo_normals?(b.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_normals),a.bufferData(a.ARRAY_BUFFER,d.vbo_normals,a.STATIC_DRAW)):b.gl_normals=g.gl_normals?g.gl_normals:null;d.vbo_uvs?(b.gl_uvs=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,
b.gl_uvs),a.bufferData(a.ARRAY_BUFFER,d.vbo_uvs,a.STATIC_DRAW)):b.gl_uvs=g.gl_uvs?g.gl_uvs:null;d.vbo_colors?(b.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_colors),a.bufferData(a.ARRAY_BUFFER,d.vbo_colors,a.STATIC_DRAW)):b.gl_colors=g.gl_colors?g.gl_colors:null;!d.vbo_elements&&g.gl_elements?(b.gl_elements=g.gl_elements,b.elements_ref=g.elements_ref):(b.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,d.vbo_elements,
a.STATIC_DRAW),b.elements_ref=d.elements_ref);!d.vbo_line_elements&&g.gl_line_elements?(b.gl_line_elements=g.gl_line_elements,b.line_elements_ref=g.line_elements_ref):(b.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,d.vbo_line_elements,a.STATIC_DRAW),b.line_elements_ref=d.line_elements_ref);b.segments=d.segments;b.bounds=d.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);return b},update:function(d){var d=d||{},g=d.points||
d.point||d.vertex||d.vertices||d.all||!0,a=d.uvs||d.uv||d.texture||d.all||!1,b=d.normals||d.normal||d.all||!0,d=d.colors||d.color||d.all||!1;if(!this.dynamic)return q("Mesh not defined as dynamic, cannot update."),!1;b&&this.normalMapRef&&this.recalcNormals();g={points:g,uvs:a,normals:b,colors:d};this.updateVBO(this.dynamicData.VBO,g);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,g)},bindBuffer:function(d){if(this.originBuffer===null)this.originBuffer=d;this.compiled=d;this.segment_state=
[];for(var g=0,a=d.segments.length;g<a;g++)this.segment_state[d.segments[g]]=!0;this.bb=d.bounds},compile:function(d){var d=this.compileVBO(this.compileMap(d)),g=this.bufferVBO(d);this.bindBuffer(g);if(this.dynamic){this.sourcePoints=[];for(var a=0,b=this.points.length;a<b;a++)this.sourcePoints[a]=this.points[a].slice(0);this.dynamicData={VBO:d,buffer:g}}return this},addMorphTarget:function(d){if(this.morphTargets===null)this.morphTargets=[];this.morphTargets.push(d)},setMorphSource:function(d){if(this.morphSourceIndex!==
d)this.morphSourceIndex=d,this.bindBuffer(this.morphTargets[d])},setMorphTarget:function(d){if(this.morphTargetIndex!==d)this.morphTargetIndex=d,this.morphTarget=this.morphTargets[d]},setMorphWeight:function(d){this.morphWeight=d},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:0}};return{Mesh:s,Face:z}});
CubicVR.RegisterModule("Motion",function(u){function z(){this.time=this.value=0;this.shape=q.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function s(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(q.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||q.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(q.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||q.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=q.envelope.behavior.CONSTANT}function r(a,c){this.controllers=[];this.yzflip=!1;if(typeof a==="object"){var b=CubicVR.get(a);this.env_init=CubicVR.get(b.envelope);this.key_init=CubicVR.get(b.key);for(var m in b)if(b.hasOwnProperty(m)&&!(m==="envelope"||m==="key")){var f=b[m],d=CubicVR.get(f.envelope),g;for(g in f)if(f.hasOwnProperty(g)&&!(g==="envelope"||g==="key")){var n=f[g];if(typeof n==="object")for(var w in n)this.setKey(m,w,g,n[w]),d&&this.setBehavior(m,w,
d)}}}else this.env_init=a,this.key_init=c}var n=u.undef,q=CubicVR.enums;q.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};q.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var d=function(a,c,b){var m=0,m=b-c;if(m===0)return[c,0];c=a-m*Math.floor((a-c)/m);m=-parseInt((c-a)/m+(c>a?0.5:-0.5),10);return[c,m]},g=function(a,c,b,m,f){var d,g;g=f*f;d=3*(c-
a);c=3*(b-c)-d;return(m-a-d-c)*g*f+c*g+d*f+a},a=function(b,c,h,m,f,d,x){var n,w;w=d+(x-d)*0.5;n=g(b,c,h,m,w);return Math.abs(f-n)>1.0E-4?(n>f?x=w:d=w,a(b,c,h,m,f,d,x)):w},b=function(a,c){var b,m,f,d;a.shape===q.envelope.shape.TCB?(b=(1-a.tension)*(1+a.continuity)*(1+a.bias),m=(1-a.tension)*(1-a.continuity)*(1-a.bias),f=c.value-a.value,a.prev?(d=(c.time-a.time)/(c.time-a.prev.time),b=d*(b*(a.value-a.prev.value)+m*f)):b=m*f):a.shape===q.envelope.shape.LINE?(f=c.value-a.value,a.prev?(d=(c.time-a.time)/
(c.time-a.prev.time),b=d*(a.value-a.prev.value+f)):b=f):a.shape===q.envelope.shape.BEZI||a.shape===q.envelope.shape.HERM?(b=a.param[1],a.prev&&(b*=(c.time-a.time)/(c.time-a.prev.time))):a.shape===q.envelope.shape.BEZ2?(b=a.param[3]*(c.time-a.time),Math.abs(a.param[2])>1.0E-5?b/=a.param[2]:b*=1E5):b=0;return b},f=function(a,c){var b,m,f,d;c.shape===q.envelope.shape.LINE?(f=c.value-a.value,c.next?(d=(c.time-a.time)/(c.next.time-a.time),b=d*(c.next.value-c.value+f)):b=f):c.shape===q.envelope.shape.TCB?
(b=(1-c.tension)*(1-c.continuity)*(1+c.bias),m=(1-c.tension)*(1+c.continuity)*(1-c.bias),f=c.value-a.value,c.next?(d=(c.time-a.time)/(c.next.time-a.time),b=d*(m*(c.next.value-c.value)+b*f)):b*=f):c.shape===q.envelope.shape.HERM||c.shape===q.envelope.shape.BEZI?(b=c.param[0],c.next&&(b*=(c.time-a.time)/(c.next.time-a.time))):c.shape===q.envelope.shape.BEZ2?(b=c.param[1]*(c.time-a.time),Math.abs(c.param[0])>1.0E-5?b/=c.param[0]:b*=1E5):b=0;return b};s.prototype={setBehavior:function(a,c){this.in_behavior=
CubicVR.parseEnum(q.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(q.envelope.behavior,c)},empty:function(){return this.nKeys===0},addKey:function(a,c,b){var m=typeof a=="object"?a:b;c||(c=0);a||(a=0);m?(m=a,a=m.time,b=this.insertKey(a),b.value=m.value?m.value:c,b.time=m.time?m.time:a,b.shape=CubicVR.parseEnum(q.envelope.shape,m.shape)||q.envelope.shape.TCB,b.tension=m.tension?m.tension:0,b.continuity=m.continuity?m.continuity:0,b.bias=m.bias?m.bias:0,b.param=m.param?m.param:[0,0,0,0]):
(b=this.insertKey(a),b.value=c);return b},insertKey:function(a){var c=new z;c.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=c,this.nKeys++,c;for(var b=this.keys;b;){if(this.firstKey.time>a)this.firstKey=c;else if(this.lastKey.time<a)this.lastKey=c;if(b.time>c.time){c.prev=b.prev;if(c.prev)c.prev.next=c;c.next=b;c.next.prev=c;this.nKeys++;return c}else if(!b.next)return c.prev=b,b.next=c,this.nKeys++,c;b=b.next}return null},evaluate:function(e){var c,h,m,o,y,x=0;if(this.nKeys===
0)return 0;if(this.nKeys===1)return this.keys.value;h=this.firstKey;c=this.lastKey;if(e<h.time)if(o=this.in_behavior,o===q.envelope.behavior.RESET)return 0;else if(o===q.envelope.behavior.CONSTANT)return h.value;else if(o===q.envelope.behavior.REPEAT)o=d(e,h.time,c.time),e=o[0];else if(o===q.envelope.behavior.OCILLATE)o=d(e,h.time,c.time),e=o[0],o=o[1],o%2&&(e=c.time-h.time-e);else if(o===q.envelope.behavior.OFFSET)o=d(e,h.time,c.time),e=o[0],o=o[1],x=o*(c.value-h.value);else{if(o===q.envelope.behavior.LINEAR)return y=
b(h,h.next)/(h.next.time-h.time),y*(e-h.time)+h.value}else if(e>c.time)if(o=this.out_behavior,o===q.envelope.behavior.RESET)return 0;else if(o===q.envelope.behavior.CONSTANT)return c.value;else if(o===q.envelope.behavior.REPEAT)o=d(e,h.time,c.time),e=o[0];else if(o===q.envelope.behavior.OCILLATE)o=d(e,h.time,c.time),e=o[0],o=o[1],o%2&&(e=c.time-h.time-e);else if(o===q.envelope.behavior.OFFSET)o=d(e,h.time,c.time),e=o[0],o=o[1],x=o*(c.value-h.value);else if(o===q.envelope.behavior.LINEAR)return o=
f(c.prev,c)/(c.time-c.prev.time),o*(e-c.time)+c.value;if(this.lastKey0)if(e>this.lastKey0.time)c=this.lastKey0;else if(e<this.lastKey0.time)for(c=this.lastKey;e<c.time&&c.prev;)c=c.prev;else c=this.keys;else c=this.keys;for(;e>c.next.time;)c=c.next;h=c.next;this.lastKey0=c;if(e===c.time)return c.value+x;else if(e===h.time)return h.value+x;m=(e-c.time)/(h.time-c.time);o=h.shape;if(o===q.envelope.shape.TCB||o===q.envelope.shape.BEZI||o===q.envelope.shape.HERM){y=b(c,h);o=f(c,h);var n,w;w=m*m;n=m*w;
e=3*w-n-n;n-=w;e=[1-e,e,n-w+m,n];return e[0]*c.value+e[1]*h.value+e[2]*y+e[3]*o+x}else return o===q.envelope.shape.BEZ2?(e=a(c.time,c.shape===q.envelope.shape.BEZ2?c.time+c.param[2]:c.time+(h.time-c.time)/3,h.time+h.param[0],h.time,e,0,1),x=g(c.value,c.shape===q.envelope.shape.BEZ2?c.value+c.param[3]:c.value+c.param[1]/3,h.param[1]+h.value,h.value,e)+x):x=o===q.envelope.shape.LINE?c.value+m*(h.value-c.value)+x:o===q.envelope.shape.STEP?c.value+x:x,x}};r.prototype={envelope:function(a,c){c=CubicVR.parseEnum(q.motion,
c)||0;a=CubicVR.parseEnum(q.motion,a)||0;this.controllers[a]===n&&(this.controllers[a]=[]);this.controllers[a][c]===n&&(this.controllers[a][c]=new s(this.env_init));return this.controllers[a][c]},evaluate:function(a){var c=[],b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){c[b]=[];for(var m in this.controllers[b])this.controllers[b].hasOwnProperty(m)&&(c[b][m]=this.controllers[b][m].evaluate(a))}return c},apply:function(a,c){for(var b in this.controllers)if(this.controllers.hasOwnProperty(b)){var m=
parseInt(b,10);if(this.yzflip&&m===q.motion.ROT){if(!this.q)this.q=new CubicVR.Quaternion;var f=this.q,d=this.controllers[b][0].evaluate(a),g=this.controllers[b][1].evaluate(a),n=this.controllers[b][2].evaluate(a);f.fromEuler(d,n,-g);f=f.toEuler();c.control(m,0,f[0]);c.control(m,1,f[1]);c.control(m,2,f[2])}else for(var w in this.controllers[b])this.controllers[b].hasOwnProperty(w)&&c.control(m,parseInt(w,10),this.controllers[b][w].evaluate(a))}},setKey:function(a,c,b,m,f){c=CubicVR.parseEnum(q.motion,
c)||0;a=CubicVR.parseEnum(q.motion,a)||0;return this.envelope(a,c).addKey(b,m,f?f:this.key_init)},setArray:function(a,c,b,m){var f=[],a=CubicVR.parseEnum(q.motion,a)||0,d;for(d in b)if(b.hasOwnProperty(d)){var g=this.envelope(a,CubicVR.parseEnum(q.motion,d));f[d]=g.addKey(c,b[d],m?m:this.key_init)}return f},setBehavior:function(a,c,b,m){var f=this.envelope(a,c);typeof b==="object"&&(m=b,b=m.in_behavior||m.inBehavior||m.behavior,m=m.out_behavior||m.outBehavior||m.behavior);CubicVR.parseEnum(q.motion,
c);CubicVR.parseEnum(q.motion,a);f.setBehavior(b,m)},setBehaviorArray:function(a,c,b){var a=CubicVR.parseEnum(q.motion,a)||0,m=this.controllers[a],f;for(f in m)m.hasOwnProperty(f)&&this.envelope(a,CubicVR.parseEnum(q.motion,f)||0).setBehavior(c,b)}};return{Motion:r,Envelope:s,EnvelopeKey:z}});
CubicVR.RegisterModule("Octree",function(u){function z(a,f,e,c,h){var m=this._children=[];this._dirty=!1;m[0]=null;m[1]=null;m[2]=null;m[3]=null;m[4]=null;m[5]=null;m[6]=null;m[7]=null;this._child_index=h||-1;this._root=e||null;this._max_depth=f||0;a=this._size=a||0;c=this._position=c||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[c[0],c[1],c[2],Math.sqrt(3*(this._size/2*this._size/2))];f=this._bbox=[[0,0,0],[0,0,0]];e=CubicVR.aabb;e.reset(f,c);a/=2;e.engulf(f,[c[0]+
a,c[1]+a,c[2]+a]);e.engulf(f,[c[0]-a,c[1]-a,c[2]-a]);this._debug_visible=!1}function s(){this.position=[0,0,0];this.visible=!1;this._object=null}function r(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var n=u.undef,q=CubicVR.plane,d=CubicVR.sphere,g=CubicVR.enums;g.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};g.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,f,e){e=a.slice((e||
f)+1||a.length);a.length=f<0?a.length+f:f;return a.push.apply(a,e)};z.prototype.destroy=function(){var a,f,e;a=0;for(f=this._static_lights.length;a<f;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(f=this._lights.length;a<f;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(f=this._children.length;a<f;++a)this._children[a]!==null&&this._children[a].destroy();a=
0;for(f=this._nodes.length;a<f;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};z.prototype.toString=function(){return"[Octree: @"+
this._position+", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};z.prototype.remove=function(b){var f=!1,e=this._nodes.length,c;c=e-1;for(e=this._nodes.length;c>=0;--c)if(b===this._nodes[c]){a(this._nodes,c);this.dirty_lineage();f=!0;break}if(!f)for(c=e-1;c>=0;--c)if(b===this._lights[c]){a(this._lights,c);this.dirty_lineage();break}};z.prototype.dirty_lineage=function(){this._dirty=
!0;this._root!==null&&this._root.dirty_lineage()};z.prototype.cleanup=function(){for(var a=this._children.length,f=0,e=0;e<a;++e){var c=this._children[e];if(c!==null){var h=!0;c._dirty===!0&&(h=c.cleanup());h?++f:this._children[e]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(f===0||a===0))return!1;return!0};z.prototype.insert_light=function(a){this.insert(a,!0)};z.prototype.propagate_static_light=function(a){var f,e;f=0;for(e=this._nodes.length;f<e;++f)this._nodes[f].static_lights.indexOf(a)===
-1&&this._nodes[f].static_lights.push(a);for(f=0;f<8;++f)this._children[f]!==null&&this._children[f].propagate_static_light(a)};z.prototype.collect_static_lights=function(a){var f,e;f=0;for(e=this._static_lights.length;f<e;++f)a.static_lights.indexOf(this._static_lights[f])===-1&&a.static_lights.push(this._static_lights[f]);for(f=0;f<8;++f)this._children[f]!==null&&this._children[f].collect_static_lights(a)};z.prototype.insert=function(a,f){function e(a,c,b,e){var m,h;if(b)if(c.method===g.light.method.STATIC){a._static_lights.indexOf(c)===
-1&&a._static_lights.push(c);b=0;for(m=a._nodes.length;b<m;++b)a._nodes[b].static_lights.indexOf(c)===-1&&a._nodes[b].static_lights.push(c);for(h=a._root;h!==null;){b=0;for(l=h._nodes.length;b<l;++b)m=h._nodes[b],m.static_lights.indexOf(c)===-1&&m.static_lights.push(c);h=h._root}}else a._lights.indexOf(c)===-1&&a._lights.push(c);else{a._nodes.push(c);b=0;for(m=a._static_lights.length;b<m;++b)c.static_lights.indexOf(a._static_lights[b])===-1&&c.static_lights.push(a._static_lights[b]);for(h=a._root;h!==
null;){b=0;for(m=h._static_lights.length;b<m;++b){var f=h._static_lights[b];c.static_lights.indexOf(f)===-1&&c.static_lights.push(f)}h=h._root}}c.octree_leaves.push(a);c.octree_common_root=e;e=CubicVR.aabb;e.engulf(c.octree_aabb,a._bbox[0]);e.engulf(c.octree_aabb,a._bbox[1])}f===n&&(f=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)e(this,a,f,this._root);else{var c=this._position,h,m,o,d,x,A,w;m=a.getAABB();w=[m[0][0],m[0][1],m[0][2]];var q=[m[1][0],m[1][1],
m[1][2]];h=w[0]<c[0]&&w[1]<c[1]&&w[2]<c[2];m=q[0]>c[0]&&w[1]<c[1]&&w[2]<c[2];x=w[0]<c[0]&&q[1]>c[1]&&w[2]<c[2];A=q[0]>c[0]&&q[1]>c[1]&&w[2]<c[2];o=w[0]<c[0]&&w[1]<c[1]&&q[2]>c[2];d=q[0]>c[0]&&w[1]<c[1]&&q[2]>c[2];w=w[0]<c[0]&&q[1]>c[1]&&q[2]>c[2];c=q[0]>c[0]&&q[1]>c[1]&&q[2]>c[2];if(h&&m&&x&&A&&o&&d&&w&&c)e(this,a,f,this),f?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var q=0,r=this._static_lights.length;q<r;++q){if(a.static_lights===n)a.static_lights=
[];a.static_lights.indexOf(this._static_lights[q])===-1&&a.static_lights.push(this._static_lights[q])}var q=this._size/2,r=this._size/4,s=0,v=this._position[0],t=this._position[1],u=this._position[2];h&&(h=[v-r,t-r,u-r],this._children[g.octree.TOP_NW]===null&&(this._children[g.octree.TOP_NW]=new z(q,this._max_depth-1,this,h,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,f),++s);m&&(h=[v+r,t-r,u-r],this._children[g.octree.TOP_NE]===null&&(this._children[g.octree.TOP_NE]=new z(q,this._max_depth-
1,this,h,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,f),++s);x&&(h=[v-r,t+r,u-r],this._children[g.octree.BOTTOM_NW]===null&&(this._children[g.octree.BOTTOM_NW]=new z(q,this._max_depth-1,this,h,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,f),++s);A&&(h=[v+r,t+r,u-r],this._children[g.octree.BOTTOM_NE]===null&&(this._children[g.octree.BOTTOM_NE]=new z(q,this._max_depth-1,this,h,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,f),++s);o&&(h=[v-r,t-r,
u+r],this._children[g.octree.TOP_SW]===null&&(this._children[g.octree.TOP_SW]=new z(q,this._max_depth-1,this,h,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,f),++s);d&&(h=[v+r,t-r,u+r],this._children[g.octree.TOP_SE]===null&&(this._children[g.octree.TOP_SE]=new z(q,this._max_depth-1,this,h,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,f),++s);w&&(h=[v-r,t+r,u+r],this._children[g.octree.BOTTOM_SW]===null&&(this._children[g.octree.BOTTOM_SW]=new z(q,this._max_depth-1,this,
h,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,f),++s);c&&(h=[v+r,t+r,u+r],this._children[g.octree.BOTTOM_SE]===null&&(this._children[g.octree.BOTTOM_SE]=new z(q,this._max_depth-1,this,h,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,f),++s);if(s>1||a.octree_common_root===null)a.octree_common_root=this}}};z.prototype.draw_on_map=function(a,f,e){function c(a,c,b,e,o){var d=a<b?a:b,g=c<e?c:e,a=a<b?b-a:a-b,c=c<e?e-c:c-e;f.save();if(o!==void 0)f.fillStyle=o,f.fillRect(h+
d,m+g,a,c);f.strokeRect(h+d,m+g,a,c);f.restore()}var h=a.width/2,m=a.height/2,o,d,g,A,w,q,r;if(e===n||e==="map")f.save(),this._debug_visible!==!1?(f.fillStyle="rgba(0,0,0,0)",f.strokeStyle="#FF0000"):(f.fillStyle="rgba(0,0,0,0)",f.strokeStyle="rgba(0,0,0,0)"),f.beginPath(),w=this._size/2,o=this._position[0],d=this._position[2],f.moveTo(h+o-w,h+d-w),f.lineTo(h+o-w,h+d+w),f.lineTo(h+o+w,h+d+w),f.lineTo(h+o+w,h+d-w),f.stroke(),f.fill(),f.restore();if(e===n||e==="objects"){f.save();w=0;for(r=this._nodes.length;w<
r;++w)q=this._nodes[w],f.fillStyle="#5500FF",f.strokeStyle=q.visible===!0&&q.culled===!1?"#FFFFFF":"#000000",f.beginPath(),o=q.aabb[0][0],d=q.aabb[0][2],g=q.aabb[1][0]-o,A=q.aabb[1][2]-d,f.rect(h+o,m+d,g,A),f.stroke();f.restore()}if(e===n||e==="lights"){w=0;for(r=this._lights.length;w<r;++w)A=this._lights[w],f.fillStyle=A.culled===!1&&A.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",f.strokeStyle="#FFFF00",f.beginPath(),q=A.distance,o=A.position[0],d=A.position[2],f.arc(h+o,m+
d,q,0,Math.PI*2,!0),f.closePath(),f.stroke(),f.fill(),f.beginPath(),o=A.aabb[0][0],d=A.aabb[0][2],g=A.aabb[1][0]-o,A=A.aabb[1][2]-d,f.rect(h+o,m+d,g,A),f.closePath(),f.stroke();w=0;for(r=this._static_lights.length;w<r;++w)A=this._static_lights[w],f.fillStyle=A.culled===!1&&A.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",f.strokeStyle="#FF66BB",f.beginPath(),q=A.distance,o=A.position[0],d=A.position[2],f.arc(h+o,m+d,q,0,Math.PI*2,!0),f.closePath(),f.stroke(),f.fill(),f.beginPath(),
o=A.aabb[0][0],d=A.aabb[0][2],g=A.aabb[1][0]-o,A=A.aabb[1][2]-d,f.rect(h+o,m+d,g,A),f.closePath(),f.stroke()}if(e!="lights"&&e!="objects"&&e!="map"){f.save();o=this._nodes;w=0;for(A=o.length;w<A;++w)if(q=o[w],q.name==e){f.strokeStyle="#FFFF00";f.lineWidth=3;f.beginPath();o=q.aabb[0][0];d=q.aabb[0][2];g=q.aabb[1][0]-o;A=q.aabb[1][2]-d;f.rect(h+o,m+d,g,A);f.closePath();f.stroke();o=q.octree_aabb;f.strokeStyle="#0000FF";c(o[0][0],o[0][2],o[1][0],o[1][2]);f.lineWidth=1;if(q.common_root!==null)f.strokeStyle=
"#00FF00";break}f.lineWidth=1;f.strokeStyle="#FFFF00";c(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");f.fill();f.restore()}w=0;for(r=this._children.length;w<r;++w)this._children[w]!==null&&this._children[w].draw_on_map(a,f,e)};z.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-this._size/2&&a[2]>=
this._position[2]-this._size/2};z.prototype.get_frustum_hits=function(a,f){var e={objects:[],lights:[]};if((f===n||f===!0)&&!this.contains_point(a.position)){if(d.intersects(a.frustum.sphere,this._sphere)===!1)return e;var c=a.frustum.contains_sphere(this._sphere);if(c===-1)return this._debug_visible=!1,e;else if(c===1)this._debug_visible=2,f=!1;else if(c===0)if(this._debug_visible=!0,c=a.frustum.contains_box(this._bbox),c===-1)return this._debug_visible=!1,e;else if(c===1)this._debug_visible=3,f=
!1}var h,m,c=0;for(h=this._nodes.length;c<h;++c)m=this._nodes[c],e.objects.push(m),m.dynamic_lights=[].concat(this._lights),m.was_culled=m.culled,m.culled=!1,m.drawn_this_frame=!1;this._debug_visible=this._lights.length>0?4:this._debug_visible;c=0;for(h=this._lights.length;c<h;++c)if(m=this._lights[c],m.visible===!0)e.lights.push(m),m.was_culled=m.culled,m.culled=!1;c=0;for(h=this._static_lights.length;c<h;++c)if(m=this._static_lights[c],m.visible===!0)m.culled=!1;for(c=0;c<8;++c)if(this._children[c]!==
null){h=this._children[c].get_frustum_hits(a,f);var o;m=0;for(o=h.objects.length;m<o;++m){e.objects.push(h.objects[m]);for(var g=h.objects[m].dynamic_lights,x=0,A=this._lights.length;x<A;++x)g.indexOf(this._lights[x])<0&&g.push(this._lights[x])}m=0;for(o=h.lights.length;m<o;++m)e.lights.indexOf(h.lights[m])<0&&e.lights.push(h.lights[m])}return e};z.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,f;a=0;for(f=this._nodes.length;a<f;++a)this._nodes[a].culled=!0;a=0;for(f=this._lights.length;a<
f;++a)this._lights[a].culled=!0;a=0;for(f=this._static_lights.length;a<f;++a)this._static_lights[a].culled=!0;a=0;for(f=this._children.length;a<f;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};s.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};s.prototype.attach=function(a){this._object=a};r.prototype.extract=function(a,f,e){var c=CubicVR.vec3;if(!(f===n||e===n)){var h=CubicVR.mat4.multiply(e,f),f=this._planes;f[g.frustum.plane.LEFT][0]=h[3]+h[0];f[g.frustum.plane.LEFT][1]=
h[7]+h[4];f[g.frustum.plane.LEFT][2]=h[11]+h[8];f[g.frustum.plane.LEFT][3]=h[15]+h[12];f[g.frustum.plane.RIGHT][0]=h[3]-h[0];f[g.frustum.plane.RIGHT][1]=h[7]-h[4];f[g.frustum.plane.RIGHT][2]=h[11]-h[8];f[g.frustum.plane.RIGHT][3]=h[15]-h[12];f[g.frustum.plane.TOP][0]=h[3]-h[1];f[g.frustum.plane.TOP][1]=h[7]-h[5];f[g.frustum.plane.TOP][2]=h[11]-h[9];f[g.frustum.plane.TOP][3]=h[15]-h[13];f[g.frustum.plane.BOTTOM][0]=h[3]+h[1];f[g.frustum.plane.BOTTOM][1]=h[7]+h[5];f[g.frustum.plane.BOTTOM][2]=h[11]+
h[9];f[g.frustum.plane.BOTTOM][3]=h[15]+h[13];f[g.frustum.plane.NEAR][0]=h[3]+h[2];f[g.frustum.plane.NEAR][1]=h[7]+h[6];f[g.frustum.plane.NEAR][2]=h[11]+h[10];f[g.frustum.plane.NEAR][3]=h[15]+h[14];f[g.frustum.plane.FAR][0]=h[3]-h[2];f[g.frustum.plane.FAR][1]=h[7]-h[6];f[g.frustum.plane.FAR][2]=h[11]-h[10];f[g.frustum.plane.FAR][3]=h[15]-h[14];for(var m=0;m<6;++m)q.normalize(f[m]);m=-f[g.frustum.plane.NEAR][3];f=f[g.frustum.plane.FAR][3]-m;e=f*(1/e[5]);e=c.subtract([0,0,m+f*0.5],[e,e,m+f]);e=c.length(e);
h=[h[3],h[9],h[10]];m=c.length(h);h=c.multiply(h,1/m);a=[a.position[0],a.position[1],a.position[2]];a=c.add(a,c.multiply(h,f*0.5));a=c.add(a,c.multiply(h,1));this.sphere=[a[0],a[1],a[2],e]}};r.prototype.contains_sphere=function(a){for(var f=CubicVR.vec3,e=this._planes,c=0;c<6;++c){var h=e[c],h=f.dot([h[0],h[1],h[2]],[a[0],a[1],a[2]])+h.d;this.last_in[c]=1;if(h<-a[3])return-1;if(Math.abs(h)<a[3])return 0}return 1};r.prototype.draw_on_map=function(a,f){var e=a.width/2,c=a.height/2;f.save();for(var h=
this._planes,m=[0,1,4,5],o=0,d=m.length;o<d;++o){var g=h[m[o]];f.strokeStyle="#FF00FF";if(o<this.last_in.length&&this.last_in[o])f.strokeStyle="#FFFF00";var n=-e,w=e,q=(-g[3]-g[0]*w)/g[2];f.moveTo(e+n,c+(-g[3]-g[0]*n)/g[2]);f.lineTo(e+w,c+q);f.stroke()}f.strokeStyle="#0000FF";f.beginPath();f.arc(e+this.sphere[0],c+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);f.closePath();f.stroke();f.restore()};r.prototype.contains_box=function(a){var f=0,e=[];e[0]=a[0];e[1]=[a[0][0],a[0][1],a[1][2]];e[2]=[a[0][0],
a[1][1],a[0][2]];e[3]=[a[0][0],a[1][1],a[1][2]];e[4]=[a[1][0],a[0][1],a[0][2]];e[5]=[a[1][0],a[0][1],a[1][2]];e[6]=[a[1][0],a[1][1],a[0][2]];e[7]=a[1];for(var a=this._planes,c=0;c<6;++c){for(var h=8,m=1,o=0;o<8;++o)q.classifyPoint(a[c],e[o])===-1&&(m=0,--h);this.last_in[c]=m;if(h===0)return-1;f+=m}if(f===6)return 1;return 0};return{Frustum:r,Octree:z}});
CubicVR.RegisterModule("Particles",function(u){function z(n,q,d,g,a,b,f){if(n){this.last_particle=this.particles=null;this.pTex=d!==s?d:null;this.vWidth=g;this.vHeight=a;this.alpha=b!==s?b:!1;this.alphaCut=f!==s?f:0;this.pfunc=function(a,c){var b=c-a.start_time;if(b<0)return 0;if(b>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+b*a.velocity[0]+b*b*a.accel[0];a.pos[1]=a.startpos[1]+b*a.velocity[1]+b*b*a.accel[1];a.pos[2]=a.startpos[2]+b*a.velocity[2]+b*b*a.accel[2];this.pgov!==null&&this.pgov(a,
c);return 1};this.pgov=null;this.hasColor=q===s?!1:q;d=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",d?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",d?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",d?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",d?"uniform sampler2D pMap;":"","varying vec4 color;",d?"varying vec2 screenPos;":"",d?"uniform vec3 screenDim;":"",d?"varying float pSize;":"","void main(void) {\nvec4 c = color;",d?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",d?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",d?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=n;this.numParticles=0;this.arPoints=new Float32Array(n*3);this.glPoints=null;if(q)this.arColor=new Float32Array(n*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[g,a,0]));this.genBuffer()}}var s=u.undef,r=u.GLCore;z.prototype={resizeView:function(n,q){this.vWidth=n;this.vHeight=q;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[n,q,0]))},addParticle:function(n){this.last_particle===null?this.particles=n:this.last_particle.nextParticle=n;this.last_particle=n},genBuffer:function(){var n=r.gl;this.glPoints=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW);if(this.hasColor)this.glColor=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW)},updatePoints:function(){var n=r.gl;n.bindBuffer(n.ARRAY_BUFFER,
this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW)},updateColors:function(){var n=r.gl;this.hasColor&&(n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW))},draw:function(n,q,d){var g=r.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(g.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",n);this.shader_particle.setMatrix("uPMatrix",q);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);
g.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(d!==s){this.numParticles=0;if(this.particles===null){g.disable(g.BLEND);return}for(var n=this.particles,q=null,a=0;n!==null;){var b=this.numParticles*
3,f=this.pfunc(n,d);if(f===1){if(this.arPoints[b]=n.pos[0],this.arPoints[b+1]=n.pos[1],this.arPoints[b+2]=n.pos[2],n.color!==null&&this.arColor!==s&&(this.arColor[b]=n.color[0],this.arColor[b+1]=n.color[1],this.arColor[b+2]=n.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(f===-1){if(q!==null)q.nextParticle=n.nextParticle}else f===0&&a++;q=n;n=n.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&
(g.enable(g.BLEND),g.enable(g.DEPTH_TEST),g.depthMask(0),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_COLOR));g.drawArrays(g.POINTS,0,this.numParticles);this.alpha&&(g.disable(g.BLEND),g.depthMask(1),g.blendFunc(g.ONE,g.ONE));this.hasColor&&g.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:z,Particle:function(n,q,d,g,a){this.startpos=new Float32Array(n);this.pos=new Float32Array(n);this.velocity=new Float32Array(g!==s?g:[0,0,0]);this.accel=new Float32Array(a!==s?a:[0,0,
0]);this.start_time=q!==s?q:0;this.life_time=d!==s?d:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("PostProcess",function(u){function z(a){if(a.shader_vertex===n)return null;if(a.shader_fragment===n)return null;this.outputMode=a.outputMode===n?d.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===n?null:a.onresize;this.onupdate=a.onupdate===n?null:a.onupdate;this.init=a.init===n?null:a.init;this.enabled=a.enabled===n?!0:a.enabled;this.outputDivisor=a.outputDivisor===n?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function s(a,f,e){var c=q.gl;this.width=a;this.height=f;this.accum=e===n?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,f,!0);this.bufferA=new CubicVR.RenderBuffer(a,f,!1);this.bufferB=new CubicVR.RenderBuffer(a,
f,!1);this.bufferC=new CubicVR.RenderBuffer(a,f,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,f,!1),this.accumBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT),this.blur_shader=new z({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.bufferB.use();c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new z({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,f)}function r(a,f,e){this.createBuffer(a,f,e)}var n=u.undef,q=u.GLCore,d=CubicVR.enums;d.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var g=[],a=[];s.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,f){var e=q.gl,c={},h=a/a,m=f/f;c.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);c.vbo_uvs=new Float32Array([0,0,h,0,h,m,0,m,0,0,h,m]);c.gl_points=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,
c.gl_points);e.bufferData(e.ARRAY_BUFFER,c.vbo_points,e.STATIC_DRAW);c.gl_uvs=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,c.gl_uvs);e.bufferData(e.ARRAY_BUFFER,c.vbo_uvs,e.STATIC_DRAW);return c},destroyFSQuad:function(a){var f=q.gl;f.deleteBuffer(a.gl_points);f.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,f){var e=q.gl;a.use();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindBuffer(e.ARRAY_BUFFER,f.gl_points);e.vertexAttribPointer(a.aVertex,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aVertex);
e.bindBuffer(e.ARRAY_BUFFER,f.gl_uvs);e.vertexAttribPointer(a.aTex,2,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aTex);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.drawArrays(e.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&b.outputDivisor!=1&&g[b.outputDivisor]===n){var f=this.width/b.outputDivisor|0,e=this.height/b.outputDivisor|0;g[b.outputDivisor]=new CubicVR.RenderBuffer(f,e,!1);a[b.outputDivisor]=
this.makeFSQuad(f,e)}},resize:function(b,f){var e=q.gl;this.width=b;this.height=f;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT));for(var c in g){var e=this.width/c|0,h=this.height/c|0;g[c].destroyBuffer();g[c].createBuffer(e,h,!1);this.destroyFSQuad(a[c]);a[c]=this.makeFSQuad(e,h)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;c=0;for(e=this.shaders.length;c<e;c++)if(this.shaders[c].shader.use(),this.shaders[c].shader.setVector("texel",this.vTexel),this.shaders[c].onresize!==null)this.shaders[c].onresize(this.shaders[c].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var f=q.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?f.clear(f.DEPTH_BUFFER_BIT|f.COLOR_BUFFER_BIT):f.clear(f.COLOR_BUFFER_BIT))},end:function(){var a=q.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=q.gl;this.captureBuffer.texture.use(b.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var f=0,e=0,c=this.shaders.length;e<c;e++){var h=this.shaders[e];if(h.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var m=h.outputMode;if(m===d.post.output.REPLACE)h.outputDivisor!==1?g[h.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(m===d.post.output.ADD||
m===d.post.output.BLEND)h.outputDivisor!==1?g[h.outputDivisor].use():this.bufferC.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);h.onupdate!==null&&(h.shader.use(),h.onupdate(h.shader));h.outputDivisor!==1?(b.viewport(0,0,g[h.outputDivisor].width,g[h.outputDivisor].height),this.renderFSQuad(h.shader,a[h.outputDivisor]),h.outputMode===d.post.output.REPLACE?(this.outputBuffer.use(),g[h.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(h.shader,this.fsQuad);m===d.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),h.outputDivisor!==1?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):m===d.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),
b.blendFunc(b.ONE,b.ONE),h.outputDivisor!==1?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();f++}}f===0?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};r.prototype={createBuffer:function(a,
f,e){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(f,10);var a=this.sizeParam(a),f=this.sizeParam(f),c=q.gl;this.fbo=c.createFramebuffer();if(e)this.depth=c.createRenderbuffer();c.bindFramebuffer(c.FRAMEBUFFER,this.fbo);e&&(c.bindRenderbuffer(c.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,a,f),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,this.depth)):
(c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_STENCIL,a,f),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;c.bindTexture(c.TEXTURE_2D,u.Textures[this.texture.tex_id]);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.texImage2D(c.TEXTURE_2D,
0,c.RGBA,a,f,0,c.RGBA,c.UNSIGNED_BYTE,null);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,u.Textures[this.texture.tex_id],0);c.bindFramebuffer(c.FRAMEBUFFER,null)},destroyBuffer:function(){var a=q.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(u.Textures[this.texture.tex_id]);u.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=q.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:r,PostProcessShader:z,PostProcessChain:s,fsQuad:{make:s.prototype.makeFSQuad,destroy:s.prototype.destroyFSQuad,render:s.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Polygon",function(u){function z(a){var b=[],m=a.length;if(m<3)return null;var f=[],d;d=a.length;for(var g=0,n=d-1,w=0;w<d;n=w++)g+=a[n][0]*a[w][1]-a[w][0]*a[n][1];if(0<g*0.5)for(d=0;d<m;d++)f[d]=d;else for(d=0;d<m;d++)f[d]=m-1-d;w=2*m;g=0;for(d=m-1;m>2;){if(0>=w--)return null;var q=d;m<=q&&(q=0);d=q+1;m<=d&&(d=0);n=d+1;m<=n&&(n=0);var r;a:{r=a;var s=q,v=d,t=n,u=m,D=f,B=void 0,z=void 0,I=void 0,F=void 0,E=void 0,G=void 0,N=void 0,J=void 0,S=void 0,z=r[D[s]][0],I=r[D[s]][1],
F=r[D[v]][0],E=r[D[v]][1],G=r[D[t]][0],N=r[D[t]][1];if(e>(F-z)*(N-I)-(E-I)*(G-z))r=!1;else{for(B=0;B<u;B++)if(!(B==s||B==v||B==t)){var J=r[D[B]][0],S=r[D[B]][1],V=void 0,L=void 0,P=void 0,M=void 0,R=void 0,X=void 0,Z=void 0,Q=void 0,$=void 0,T=void 0,U=void 0,W=void 0,V=P=R=void 0,V=G-F,L=N-E,P=z-G,M=I-N,R=F-z,X=E-I,Z=J-z,Q=S-I,$=J-F,T=S-E,U=J-G,W=S-N,V=V*T-L*$,R=R*Q-X*Z,P=P*W-M*U;if(V>=0&&P>=0&&R>=0){r=!1;break a}}r=!0}}if(r){w=f[q];q=f[d];n=f[n];b.push(w);b.push(q);b.push(n);g++;n=d;for(w=d+1;w<
m;n++,w++)f[n]=f[w];m--;w=2*m}}return b}function s(a,b,e){e===f&&(e=0);var d;d=z(b);var g=CubicVR.util.repackArray(d,3,d.length/3),x=[],n=a.points.length;d=0;for(iMax=b.length;d<iMax;d++)x.push([b[d][0],b[d][1],e]);a.addPoint(x);d=0;for(iMax=g.length;d<iMax;d++)a.addFace([g[d][0]+n,g[d][1]+n,g[d][2]+n])}function r(a,b){var e=b[0]-a[0],f=b[1]-a[1];return Math.sqrt(e*e+f*f)}function n(a,b){var e,f,d=[],g=a.length,n=b.length,w=[];for(e=0;e<g;e++)for(f=0;f<n;f++){var q=r(a[e],b[f]);d.push([q,e,f])}d.sort(function(a,
c){return a[0]>c[0]});for(e=0;e<5;e++)for(f=0;f<d.length;f++)e!=f&&d[e][1]!=d[f][1]&&d[e][2]!=d[f][2]&&d[e][1]<d[f][1]&&d[e][2]<d[f][2]&&Math.abs(d[e][1]-d[f][1])<4&&Math.abs(d[e][2]-d[f][2])<4&&w.push([e,f]);w.sort(function(a,c){return d[a[0]][0]+d[a[1]][0]>d[c[0]][0]+d[c[1]][0]});if(w.length>10)w.length=10;f=[];for(e=0;e<w.length;e++)f.push([d[w[e][0]],d[w[e][1]]]);return f}function q(a,b){var e=n(a,b),f;if(!e.length)return null;f=e[0][0];var d=e[0][1],e=d[1]-f[1],d=d[2]-f[2],g=a.slice(f[1]),g=
g.concat(a.slice(0,f[1])),q=b.slice(f[2]),q=q.concat(b.slice(0,f[2])),w=[];for(f=e;f<g.length;f++)w.push(g[f]);w.push(g[0]);for(f=d;f<q.length;f++)w.push(q[f]);w.push(q[0]);var r=[];for(f=0;f<=e;f++)r.push(g[f]);for(f=0;f<=d;f++)r.push(q[f]);return[w,r]}function d(a){for(var b=[0,0],e=0;e<a.length;e++)b[0]+=a[e][0],b[1]+=a[e][1];b[0]/=a.length;b[1]/=a.length;return b}function g(a,b,e){for(var f=[],d=0;d<a.length;d++){var g=[a[d][0]-b[0],a[d][1]-b[1]],n=Math.sqrt(g[0]*g[0]+g[1]*g[1])+e,g=Math.atan2(g[1],
g[0]);f[d]=[b[0]+Math.cos(g)*n,b[1]+Math.sin(g)*n]}return f}function a(a,b,e,f,d){var g,n=a.points.length;if(b.length!=e.length)return null;var w=b.length;for(g=0;g<w;g++)a.addPoint([b[g][0],b[g][1],f]);for(g=0;g<w;g++)a.addPoint([e[g][0],e[g][1],d]);for(g=0;g<w-1;g++)a.addFace([n+g,n+g+1,n+(g+w+1),n+(g+w)]);g=w-1;a.addFace([n+g,n,n+w,n+(g+w)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var f=u.undef,e=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},toMesh:function(a){if(this.points.length!==
0){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var e=this.cuts[b].points.slice(0),e=e.reverse(),e=q(this.result[0],e);this.result[0]=e[0];this.result.push(e[1])}for(b=0;b<this.result.length;b++)s(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(c,b,e){if(this.points.length!==0){var d,g;b===f&&(b=0);e===f&&(e=0);var x=b!=e;c||(c=new CubicVR.Mesh);this.result=[this.points];for(g=0;g<this.cuts.length;g++)d=this.cuts[g].points.slice(0),
d=d.reverse(),d=q(this.result[0],d),this.result[0]=d[0],this.result.push(d[1]);d=new CubicVR.Mesh;for(g=0;g<this.result.length;g++)s(d,this.result[g],e);c.booleanAdd(d);d.flipFaces();if(x)for(g=0;g<d.points.length;g++)d.points[g][2]=b;c.booleanAdd(d);if(x){a(c,this.points,this.points,b,e);for(g=0;g<this.cuts.length;g++)d=this.cuts[g].points.slice(0),d=d.reverse(),a(c,d,d,b,e)}c.removeDoubles();return c}},toExtrudedBeveledMesh:function(c,b,e,f,n,x,r){var w=[],C=[],u,H,v,t;if(this.points.length!==0){typeof b===
"object"&&(r=b,b=r.front||0,e=r.back||0,f=r.frontDepth||0,n=r.frontShift||0,x=r.backDepth||0,r=r.backShift||0);var z=b!==e,D=x!==0,B=f!==0;c||(c=new CubicVR.Mesh);B?(H=d(this.points),H=g(this.points,H,-n),this.result=[H.slice(0)]):this.result=[this.points.slice(0)];for(t=0;t<this.cuts.length;t++)v=d(this.cuts[t].points),v=g(this.cuts[t].points,v,n),v=v.reverse(),w.push(v),v=q(this.result[0],v),this.result[0]=v[0],this.result.push(v[1]);n=new CubicVR.Mesh;for(t=0;t<this.result.length;t++)s(n,this.result[t],
b-f);n.flipFaces();c.booleanAdd(n);if(D||B){u=d(this.points);u=g(this.points,u,-r);this.result=[u.slice(0)];for(t=0;t<this.cuts.length;t++)v=d(this.cuts[t].points),v=g(this.cuts[t].points,v,r),v=v.reverse(),C.push(v),v=q(this.result[0],v),this.result[0]=v[0],this.result.push(v[1]);n=new CubicVR.Mesh;for(t=0;t<this.result.length;t++)s(n,this.result[t],e+x)}else{for(t=0;t<n.points.length;t++)n.points[t][2]=e;n.flipFaces()}c.booleanAdd(n);B&&a(c,H,this.points,b-f,b);z&&a(c,this.points,this.points,b,
e);D&&a(c,this.points,u,e,e+x);for(t=0;t<w.length;t++)v=this.cuts[t].points.slice(0).reverse(),B&&a(c,w[t],v,b-f,b),z&&a(c,v,v,b,e),D&&a(c,v,C[t],e,e+x);c.removeDoubles();return c}}};return{polygon:{triangulate2D:z,toMesh:s,findNearPair:function(a,b){for(var e=[0,0],f=r(a[0],b[0]),d=a.length,g=b.length,n=0;n<d;n++)for(var w=0;w<g;w++){var q=r(a[n],b[w]);q<f&&(e[0]=n,e[1]=w,f=q)}return e},subtract:q,addOffset:function(a,b){for(var e=[],f=0,d=a.length;f<d;f++){var g=a[f];e.push([g[0]+b[0],g[1]+b[1]])}return e}},
Polygon:b}});
CubicVR.RegisterModule("Primitives",function(u){function z(a,b,f,h,d,g){var n=CubicVR.mat4,q=CubicVR.vec3,r=[],v,t=[0,1,0],s=[1,0,0],u=[0,0,0],B=a.points.length,z,I,F;for(z=v=0;z<c;z+=c/f){if(v===f)break;s=[Math.cos(z),0,Math.sin(z)];I=0;for(F=b.length;I<F;I++)u=q.add(q.multiply(s,b[I][0]),q.multiply(t,b[I][1])),r[v]===e&&(r[v]=[]),r[v].push(u);v++}F=null;d!==e&&(F=d.getResult!==e?d.getResult():d);for(I=0;I<f;I++){d=0;for(v=b.length;d<v;d++)F?a.addPoint(n.vec3_multiply(r[I][d],F)):a.addPoint(r[I][d])}typeof h==="string"&&
(h=new CubicVR.Material(h));a.setFaceMaterial(h);for(d=0;d<f;d++){I=0;for(F=b.length-1;I<F;I++)n=I+b.length*d,r=I+b.length*((d+1)%f),q.equal(a.points[B+n],a.points[B+r])?a.addFace([B+n+1,B+r+1,B+r]):q.equal(a.points[B+n+1],a.points[B+r+1])?a.addFace([B+n,B+n+1,B+r]):a.addFace([B+n,B+n+1,B+r+1,B+r])}g!==e&&(b=null,g.apply!==e?b=g:g&&(b=new CubicVR.UVMapper(g)),b!==null&&(a.calcFaceNormals(),b.apply(a,h)))}function s(a,c,b,f,h){var d=CubicVR.mat4;c*=0.5;var g=a.points.length;typeof b==="string"&&(b=
new CubicVR.Material(b));a.setFaceMaterial(b);f!==e?(f=f.getResult!==e?f.getResult():f,a.addPoint([d.vec3_multiply([c,-c,0],f),d.vec3_multiply([c,c,0],f),d.vec3_multiply([-c,c,0],f),d.vec3_multiply([-c,-c,0],f)])):a.addPoint([[c,-c,0],[c,c,0],[-c,c,0],[-c,-c,0]]);a.addFace([[g+0,g+1,g+2,g+3],[g+3,g+2,g+1,g+0]]);h!==e&&(d=null,h.apply!==e?d=h:h&&(d=new CubicVR.UVMapper(h)),d!==null&&(a.calcFaceNormals(),d.apply(a,b)))}function r(a,c,b,f,d){var h=CubicVR.mat4,g,n;typeof c==="object"?(g=c[0]/2,n=c[1]/
2,c=c[2]/2):g=n=c/=2;var q=a.points.length;typeof b==="string"&&(b=new CubicVR.Material(b));a.setFaceMaterial(b);f!==e?(f=f.getResult!==e?f.getResult():f,a.addPoint([h.vec3_multiply([g,-n,c],f),h.vec3_multiply([g,n,c],f),h.vec3_multiply([-g,n,c],f),h.vec3_multiply([-g,-n,c],f),h.vec3_multiply([g,-n,-c],f),h.vec3_multiply([g,n,-c],f),h.vec3_multiply([-g,n,-c],f),h.vec3_multiply([-g,-n,-c],f)])):a.addPoint([[g,-n,c],[g,n,c],[-g,n,c],[-g,-n,c],[g,-n,-c],[g,n,-c],[-g,n,-c],[-g,-n,-c]]);a.addFace([[q+
0,q+1,q+2,q+3],[q+7,q+6,q+5,q+4],[q+4,q+5,q+1,q+0],[q+5,q+6,q+2,q+1],[q+6,q+7,q+3,q+2],[q+7,q+4,q+0,q+3]]);d!==e&&(h=null,d.apply!==e?h=d:d&&(h=new CubicVR.UVMapper(d)),h!==null&&(a.calcFaceNormals(),h.apply(a,b)))}function n(a,b,e,f,h,d,g,n){var q=[];e-=b;b+=e/2;for(var r=c/h,t=0,s=0;s<=h;s++)q.push([b+Math.cos(t)*e,Math.sin(t)*e,0]),t+=r;CubicVR.genLatheObject(a,q,f,d,g,n)}function q(a,c,b,e,f,h,d){CubicVR.genLatheObject(a,[[0,-b/2,0],[c/2,-b/2,0],[0,b/2,0]],e,f,h,d)}function d(a,c,b,e,f,h,d){CubicVR.genLatheObject(a,
[[0,-b/2,0],[c,-b/2,0],[c,b/2,0],[0,b/2,0]],e,f,h,d)}function g(a,c,b,e,f,d,g){var n=[],e=(e/=2)|0;b|=0;for(var q=Math.PI/e,r=-h,t=0;t<=e;t++)n.push([Math.cos(r)*c,Math.sin(r)*c,0]),r+=q;CubicVR.genLatheObject(a,n,b,f,d,g)}function a(a){typeof a==="string"&&(a=CubicVR.get(a,CubicVR.Material));if(a===e)return new CubicVR.Material;return a.use?a:typeof a==="object"?new CubicVR.Material(a):new CubicVR.Material}function b(a){if(a===e)return e;if(typeof a==="array")return a;if(typeof a==="object")return a.getResult?
a.getResult():a.position||a.rotation||a.scale?CubicVR.mat4.transform(a.position,a.rotation,a.scale):e}function f(a){typeof a==="string"&&(a=CubicVR.get(a));if(a===e)return e;return a.apply?a:typeof a==="object"?new CubicVR.UVMapper(a):e}var e=u.undef,c=2*Math.PI,h=Math.PI/2;return{genPlaneObject:s,genBoxObject:r,genLatheObject:z,genTorusObject:n,genConeObject:q,genCylinderObject:d,genSphereObject:g,primitives:{lathe:function(c){var h,d,g,n;if(c.points==e)return null;h=c.mesh!==e?c.mesh:new CubicVR.Mesh(c.name!==
e?c.name:e);d=a(c.material);g=b(c.transform);n=f(c.uvmapper||c.uv);z(h,c.points,c.divisions!==e?c.divisions:24,d,g,n);return h},box:function(c){var h,d,g,n;h=c.mesh!==e?c.mesh:new CubicVR.Mesh(c.name!==e?c.name:e);d=a(c.material);g=b(c.transform);n=f(c.uvmapper||c.uv);r(h,c.size!==e?c.size:1,d,g,n);return h},plane:function(c){var h,d,g,n;h=c.mesh!==e?c.mesh:new CubicVR.Mesh(c.name!==e?c.name:e);d=a(c.material);g=b(c.transform);n=f(c.uvmapper||c.uv);s(h,c.size!==e?c.size:1,d,g,n);return h},sphere:function(c){var h,
d,x,n;h=c.mesh!==e?c.mesh:new CubicVR.Mesh(c.name!==e?c.name:e);d=a(c.material);x=b(c.transform);n=f(c.uvmapper||c.uv);g(h,c.radius!==e?c.radius:1,c.lon!==e?c.lon:24,c.lat!==e?c.lat:24,d,x,n);return h},torus:function(c){var h,d,g,q;h=c.mesh!==e?c.mesh:new CubicVR.Mesh(c.name!==e?c.name:e);d=a(c.material);g=b(c.transform);q=f(c.uvmapper||c.uv);n(h,c.innerRadius!==e?c.innerRadius:0.75,c.outerRadius!==e?c.outerRadius:1,c.lon!==e?c.lon:24,c.lat!==e?c.lat:24,d,g,q);return h},cone:function(c){var h,d,g,
n;h=c.mesh!==e?c.mesh:new CubicVR.Mesh(c.name!==e?c.name:e);d=a(c.material);g=b(c.transform);n=f(c.uvmapper||c.uv);q(h,c.base!==e?c.base:1,c.height!==e?c.height:1,c.lon!==e?c.lon:24,d,g,n);return h},cylinder:function(c){var h,g,x,n;h=c.mesh!==e?c.mesh:new CubicVR.Mesh(c.name!==e?c.name:e);g=a(c.material);x=b(c.transform);n=f(c.uvmapper||c.uv);d(h,c.radius!==e?c.radius:1,c.height!==e?c.height:1,c.lon!==e?c.lon:24,g,x,n);return h}}}});
CubicVR.RegisterModule("Renderer",function(u){var z=u.undef;return{renderObject:function(s,r,n,q,d,g,a){var b=!1,d=d||!1,g=g||!1;if(s.compiled!==null){var f=0,e=CubicVR.GLCore.gl,c,h=q===z?0:q.length,m,o=0,y,x=null,A=s.instanceMaterials||s.materials,w=(a=(s.wireframe||a)&&s.compiled.line_elements_ref)?s.compiled.line_elements_ref:s.compiled.elements_ref,C=!1,O,H,v;e.depthFunc(e.LEQUAL);n===z&&(n=cubicvr_identity);for(var t=0,K=w.length;t<K;t++){var x=a&&s.wireframeMaterial?s.wireframeMaterial:A[t],
D=0,o=!1;if(x.opacity<1&&d)b=!0;else if(!(g&&x.opacity>=1)){x.opacity!==1?(e.enable(e.BLEND),e.depthMask(0),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)):(e.depthMask(1),e.disable(e.BLEND),e.blendFunc(e.ONE,e.ONE));for(var B=0,Y=w[t].length;B<Y;B++)if(y=w[t][B][0],o=!1,c=w[t][B][1],D+=c,!s.segment_state[y])if(D>c){f+=c*2;D-=c;if(h){H=!1;for(O=0;O<h;){c=h-O;if(c>u.MAX_LIGHTS)c=u.MAX_LIGHTS;O>0&&!H&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),H=!0);m=q[O];v=m.light_type;for(o=
0;o<c;o++)if(q[o+O].light_type!=v){c=o;break}x.use(m.light_type,c);m=x.shader[m.light_type][c];e.uniformMatrix4fv(m.matrixModelView,!1,r.mvMatrix);e.uniformMatrix4fv(m.matrixProjection,!1,r.pMatrix);e.uniformMatrix4fv(m.matrixObject,!1,n);e.uniformMatrix3fv(m.matrixNormal,!1,r.nMatrix);C||(x.bindObject(s,m),C=m.vertexTexCoord!=-1,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.compiled.gl_line_elements));for(o=0;o<c;o++)q[o+O].setupShader(m,o);a?e.drawElements(e.LINES,D,e.UNSIGNED_SHORT,f):e.drawElements(e.TRIANGLES,
D,e.UNSIGNED_SHORT,f);O+=c}H&&(e.disable(e.BLEND),e.depthFunc(e.LEQUAL))}else x.use(0,0),e.uniformMatrix4fv(x.shader[0][0].matrixModelView,!1,r.mvMatrix),e.uniformMatrix4fv(x.shader[0][0].matrixProjection,!1,r.pMatrix),e.uniformMatrix4fv(x.shader[0][0].matrixObject,!1,n),e.uniformMatrix3fv(x.shader[0][0].matrixNormal,!1,r.nMatrix),C||(x.bindObject(s,x.shader[0][0]),C=x.shader[0][0].vertexTexCoord!=-1,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.compiled.gl_line_elements)),a?e.drawElements(e.LINES,D,e.UNSIGNED_SHORT,
f):e.drawElements(e.TRIANGLES,D,e.UNSIGNED_SHORT,f);f+=D*2;D=0;o=!0}else f+=D*2,D=0;if(!o&&s.segment_state[y]){if(h){H=!1;for(O=0;O<h;){c=h-O;if(c>u.MAX_LIGHTS)c=u.MAX_LIGHTS;O>0&&!H&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),H=!0);m=q[O];v=m.light_type;for(o=0;o<c;o++)if(q[o+O].light_type!=v){c=o;break}x.use(m.light_type,c);m=x.shader[m.light_type][c];e.uniformMatrix4fv(m.matrixModelView,!1,r.mvMatrix);e.uniformMatrix4fv(m.matrixProjection,!1,r.pMatrix);e.uniformMatrix4fv(m.matrixObject,
!1,n);e.uniformMatrix3fv(m.matrixNormal,!1,r.nMatrix);C||(x.bindObject(s,m),C=m.vertexTexCoord!=-1,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.compiled.gl_line_elements));for(o=0;o<c;o++)q[o+O].setupShader(m,o);a?e.drawElements(e.LINES,D,e.UNSIGNED_SHORT,f):e.drawElements(e.TRIANGLES,D,e.UNSIGNED_SHORT,f);O+=c}H&&(e.disable(e.BLEND),e.depthFunc(e.LEQUAL))}else x.use(0,0),e.uniformMatrix4fv(x.shader[0][0].matrixModelView,!1,r.mvMatrix),e.uniformMatrix4fv(x.shader[0][0].matrixProjection,!1,r.pMatrix),
e.uniformMatrix4fv(x.shader[0][0].matrixObject,!1,n),e.uniformMatrix3fv(x.shader[0][0].matrixNormal,!1,r.nMatrix),C||(x.bindObject(s,x.shader[0][0]),C=x.shader[0][0].vertexTexCoord!=-1,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.compiled.gl_line_elements)),a?e.drawElements(e.LINES,D,e.UNSIGNED_SHORT,f):e.drawElements(e.TRIANGLES,D,e.UNSIGNED_SHORT,f);f+=D*2}}}x&&m?x.clearObject(s,m):x.clearObject(s,null);e.depthMask(1);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return b}}}});
CubicVR.RegisterModule("EventHandler",function(u){function z(g){g=CubicVR.parseEnum(q.event,g);if(g===n)return d("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1;if(!isNaN(parseInt(g,10))&&(g>=q.event.EVENT_MAX||g<0))return d("Unknown event ID passed: "+g),!1;return g}function s(d){d=d||{};this.name=d.name;d.id=z(d.id)||q.event.TICK;this.id=d.id;this.interval=d.interval||0;this.enabled=
d.enabled||!0;this.action=d.action||null;this.properties=d.properties||{};this.event_properties=d.event_properties||{};this.buffered=d.buffered||!1;this.weight=d.weight===n?-1:d.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function r(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}
var n=u.undef,q=CubicVR.enums,d=u.log;q.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};s.prototype={getName:function(){return this.name},setName:function(d){this.name=d},getSubject:function(){return this.subject},setSubject:function(d){this.subject=d},getId:function(){return this.id},setId:function(d){this.id=d},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},
enable:function(){this.setEnabled(!0)},setEnabled:function(d){if(d&&!this.enabled)this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1;this.enabled=d},isBuffered:function(){return this.buffered},setBuffered:function(d){this.buffered=d},setInterval:function(d){this.interval=d},getInterval:function(){return this.interval},setAction:function(d){this.action=d},getAction:function(){return this.action},getProperties:function(){return this.properties},
setProperties:function(d){this.properties=d},getProperty:function(d){return this.properties[d]},setProperty:function(d,a){this.properties[d]=a},setEventProperties:function(d){this.event_properties=d},getEventProperties:function(){return this.event_properties},getEventProperty:function(d){return this.event_properties[d]},setEventProperty:function(d,a){this.properties[d]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},
getSeconds:function(){return this.getTimeUpdated()},getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(d){this.t_rest=d},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(d){this.setRestInterval(d||0)},awake:function(){this.t_rest=0},update:function(d,a){if(!this.enabled)return!1;var b=0,f=!0;if(this.n_updates===0)this.t_updatecall=
this.t_update=d,b=1/60;else if(d!==this.t_update){if(!this.t_rest)this.t_last=d-this.t_update,this.t_update=d;b=d-this.t_updatecall;this.t_updatecall=d}else f=!1;if(this.t_rest>0){if(f&&(this.t_resting+=b,this.t_rest-=b,this.t_rest<0))this.t_rest=0}else{if(f){this.t_active+=this.t_last;if(!this.t_rest&&this.interval)this.t_rest=this.interval;this.n_updates++}this.callEvent(a);return!0}f&&this.n_updates++;return!1},callEvent:function(d){if(!this.action)return!1;return this.action(this,d)}};r.prototype=
{addEvent:function(d){d.callEvent||(d=new s(d));var a=d.getId();this.eventProperties[a]||(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(d);this.listenerNames.indexOf(a)===-1&&this.listenerNames.push(a);return d},removeEvent:function(d){if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(d)==-1&&this.lockRemovals.push(d)}else{var a=this.events.indexOf(d);a!==-1&&(d=d.getId(),this.events.splice(a,1),this.listeners[d]--,
this.listeners[d]||(this.eventHandled[d]=!0,this.eventParameters[d]={},this.eventProperties[d]=[],this.eventPropertyCount[d]=0,a=this.listenerNames.indexOf(d),a>=0&&this.listenerNames.splice(a,1)))}},getProperties:function(d){this.eventParameters[d]=this.eventParameters[d]||{};return this.eventParameters[d]},setProperties:function(d,a){this.eventParameters[d]=a},getProperty:function(d,a){return this.getProperties(d)[a]},setProperty:function(d,a,b){this.getProperties(d)[a]=b},hasEvent:function(d){return!!this.listeners[d]},
triggerEvent:function(d,a){if(!this.listeners[d])return null;this.eventProperties[d]==n&&(this.eventProperties[d]=[]);var b=this.eventProperties[d];this.eventPropertyCount[d]===n&&(this.eventPropertyCount[d]=0);var f=this.eventPropertyCount[d];f>20&&console.log("Warning, event "+d+" count > 20: "+f);b[f]=a&&b?a:b[f]||{};this.eventPropertyCount[d]++;this.eventHandled[d]=!1;return b[f]},update:function(d){var a,b,f,e,c,h;if(this.hasEvent(q.event.TICK)&&this.eventPropertyCount[q.event.TICK]===0&&(a=
this.triggerEvent(q.event.TICK)))a.time=d,a.handler=this;this.lockState=!0;a=0;for(b=this.events.length;a<b;a++){c=this.events[a];h=c.getId();e=this.eventPropertyCount[h];var m=!1;f=!1;if(e){var o=this.eventProperties[h];if(c.isEnabled()){if(c.isBuffered()){if(o.length=e,c.setEventProperties(o),m=m||c.update(d,this),c.isChainBroken()){c.breakChain(!1);break}}else for(f=0;f<e;f++)if(c.setEventProperties(o[a]),m=m||c.update(d,this),c.isChainBroken()){c.breakChain(!1);break}f=!0}}if(m||!f)this.eventHandled[h]=
!0}a=0;for(b=this.listenerNames.length;a<b;a++)h=this.listenerNames[a],this.eventHandled[h]&&(this.eventPropertyCount[h]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){a=0;for(b=this.lockRemovals.length;a<b;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:s,EventHandler:r,registerEvent:function(g){g=g.toUpperCase();q.event[g]!==n?d("Error, event '"+g+"' is already registered."):(q.event[g]=q.event.ENUM_MAX,q.event.ENUM_MAX++)},validateEvent:z}});
CubicVR.RegisterModule("Scene",function(u){function z(a,b){return a.light_type-b.light_type}function s(c,e){var d=null,f;c!==q&&c!==null?c.compile?d={}:(d=CubicVR.get(c)||{},c=null):d={};this.morphWeight=d.morphWeight||0;this.morphSource=d.morphSource||-1;this.morphTarget=d.morphTarget||-1;this.position=d.position===q?[0,0,0]:d.position;this.rotation=d.rotation===q?[0,0,0]:d.rotation;this.scale=d.scale===q?[1,1,1]:d.scale;this.shadowCast=d.shadowCast===q?!0:d.shadowCast;this.wireframe=d.wireframe||
!1;this.motion=d.motion===q?null:CubicVR.get(d.motion,CubicVR.Motion)||null;this.obj=!d.mesh?c?CubicVR.get(c,CubicVR.Mesh):null:CubicVR.get(d.mesh,CubicVR.Mesh);this.name=d.name===q?e!==q?e:null:d.name;this.properties=CubicVR.get(d.properties)||{};this.parent=this.children=null;var g=d.children||d.child||d.sceneObject||d.sceneObjects;if(g){if(g&&!g.length||typeof g==="string")g=[g];if(g.length){d=0;for(f=g.length;d<f;d++)this.bindChild(CubicVR.get(g[d],CubicVR.SceneObject))}}this.drawn_this_frame=
!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null}function r(a,b,d,f,g,x){this.frames=0;this.sceneObjects=
[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if(typeof a==="object"||typeof a==="string"){a=CubicVR.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+e;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};
this.disable=a.disable||function(){};b=a.setup&&a.setup(this)||{};this.update=b.update||this.update;this.enable=b.enable||this.enable;this.disable=b.disable||this.disable;this.destroy=b.destroy||this.destroy;if((f=a.sceneObjects||a.sceneObject||a.objects)&&!f.length||typeof f==="string")f=[f];if(f&&f.length){b=0;for(d=f.length;b<d;b++)this.bindSceneObject(CubicVR.get(f[b],CubicVR.SceneObject))}if((f=a.lights||a.light)&&!f.length||typeof f==="string")f=[f];if(f&&f.length){b=0;for(d=f.length;b<d;b++)this.bindLight(CubicVR.get(f[b],
CubicVR.Light))}if((f=a.cameras||a.camera)&&!f.length||typeof f==="string")f=[f];if(f&&f.length){b=0;for(d=f.length;b<d;b++)this.bindCamera(CubicVR.get(f[b],CubicVR.Camera));this.camera=this.cameras[0]}if(!f)this.camera=new CubicVR.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip)}else this.skybox=null,this.octree=x,this.name="scene"+e,this.camera=new CubicVR.Camera(a,b,d,f,g),this.wireframe=!1;this.paused=!1;++e}function n(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr=
{};this.meshBinPtr={}}var q=u.undef,d=CubicVR.enums,g=u.GLCore,a=CubicVR.aabb,b=CubicVR.mat4,f=0;s.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){if(!this.eventHandler)this.eventHandler=new CubicVR.EventHandler;a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},
setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=this.obj.materials[a].clone();
return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),e=0,d=b.length;e<d;e++)if(b[e].name==a)return b[e];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:
0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){if(a){if(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(d.event.MATRIX_UPDATE)))a.triggerEvent(d.event.MATRIX_UPDATE).matrix=this.tMatrix}else this.matrixLock=!1},doTransform:function(a){var e=CubicVR.vec3;if(!this.matrixLock&&(!e.equal(this.lposition,this.position)||!e.equal(this.lrotation,this.rotation)||!e.equal(this.lscale,this.scale)||
a!==q))if(a!==q?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===1&&this.scale[1]===1&&this.scale[2]===1||b.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=
this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(d.event.MOVE)))a=a.triggerEvent(d.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale},adjust_octree:function(){var c=
this.getAABB(),b=this.octree_aabb,e=c[0][0],d=c[0][1],f=c[0][2],g=c[1][0],n=c[1][1],w=c[1][2],r=b[0][0],s=b[0][1],u=b[0][2],v=b[1][0],t=b[1][1],b=b[1][2];if(this.octree_leaves.length>0&&(e<r||d<s||f<u||g>v||n>t||w>b)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(e!==null){for(;;)if(!e.contains_point(c[0])||!e.contains_point(c[1]))if(e._root!==q&&e._root!==null)e=e._root;
else break;else break;a.reset(this.octree_aabb,this.position);e.insert(this)}}},bindChild:function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,e){a===d.motion.POS?this.position[b]=e:a===d.motion.SCL?this.scale[b]=e:a===d.motion.ROT&&(this.rotation[b]=e)},getAABB:function(){var a=CubicVR.mat4,b=CubicVR.vec3;if(this.dirty){var e=Array(8);this.doTransform();var d,f;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),
b.add([1,1,1],this.position)];d=this.obj.bb[0];f=this.obj.bb[1]}if(!this.obj||d===q||f===q)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var g=d;d=b.subtract(f,d);e[0]=[g[0],g[1],g[2]];e[1]=[g[0],g[1],g[2]+d[2]];e[2]=[g[0]+d[0],g[1],g[2]];e[3]=[g[0]+d[0],g[1],g[2]+d[2]];e[4]=[g[0],g[1]+d[1],g[2]];e[5]=[g[0],g[1]+d[1],g[2]+d[2]];e[6]=[g[0]+d[0],g[1]+d[1],g[2]];e[7]=[g[0]+d[0],g[1]+d[1],g[2]+d[2]];g=a.vec3_multiply(e[0],this.tMatrix);d=[g[0],g[1],g[2]];f=[g[0],g[1],
g[2]];for(b=1;b<8;++b)g=a.vec3_multiply(e[b],this.tMatrix),d[0]>g[0]&&(d[0]=g[0]),d[1]>g[1]&&(d[1]=g[1]),d[2]>g[2]&&(d[2]=g[2]),f[0]<g[0]&&(f[0]=g[0]),f[1]<g[1]&&(f[1]=g[1]),f[2]<g[2]&&(f[2]=g[2]);this.aabb[0]=d;this.aabb[1]=f;this.dirty=!1}return this.aabb}};var e=0;r.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},attachOctree:function(c){this.octree=c;c.init&&c.init(this);c=this.lights;this.lights=[];for(var b=0,e=c.length;b<e;b++)this.bindLight(c[b]);
c=this.sceneObjects;if(this.octree!==q){b=0;for(e=c.length;b<e;++b){var d=c[b];if(d.obj!==null){if(d.id<0)d.id=f,++f;this.sceneObjectsById[d.id]=d;a.reset(d.octree_aabb,d.position);this.octree.insert(d);(d.octree_common_root===void 0||d.octree_common_root===null)&&log("!!",d.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(c,b,e){if(this.sceneObjects.indexOf(c)==-1){this.sceneObjects.push(c);
b!==q&&b&&this.pickables.push(c);c.name!==null&&(this.sceneObjectsByName[c.name]=c);if(this.octree!==q&&(e===q||e==="true")){if(c.id<0)c.id=f,++f;this.sceneObjectsById[c.id]=c;a.reset(c.octree_aabb,c.position);this.octree.insert(c)}if(c.children)for(var d=0,g=c.children.length;d<g;d++)this.bindSceneObject(c.children[d],b,e);return c}},removeLight:function(a){a=this.lights.indexOf(a);a>=0&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState){if(!this.lockRemovals)this.lockRemovals=
[];this.lockRemovals.indexOf(a)==-1&&this.lockRemovals.push(a)}else if(b=this.sceneObjects.indexOf(a),b>=0&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),b>=0&&this.pickables.splice(b,1),a.name!==null&&this.sceneObjectsByName[a.name]!==q&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var e=a.children.length;b<e;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==q&&(b===q||b==="true"))a.method===d.light.method.GLOBAL?this.global_lights.push(a):
(a.method===d.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(z)},bindCamera:function(a){this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){typeof a!=="object"&&(a=this.getCamera(camName));this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof CubicVR.Light?this.bindLight(a):a instanceof CubicVR.SceneObject?
this.bindSceneObject(a):a instanceof CubicVR.Camera?this.bindCamera(a):a instanceof CubicVR.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof CubicVR.Light?this.removeLight(a):a instanceof CubicVR.SceneObject?this.removeSceneObject(a):a instanceof CubicVR.Camera?this.removeCamera(a):a instanceof CubicVR.RigidBody&&this.removeSceneObject(a.getSceneObject())},setCamera:function(a){if(a)typeof a!=="object"&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){if(a===
q)return this.camera;return this.camerasByName[a]},evaluate:function(a){var b,e;b=0;for(e=this.sceneObjects.length;b<e;b++)this.sceneObjects[b].motion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}b=0;for(e=this.lights.length;b<e;b++){var d=this.lights[b];d.motion!==null&&d.motion.apply(a,d)}},prepareTransforms:function(a){var b,
e;if(a){if(a.doTransform(),a.children){b=0;for(e=a.children.length;b<e;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(this.sceneObjects.length!==0){b=0;for(e=this.sceneObjects.length;b<e;++b)this.prepareTransforms(this.sceneObjects[b])}},updateShadows:function(a){var b=g.gl;if(this.shadows_updated)return!1;else a||this.doTransform(),this.shadows_updated=!0;if(u.features.lightShadows){for(var a=b.getParameter(b.FRAMEBUFFER_BINDING),e=!1,f=b.getParameter(b.VIEWPORT),
n=0,x=this.lights.length;n<x;n++){var q=this.lights[n];if(q.light_type==d.light.type.SPOT_SHADOW||q.light_type==d.light.type.SPOT_SHADOW_PROJECTOR||q.light_type==d.light.type.AREA){var e=!0,w=[new CubicVR.Light(d.light.type.DEPTH_PACK)];if(q.light_type===d.light.type.AREA)q.areaCam=this.camera,q.updateAreaLight();g.shadow_near=q.dummyCam.nearclip;g.shadow_far=q.dummyCam.farclip;q.shadowBegin();for(var r=0,s=this.sceneObjects.length;r<s;r++){var z=this.sceneObjects[r];z.parent||z.visible===!1||z.shadowCast===
!1||this.renderSceneObject(z,q.dummyCam,w,!1,!0)}q.shadowEnd();a&&b.bindFramebuffer(b.FRAMEBUFFER,a)}}e&&b.viewport(f[0],f[1],f[2],f[3])}},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());g.depth_alpha_near=this.camera.nearclip;g.depth_alpha_far=this.camera.farclip},resize:function(a,
b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==q,b=0,e=this.sceneObjects.length;b<e;b++){var d=this.sceneObjects[b];if(d.parent===null&&(this.prepareTransforms(d),a&&(lights=[],d.dirty&&d.obj!==null&&d.adjust_octree(),!(d.visible===!1||a&&(d.ignore_octree||d.drawn_this_frame===!0||d.culled===!0)))))lights=d.dynamic_lights,lights=lights.concat(d.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(lights_rendered=Math.max(lights.length,
lights_rendered),lights_rendered===lights.length&&(lights_list=lights),++objects_rendered),lights=lights.length===0?[g.emptyLight]:lights.sort(z),d.drawn_this_frame=!0}},renderSceneObject:function(a,b,e,d,f,g,n){var w=!1,d=d!==q&&d,f=f||!1,g=g||!1;if(a.visible&&a.obj){a.scale[0]<0&&(w=!w);a.scale[1]<0&&(w=!w);a.scale[2]<0&&(w=!w);w&&gl.cullFace(gl.FRONT);var r=a.obj;if(r.morphTargets!==null&&(a.morphSource!==-1&&r.setMorphSource(a.morphSource),a.morphTarget!==-1&&r.setMorphTarget(a.morphTarget),a.morphWeight!==
null))r.morphWeight=a.morphWeight;a.instanceMaterials&&r.bindInstanceMaterials(a.instanceMaterials);CubicVR.renderObject(r,b,a.tMatrix,e,f,g,this.isWireframe()||a.isWireframe())&&n&&n.push(a);a.instanceMaterials&&r.bindInstanceMaterials(null);w&&gl.cullFace(gl.BACK)}a=a.children;if(d&&a){d=0;for(w=a.length;d<w;d++)this.renderSceneObject(a[d],b,e,!0,f,g,n)}},runEvents:function(a){var b,e;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());b=0;for(e=this.sceneObjects.length;b<e;b++){var d=this.sceneObjects[b];
d.hasEvents()&&d.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){b=0;for(e=this.lockRemovals.length;b<e;b++)this.removeSceneObject(this.lockRemovals[b])}this.lockRemovals=null},render:function(){++this.frames;var a=g.gl,e;e=0;if(this.octree!==q)this.octree.reset_node_visibility(),this.octree.cleanup(),e=this.octree.get_frustum_hits(this.camera),e=e.lights.length;this.doTransform();this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var d,f;d=0;for(f=this.lights.length;d<
f;d++)this.lights[d].prepare(this.camera);var n=[],x=[],r=this.lights;d=0;for(f=this.sceneObjects.length;d<f;d++){var w=this.sceneObjects[d];w.visible===!1||w.parent!==null||this.renderSceneObject(w,this.camera,r,!0,!0,!1,x)}d=0;for(f=x.length;d<f;d++)this.renderSceneObject(x[d],this.camera,r,!1,!1,!0);if(this.collect_stats)this.stats["objects.num_rendered"]=0,this.stats["lights.num_rendered"]=e,this.stats["lights.rendered"]=n,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=
this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)a.cullFace(a.FRONT),e=this.camera.farclip*2/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[e,e,e],this.skybox.scene_object.doTransform(),CubicVR.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),a.cullFace(a.BACK)},
bbRayTest:function(a,b,e){var d=CubicVR.vec3,f=[],b=b.length===2?this.camera.unProject(b[0],b[1]):d.add(a,b),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var n=this.pickables[g];if(n.visible===!0){var q,r;r=n.getAABB();q=r[0];r=r[1];r[0]-q[0]<0.2&&(q[0]-=0.1,r[0]+=0.1);r[1]-q[1]<0.2&&(q[1]-=0.1,r[1]+=0.1);r[2]-q[2]<0.2&&(q[2]-=0.1,r[2]+=0.1);var s=d.multiply(d.add(q,r),0.5),u=d.getClosestTo(a,b,s),s=d.length(d.subtract(u,s));(u[0]>=q[0]&&u[0]<=r[0]?1:0)+(u[1]>=q[1]&&u[1]<=r[1]?1:
0)+(u[2]>=q[2]&&u[2]<=r[2]?1:0)>=e&&f.push({dist:s,obj:n})}}f.length&&f.sort(function(a,b){if(a.dist==b.dist)return 0;return a.dist<b.dist?-1:1});return f}};n.prototype={addMesh:function(a,b,e){this.meshBin[a]===q&&(this.meshBin[a]=[],this.meshBinPtr[a]===q&&(this.meshBinPtr[a]=0));this.meshMap[b]===q&&(this.meshMap[b]=e,this.meshBin[a].push(e))},addImage:function(a,b,e){this.imageBin[a]===q&&(this.imageBin[a]=[],this.imageBinPtr[a]===q&&(this.imageBinPtr[a]=0));this.imageMap[b]===q&&(this.imageMap[b]=
e,this.imageBin[a].push(e))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===
this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:r,SceneObject:s,SkyBox:function(a){var b=a.texture,a=a.mapping,e=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;
var a=1/u.Images[e.texture.tex_id].width;if(e.mapping===null)e.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new CubicVR.Material({name:"skybox",textures:{color:b}}),c=new CubicVR.Mesh;c.sky_mapping=e.mapping;CubicVR.primitives.box({mesh:c,size:1,material:a,uvmapper:{projectionMode:CubicVR.enums.uv.projection.SKY,scale:[1,1,1]}});c.prepare();e.scene_object=new CubicVR.SceneObject(c);e.ready=!0};if(b){if(typeof b==="string")b=new CubicVR.Texture(b,
null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},DeferredBin:n}});
CubicVR.RegisterModule("ScenePhysics",function(u){function z(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function s(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function r(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function n(a){return new Ammo.btVector3(a[0],a[1],a[2])}function q(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function d(a){return[a.x(),a.y(),a.z()]}function g(a){this.setManifold(a)}var a=u.undef,b=CubicVR.enums;
b.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var f,e,c,h,m,u=function(a,b,c){var e;
if(!a.position&&a.sceneObject)e=a,a=a.sceneObject,b=e.properties,c=e.collision;e=CubicVR.get(e)||{};this.properties=new CubicVR.RigidProperties(b?CubicVR.get(b):{collision:c});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=e.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=e.angularVelocity||[0,0,0];this.init_impulse=this.impulse=e.impulse||[0,0,0];this.init_impulsePosition=
this.impulsePosition=e.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(n(this.init_position));this.transform.setRotation(q(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};u.prototype={getProperties:function(){return this.properties},
getSceneObject:function(){return this.sceneObject},getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},
setMass:function(a){this.properties.mass=a},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===b.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),z(this.linearVelocity,h),this.body.setLinearVelocity(h),z(this.angularVelocity,h),this.body.setAngularVelocity(h),CubicVR.vec3.equal([0,0,0],this.impulse)||(z(this.impulse,h),z(this.impulsePosition,m),this.body.applyImpulse(h,m)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(f),a=f.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=f.getRotation(),e.x=a.x(),e.y=a.y(),e.z=a.z(),e.w=a.w(),e.x!=e.x?console.log("rotation is NaN"):(a=e.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();z(this.init_position,a);var a=this.body.getWorldTransform().getRotation(),b=this.init_rotation;e.fromEuler(b[0],b[1],b[2]);a.setX(this.init_rotation[0]);a.setY(this.init_rotation[1]);a.setZ(this.init_rotation[2]);a.setW(this.init_rotation[3]);this.resetMotion();this.activate()}},resetMotion:function(){z(this.init_linearVelocity,
h);this.body.setLinearVelocity(h);z(this.init_angularVelocity,h);this.body.setAngularVelocity(h);CubicVR.vec3.equal([0,0,0],this.init_impulse)||(z(this.init_impulse,h),z(this.init_impulsePosition,m),this.body.applyImpulse(h,m))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var c=a.getShapes(),e,d,h,g,m,o,r,s=[],y=null;d=0;for(h=c.length;d<h;d++){e=c[d];y=null;if(e.type===b.collision.shape.BOX)y=new Ammo.btBoxShape(new Ammo.btVector3(e.size[0]/
2,e.size[1]/2,e.size[2]/2));else if(e.type===b.collision.shape.SPHERE)y=new Ammo.btSphereShape(e.radius);else if(e.type===b.collision.shape.CAPSULE)y=new Ammo.btCapsuleShape(e.radius,e.height);else if(e.type===b.collision.shape.CYLINDER)y=new Ammo.btCylinderShape(new Ammo.btVector3(e.size[0]/2,e.size[1]/2,e.size[2]/2));else if(e.type===b.collision.shape.CONE)y=new Ammo.btConeShape(e.radius,e.height);else if(e.type===b.collision.shape.MESH){r=e.mesh;y=new Ammo.btTriangleMesh;o=e.size;var u=new Ammo.btVector3(0,
0,0),I=new Ammo.btVector3(0,0,0),F=new Ammo.btVector3(0,0,0);g=0;for(m=r.faces.length;g<m;g++){var E=r.faces[g];E.points.length===3&&(u.setValue(r.points[E.points[0]][0]*o[0],r.points[E.points[0]][1]*o[1],r.points[E.points[0]][2]*o[2]),I.setValue(r.points[E.points[1]][0]*o[0],r.points[E.points[1]][1]*o[1],r.points[E.points[1]][2]*o[2]),F.setValue(r.points[E.points[2]][0]*o[0],r.points[E.points[2]][1]*o[1],r.points[E.points[2]][2]*o[2]),y.addTriangle(u,I,F))}this.getMass()===0||this.getType()==b.physics.body.STATIC||
this.getType()==b.physics.body.GHOST?(this.setMass(0),y=new Ammo.btBvhTriangleMeshShape(y,!0)):y=new Ammo.btConvexTriangleMeshShape(y,!0)}else if(e.type===b.collision.shape.CONVEX_HULL){r=e.mesh;o=e.size;u=new Ammo.btVector3(0,0,0);y=new Ammo.btConvexHullShape;g=0;for(m=r.points.length;g<m;g++)z([r.points[g][0]*o[0],r.points[g][1]*o[1],r.points[g][2]*o[2]],u),y.addPoint(u)}else if(e.type===b.collision.shape.HEIGHTFIELD){I=u=r=o=0;if(e.landscape&&e.landscape instanceof CubicVR.Landscape)o=e.landscape.divisions_w,
u=e.landscape.divisions_h,r=e.landscape.size_w,I=e.landscape.size_h,y=e.landscape.getMesh().points;else continue;F=Ammo.allocate(y.length,"double",Ammo.ALLOC_NORMAL);g=0;for(m=o*u;g<m;g++)Ammo.HEAP[F+g]=y[g][1];y=new Ammo.btHeightfieldTerrainShape(o,u,F,1,-100,100,1,0,!0);y.setUseDiamondSubdivision(!0);g=new Ammo.btVector3(r/o,1,I/u);y.setLocalScaling(g)}y&&(e.margin!==0&&y.setMargin(e.margin),s.push({cShape:e,btShape:y}))}c=null;if(s.length===1)c=s[0].btShape;else if(s.length>1){f=new Ammo.btTransform;
c=new Ammo.btCompoundShape(!1);d=0;for(h=s.length;d<h;d++)f.setIdentity(),f.setOrigin(n(s[d].cShape.position)),f.setRotation(q(s[d].cShape.rotation)),c.addChildShape(f,s[d].btShape)}a.setResult(c);a=c}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(z(a,h),this.body.setAngularVelocity(h))},setGravity:function(a){this.gravity=a;this.body&&(z(a,h),this.body.setGravity(h))},getGravity:function(){if(this.gravity&&!this.body)return this.gravity;return d(this.body.getGravity())},
setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(z(a,h),this.body.setLinearVelocity(h))},applyImpulse:function(a,b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(z(this.impulse,h),z(this.impulsePosition,m),this.body.applyImpulse(h,m))},applyForce:function(a,b){this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(z(a,h),z(b,m),this.body.applyImpulse(h,m))},getAngularVelocity:function(){return d(this.body.getAngularVelocity())},getLinearVelocity:function(){return d(this.body.getLinearVelocity())},
activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(b.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(b){this.body&&b!==a&&(b.length||(b=[b,b,b]),z(b,h),this.body.setAngularFactor(h))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==b.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=
a=CubicVR.parseEnum(b.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)z(a,h),this.body&&this.body.getCenterOfMassTransform().setOrigin(h),this.ghost&&this.ghost.getWorldTransform().setOrigin(h)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(c);this.ghost&&this.ghost.getWorldTransform().getRotation(c);var a=new CubicVR.Quaternion;
r(c,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)s(a,c),this.body&&this.body.getCenterOfMassTransform().setRotation(c),this.ghost&&this.ghost.getWorldTransform().setRotation(c)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new CubicVR.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(c);this.ghost&&this.ghost.getWorldTransform().getRotation(c);r(c,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=
a;c.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(c);this.ghost&&this.body.getWorldTransform().setRotation(c)}};var o=function(c){c=c||{};this.ctype=CubicVR.parseEnum(b.physics.constraint,c.ctype)||b.physics.constraint.P2P;this.strength=c.strength||0.1;this.maxImpulse=c.maxImpulse||0;this.rigidBodyA=c.rigidBodyA||c.rigidBody||null;this.rigidBodyB=c.rigidBodyB||null;this.positionA=c.positionA||
[0,0,0];this.positionB=c.positionB||c.position||[0,0,0];this.damping=c.damping!=a?c.damping:1;this.btConstraint=null;this.localPivotA=n(this.positionA);this.localPivotB=n(this.positionB)};o.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;if(this.ctype===b.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL))this.btConstraint=null}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},
setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(z(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};g.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);if(a===Ammo.NULL)return null;return{impulse:a.getAppliedImpulse(),
lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),positionA:d(a.getPositionWorldOnA()),positionB:d(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var y=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=
new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!f||!e)h=new Ammo.btVector3,m=new Ammo.btVector3,f=new Ammo.btTransform,e=new CubicVR.Quaternion,c=new Ammo.btQuaternion};
y.prototype={addConstraint:function(a){var b=a.getConstraint();if(b)return this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0;return!1},removeConstraint:function(a){if(a=a.getConstraint())return this.dynamicsWorld.removeConstraint(a),!0;return!1},setGravity:function(a){z(a,h);this.dynamicsWorld.setGravity(h)},bindSceneObject:function(a,b){var c=new CubicVR.RigidBody(a,b);this.rigidObjects.push(c);c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);
return c},bind:function(a){a instanceof CubicVR.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof CubicVR.RigidBody&&this.bindRigidBody(a)},bindRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(this.ghostObjects.indexOf(a)!==-1)return;this.ghostObjects.push(a);var c=a.getBody();a.properties.blocker||c.setCollisionFlags(c.getCollisionFlags()+b.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(c)}else{if(this.rigidObjects.indexOf(a)!==-1)return;
this.rigidObjects.push(a);c=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(c);a.updateSceneObject(!0)}var e,d;if((e=a.getSceneObject())&&(d=e.getEventHandler()))d.hasEvent(b.event.CONTACT)&&this.contactObjects.push(a),d.hasEvent(b.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(this.ghostObjects.indexOf(a)===-1)return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(this.rigidObjects.indexOf(a)===
-1)return;this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var c,e;if((c=a.getSceneObject())&&(e=c.getEventHandler()))e.hasEvent(b.event.CONTACT)&&this.contactObjects.indexOf(a)!==-1&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),e.hasEvent(b.event.COLLIDE)&&this.collisionObjects.indexOf(a)!==-1&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,
b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,e=0,d=this.rigidObjects.length;e<d;e++)this.rigidObjects[e].updateSceneObject()&&c++;this.active_count=c},triggerEvents:function(){var a,c,e,d,f=this.dynamicsWorld;if(this.contactObjects.length){var h=f.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var m=f.getDispatcher().getManifoldByIndexInternal(a),o=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,n=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||
null;if(o&&(d=o.getSceneObject())&&(c=d.getEventHandler())&&c.hasEvent(b.event.CONTACT))e=c.triggerEvent(b.event.CONTACT),e.self=o,e.other=n,e.contacts?e.contacts.setManifold(m):e.contacts=new g(m);else if(n&&n.isStatic()&&(d=n.getSceneObject())&&(c=d.getEventHandler())&&c.hasEvent(b.event.CONTACT))e=c.triggerEvent(b.event.CONTACT),e.other=o,e.self=n,e.contacts?e.contacts.setManifold(m):e.contacts=new g(m)}}f=this.collisionObjects.length;for(a=0;a<f;a++)if(o=this.collisionObjects[a],(d=o.getSceneObject())&&
(c=d.getEventHandler())&&c.hasEvent(b.event.COLLIDE))if(e=c.getProperties(b.event.COLLIDE),m=e.collidesWith,e.mf=e.mf||[],e.alg=e.alg||[],m&&m.length){h=[];o=o.getBody();a=0;for(iMax=m.length;a<iMax;a++){var n=m[a],q=n.getBody();e.mf[a]||(e.mf[a]=new Ammo.btManifoldResult(o,q));e.alg[a]||(e.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(o,q));e.alg[a].processCollision(o,q,this.dynamicsWorld.getDispatchInfo(),e.mf[a]);e.mf[a].getPersistentManifold().getNumContacts()>0&&(h.push(n),this.dynamicsWorld.getDispatcher().clearManifold(e.mf[a].getPersistentManifold()))}if(h.length&&
(e=c.triggerEvent(b.event.COLLIDE)))e.collisions=h}f=this.ghostObjects.length;for(a=0;a<f;a++)if(e=this.ghostObjects[a],d=e.getSceneObject())if((c=d.getEventHandler())&&c.hasEvent(b.event.CONTACT_GHOST))if(d=e.getBody(),h=d.getNumOverlappingObjects()){e=c.triggerEvent(b.event.CONTACT_GHOST);e.contacts=e.contacts||[];if(e.contacts.length>h)e.contacts.length=h;for(c=0;c<h;c++)m=Ammo.btRigidBody.prototype.upcast(d.getOverlappingObject(c)),e.contacts[c]=m._cvr_rigidbody||null}},reset:function(){for(var a=
0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,c,e){var f,a=n(a);f=n(b);c=c||!1;e=e||!1;b=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!c||body.isKinematicObject()&&!e)))return c=body,e=b.get_m_hitPointWorld(),a=c.getCenterOfMassTransform().inverse().op_mul(e),(f=c._cvr_rigidbody)?(Ammo.destroy(b),{position:d(e),
localPosition:d(a),rigidBody:f,ammoBody:c}):(Ammo.destroy(b),{position:d(e),localPosition:d(a),rigidBody:null,ammoBody:c});Ammo.destroy(b)}};return{ScenePhysics:y,Constraint:o,RigidProperties:function(c){this.type=CubicVR.parseEnum(b.physics.body,c.type);this.mass=c.mass!==a?c.mass:this.type?1:0;this.size=c.size||[1,1,1];this.restitution=c.restitution||(this.type?0:1);this.friction=c.friction||1;if((this.collision=c.collision)&&!this.collision.getShapes)this.collision=new CubicVR.CollisionMap(this.collision);
this.blocker=c.blocker||!1},RigidBody:u,vec3bt_copy:z,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:s,btquat_copy:r}});
CubicVR.RegisterModule("Shader",function(u){function z(e,c){var f=CubicVR.util,g,o,q,r,s=n.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";e.indexOf("\n")!==-1?(q=e,g=a(n.gl,e,"x-shader/x-vertex")):(g=b(n.gl,e),g===null&&(q=f.getURL(e),g=a(n.gl,q,"x-shader/x-vertex")));if(!s.getShaderParameter(g,s.COMPILE_STATUS))this.vertexLog=s.getShaderInfoLog(g),this.success=!1;c.indexOf("\n")!==-1?(r=c,o=a(n.gl,c,"x-shader/x-fragment")):(o=
b(n.gl,c),o===null&&(r=f.getURL(c),o=a(n.gl,r,"x-shader/x-fragment")));if(!s.getShaderParameter(o,s.COMPILE_STATUS))this.fragmentLog=s.getShaderInfoLog(o),this.success=!1;if(this.success){if(this.shader=s.createProgram(),s.attachShader(this.shader,g),s.attachShader(this.shader,o),s.linkProgram(this.shader),!n.gl.getProgramParameter(this.shader,s.LINK_STATUS))d("Error linking shader:\n"+s.getProgramInfoLog(this.shader)),this.success=!1}else g=f.multiSplit(this.vertexLog,";\n"),f=f.multiSplit(this.fragmentLog,
";\n"),g.length&&this.dumpErrors(g,q),f.length&&this.dumpErrors(f,r)}function s(a){this._update=a.update||null;this._init=a.init||null;this._vertex=CubicVR.get(a.vertex)||null;this._fragment=CubicVR.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=a.trim()!==""?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var r=u.undef,n=u.GLCore,q=CubicVR.enums,d=u.log,g=CubicVR.util;q.shader={map:{COLOR:1,
SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,b,d){if(d==="x-shader/x-fragment")d=a.createShader(a.FRAGMENT_SHADER);else if(d==="x-shader/x-vertex")d=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(d,b);a.compileShader(d);return d},b=function(a,b){var d=document.getElementById(b);if(!d)return null;for(var f="",g=d.firstChild;g;)g.nodeType===3&&
(f+=g.textContent),g=g.nextSibling;if(d.type==="x-shader/x-fragment")d=a.createShader(a.FRAGMENT_SHADER);else if(d.type==="x-shader/x-vertex")d=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(d,f);a.compileShader(d);return d};z.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,b,d){d=d||"Error on line";d+=" ";for(var b=b.split("\n"),f=0,g=a.length;f<g;f++){var n=a[f];if(n.indexOf("ERROR: ")===0){var n=n.substr(7).trim(),q=n.substr(0,n.indexOf(" ")),n=n.substr(q.length),
q=q.split(":"),q=parseInt(q[1],10);console.log(q+"> "+b[q-1]);console.log(d+q+", :"+n)}}},bindSelf:function(a){var b,d,f;a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),f=b[0],b=b[1].split("]"),d=b[0],b=b[1].split("."),b=b[1],this[f]===r&&(this[f]=[]),this[f][d]===r&&(this[f][d]={}),this[f][d][b]=this.uniforms[a]):(b=a.split("."),f=b[0],b=b[1],this[f]===r&&(this[f]={}),this[f][b]=this.uniforms[a]):a.indexOf("[")!==-1?(b=a.split("["),f=b[0],b=b[1].split("]"),d=b[0],this[f]===r&&(this[f]=[]),
this[f][d]=this.uniforms[a]):this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);b!==r&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_VERTEX;
this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=q.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==r&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){n.gl.useProgram(this.shader)},setMatrix:function(a,b){var d=this.uniforms[a];if(d!==null){var f=b.length;f===16?n.gl.uniformMatrix4fv(d,!1,b):f===9?n.gl.uniformMatrix3fv(d,
!1,b):f===4&&n.gl.uniformMatrix2fv(d,!1,b)}},setInt:function(a,b){var d=this.uniforms[a];d!==null&&n.gl.uniform1i(d,b)},setFloat:function(a,b){var d=this.uniforms[a];d!==null&&n.gl.uniform1f(d,b)},setVector:function(a,b){var d=this.uniforms[a];if(d!==null){var f=b.length;f==3?n.gl.uniform3fv(d,b):f==2?n.gl.uniform2fv(d,b):n.gl.uniform4fv(d,b)}},clearArray:function(a){a=this.uniforms[a];a!==null&&n.gl.disableVertexAttribArray(a)},bindArray:function(a,b){var d=n.gl,f=this.uniforms[a];if(f!==null){var g=
this.uniform_type[a];g===q.shader.uniform.ARRAY_VERTEX?(d.bindBuffer(d.ARRAY_BUFFER,b),d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(f)):g===q.shader.uniform.ARRAY_UV?(d.bindBuffer(d.ARRAY_BUFFER,b),d.vertexAttribPointer(f,2,d.FLOAT,!1,0,0)):g===q.shader.uniform.ARRAY_FLOAT&&(d.bindBuffer(d.ARRAY_BUFFER,b),d.vertexAttribPointer(f,1,d.FLOAT,!1,0,0))}}};var f={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g,
" ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var b={},a=g.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var d=a[i];d.indexOf("#define")===0&&(d=d.split(" "),d.length>2&&(b[d[1]]=d.slice(2).join(" ")))}return b},replaceAll:function(a,b,d,f){var d=d||"",f=f||"",g;for(g in b)if(b.hasOwnProperty(g))for(var n=d+g+f;a.indexOf(n)!==-1;)a=a.replace(n,d+b[g]+f);return a},getShaderInfo:function(a,b){var d,m,
o,n,q,s,w=["uniform","attribute","varying"],u=[],z={};s={};var H;b===r&&(b="");a=f.tidyScript(a);b=f.tidyScript(b);z.v_define=f.getDefines(a);z.f_define=f.getDefines(b);a=f.replaceAll(a,z.v_define,"[","]");b=f.replaceAll(b,z.f_define,"[","]");H=g.multiSplit(a+"\n"+b,"\n;");var v=[];n=o=-1;d=0;for(m=H.length;d<m;d++)q=H[d],o===-1&&q.indexOf("struct")===0?o=d:n===-1&&o!==-1&&q.indexOf("}")!==-1&&(n=d+1),o!==-1&&n!==-1&&(q=H.slice(o,n).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,
"").replace(/\n\n/gm,"\n"),v.push({start:o,end:n,struct:q.split("\n")}),n=o=-1);d=0;for(m=v.length;d<m;d++){var t=v[d].struct,K=null;o=0;for(n=t.length;o<n;o++)q=t[o].split(" "),q.length<=1||(q[0]=="struct"?(K=q[1],s[K]={}):K&&(s[K][q[1]]=q[0]))}z.struct=s;d=0;for(m=w.length;d<m;d++)z[w[d]]=[];d=0;for(m=H.length;d<m;d++){q=H[d];o=0;for(n=w.length;o<n;o++)if(v=w[o],q.indexOf(v)===0&&(s=q.split(" "),s.length===3&&s[0]==v&&u.indexOf(s[2])===-1))if(u.push(s[2]),s[2].indexOf("[")!==-1){var t=s[2].split("["),
K=t[1].replace("]",""),D=parseInt(K,10);D!==D||(K=D);z[v].push({name:t[0],type:s[1],isArray:!0,len:K})}else z[v].push({name:s[2],type:s[1]})}return z},genShaderVarList:function(a,b){var d=a[b],f=[],g,n,q,r,w,s;if(!d)return[];g=0;for(n=d.length;g<n;g++){var u=d[g];if(a.struct[u.type]){var z=a.struct[u.type];if(z&&u.isArray){q=0;for(r=u.len;q<r;q++)for(s in w=u.name+"["+q+"]",z)z.hasOwnProperty(s)&&f.push({location:w+"."+s,type:z[s],basename:u.name})}else for(s in z)f.push({location:u.name+"."+s,type:z[s],
basename:u.name})}else if(u.isArray){q=0;for(r=u.len;q<r;q++)w=u.name+"["+q+"]",f.push({location:w,type:u.type,basename:u.name})}else f.push({location:u.name,type:u.type,basename:u.name})}return f},getShaderVars:function(a){var b={};b.uniform=f.genShaderVarList(a,"uniform");b.attribute=f.genShaderVarList(a,"attribute");return b}};s.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},
hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,b,d,g,o){d=d||[];a=CubicVR.util.get(a);b=CubicVR.util.get(b);o=o||"#define customShader_splice";if(g=g===r?this._vertex||this._fragment:g)g=a.indexOf(o),o=b.indexOf(o),g!==-1&&this._vertex&&(a=a.substr(0,g)+this._vertex),o!==-1&&this._fragment&&(b=b.substr(0,o)+this._fragment);this._shader=new CubicVR.Shader(a,b);this._shaderInfo=f.getShaderInfo(a,b);this._shaderVars=f.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,
"uniform",d);this._appendShaderVars(this._shaderVars,"attribute",d);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,b,d){for(var a=0,f=this._shaderVars[b].length;a<f;a++){var g=this._shaderVars[b][a],n=g.location;if(d.indexOf(g.basename)===-1)g=g.type,g==="vec3"?b==="attribute"?this._shader.addVertexArray(n):this._shader.addVector(n):g==="vec2"?b==="attribute"?this._shader.addUVArray(n):this._shader.addVector(n):g==="float"?b==="attribute"?
this._shader.addFloatArray(n):this._shader.addFloat(n):g==="sampler2D"||g==="int"?this._shader.addInt(n):(g==="mat4"||g==="mat3"||g==="mat2")&&this._shader.addMatrix(n),this._bindSelf(n)}},_bindSelf:function(a){var b,d,f,g;if(this._shader.uniforms[a]!==null&&(a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),f=b[0],b=b[1].split("]"),d=b[0],b=b[1].split("."),b=b[1],this[f]===r&&(this[f]=[]),this[f][d]===r&&(this[f][d]={}),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},
this[f][d][b]=g):(b=a.split("."),f=b[0],b=b[1],this[f]===r&&(this[f]={}),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[f][b]=g):a.indexOf("[")!==-1?(b=a.split("["),f=b[0],b=b[1].split("]"),d=b[0],this[f]===r&&(this[f]=[]),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[f][d]=g):(g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=g),this._bindings.push(g),g))g.set=function(a){return function(b){g.value=
b;a.update(g)}}(this,g)},_doUpdate:function(){if(this._initialized)if(this._update)this._update(this);else for(var a=0,b=this._bindings.length;a<b;a++)this.update(this._bindings[a])},update:function(a){if(this._initialized){var b=n.gl,d=a.value,f=a.location;if(f!==null)a.type===q.shader.uniform.MATRIX?(a=d.length,a===16?b.uniformMatrix4fv(f,!1,d):a===9?b.uniformMatrix3fv(f,!1,d):a===4&&b.uniformMatrix2fv(f,!1,d)):a.type===q.shader.uniform.INT?b.uniform1i(f,d):a.type===q.shader.uniform.VECTOR?(a=d.length,
a===3?b.uniform3fv(f,d):a===2?b.uniform2fv(f,d):b.uniform4fv(f,d)):a.type===q.shader.uniform.FLOAT?b.uniform1f(f,d):a.type===q.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,d),b.vertexAttribPointer(f,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(f)):a.type===q.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,d),b.vertexAttribPointer(f,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(f)):a.type===q.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,d),b.vertexAttribPointer(f,1,b.FLOAT,
!1,0,0),b.enableVertexAttribArray(f))}}};return{Shader:z,shader_util:f,CustomShader:s}});
CubicVR.RegisterModule("UVMapper",function(u){function z(a){a=CubicVR.get(a)||{};this.rotation=a.rotation===s?[0,0,0]:a.rotation;this.scale=a.scale===s?[1,1,1]:a.scale;this.center=a.center===s?[0,0,0]:a.center;this.projection_mode=a.projectionMode===s?r.uv.projection.PLANAR:CubicVR.parseEnum(r.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===s?r.uv.axis.X:CubicVR.parseEnum(r.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===s?1:a.wrapW;this.wrap_h_count=a.wrapH===s?1:a.wrapH}
var s=u.undef,r=CubicVR.enums,n=2*Math.PI,q=Math.PI/2;r.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var d=function(a,b,d){return a===0&&d===0?0:d===0?a<0?q:-q:d<0?-Math.atan(a/d)+Math.PI:-Math.atan(a/d)},g=function(a,b,d){var e;a===0&&d===0?(e=0,a=b!==0?b<0?-q:q:0):(e=d===0?a<0?q:-q:d<0?-Math.atan(a/d)+Math.PI:-Math.atan(a/d),a=Math.sqrt(a*a+d*d),a=a===0?b<0?-q:q:Math.atan(b/a));return[e,a]};z.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,f,e,c){var h=CubicVR.mat4,m,o,u,x,A,w=new CubicVR.Transform,z=!1,O=null;if(this.center[0]||this.center[1]||this.center[2])w.translate(-this.center[0],-this.center[1],-this.center[2]),z=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
w.rotate(this.rotation[2],0,0,1),this.rotation[1]&&w.rotate(this.rotation[1],0,1,0),this.rotation[2]&&w.rotate(this.rotation[0],1,0,0),z=!0;z&&(O=w.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));var w=0,H=a.faces.length;e&&(w=e);for(c&&(H=c+1);w<H;w++)if(a.faces[w].material===b&&!(f!==s&&a.faces[w].segment!==f)){var v,t,K;if(this.projection_mode===r.uv.projection.CUBIC||this.projection_mode===r.uv.projection.SKY)v=Math.abs(a.faces[w].normal[0]),t=Math.abs(a.faces[w].normal[1]),K=Math.abs(a.faces[w].normal[2]);
for(var e=[],c=0,D=a.faces[w].points.length;c<D;c++){o=a.faces[w].points[c];var B=a.faces[w].points[(c+1)%3],Y=a.faces[w].points[(c+2)%3];m=a.points[o];var I=a.points[B],F=a.points[Y],E;z&&(m=h.vec3_multiply(m,O));E=this.projection_mode;if(E===r.uv.projection.SKY)o=a.sky_mapping,v>=t&&v>=K&&(u=m[2]/this.scale[2]+this.scale[2]/2,x=-m[1]/this.scale[1]+this.scale[1]/2,a.faces[w].normal[0]<0?(u=(o[2][2]-o[2][0])*(1-u),x=1-(o[2][3]-o[2][1])*x,u+=o[2][0],x+=o[2][1]):(u*=o[3][2]-o[3][0],x=1-(o[3][3]-o[3][1])*
x,u+=o[3][0],x+=o[3][1])),t>=v&&t>=K&&(u=m[0]/this.scale[0]+this.scale[0]/2,x=-m[2]/this.scale[2]+this.scale[2]/2,a.faces[w].normal[1]<0?(u*=o[1][2]-o[1][0],x=1-(o[1][3]-o[1][1])*x,u+=o[1][0],x-=o[1][1]):(u*=o[0][2]-o[0][0],x=1-(o[0][3]-o[0][1])*x,u+=o[0][0],x-=o[0][1])),K>=v&&K>=t&&(u=m[0]/this.scale[0]+this.scale[0]/2,x=m[1]/this.scale[1]+this.scale[1]/2,a.faces[w].normal[2]<0?(u*=o[4][2]-o[4][0],x=1-(o[4][3]-o[4][1])*(1-x),u+=o[4][0],x-=o[4][1]):(u=(o[5][2]-o[5][0])*(1-u),x=1-(o[5][3]-o[5][1])*
(1-x),u+=o[5][0],x+=o[5][1])),a.faces[w].setUV([u,x],c);else if(E===r.uv.projection.CUBIC)v>=t&&v>=K&&(u=m[2]/this.scale[2]+0.5,x=m[1]/this.scale[1]+0.5),t>=v&&t>=K&&(u=-m[0]/this.scale[0]+0.5,x=m[2]/this.scale[2]+0.5),K>=v&&K>=t&&(u=-m[0]/this.scale[0]+0.5,x=m[1]/this.scale[1]+0.5),a.faces[w].normal[0]>0&&(u=-u),a.faces[w].normal[1]<0&&(u=-u),a.faces[w].normal[2]>0&&(u=-u),a.faces[w].setUV([u,x],c);else if(E===r.uv.projection.PLANAR)u=this.projection_axis===r.uv.axis.X?m[2]/this.scale[2]+0.5:-m[0]/
this.scale[0]+0.5,x=this.projection_axis===r.uv.axis.Y?m[2]/this.scale[2]+0.5:m[1]/this.scale[1]+0.5,a.faces[w].setUV([u,x],c);else{if(E===r.uv.projection.CYLINDRICAL)E=this.projection_axis,E===r.uv.axis.X?(A=d(m[2],m[0],-m[1]),x=-m[0]/this.scale[0]+0.5):E===r.uv.axis.Y?(A=d(-m[0],m[1],m[2]),x=-m[1]/this.scale[1]+0.5):E===r.uv.axis.Z&&(A=d(-m[0],m[2],-m[1]),x=-m[2]/this.scale[2]+0.5),A=1-A/n,this.wrap_w_count!==1&&(A*=this.wrap_w_count),m=A,o=x;else if(E===r.uv.projection.SPHERICAL){var G,N,J;E=this.projection_axis;
E===r.uv.axis.X?(G=e[o]?e[o]:g(m[2],m[0],-m[1]),e[o]||(e[o]=G),N=e[B]?e[B]:g(I[2],I[0],-I[1]),e[B]||(e[B]=N),J=e[Y]?e[Y]:g(F[2],F[0],-F[1]),e[Y]||(e[Y]=J)):E===r.uv.axis.Y?(G=e[o]?e[o]:g(m[0],-m[1],m[2]),e[o]||(e[o]=G),N=e[B]?e[B]:g(I[0],-I[1],I[2]),e[B]||(e[B]=N),J=e[Y]?e[Y]:g(F[0],-F[1],F[2]),e[Y]||(e[Y]=J)):E===r.uv.axis.Z&&(G=e[o]?e[o]:g(-m[0],m[2],-m[1]),e[o]||(e[o]=G),N=e[B]?e[B]:g(-I[0],I[2],-I[1]),e[B]||(e[B]=N),J=e[Y]?e[Y]:g(-F[0],F[2],-F[1]),e[Y]||(e[Y]=J));Math.abs(G[0]-N[0])>q&&Math.abs(G[0]-
J[0])>q&&(G[0]>N[0]&&G[0]>J[0]?G[0]-=n:G[0]+=n);Math.abs(G[1]-N[1])>q&&Math.abs(G[1]-J[1])>q&&(G[1]>N[1]&&G[1]>J[1]?G[1]-=n:G[1]+=n);A=1-G[0]/n;o=0.5-G[1]/Math.PI;this.wrap_w_count!==1&&(A*=this.wrap_w_count);this.wrap_h_count!==1&&(o*=this.wrap_h_count);m=A}else o=m=0;a.faces[w].setUV([m,o],c)}}}return this}};return{UVMapper:z}});
CubicVR.RegisterModule("Worker",function(u){function z(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){a.data.message!=="init"&&b.message(a.data)},!1)}function s(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new z({message:b})}function r(a){function b(a){a=o.getURL(a);c.send("done",a.length)}var c;c=new z({message:function(a){b(a)}});a&&b(a)}function n(a){function b(a){a=
o.getURL(a);c.send("loaded",a)}var c,d;c=new z({message:function(a){if(a.message==="parse")d=new m,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function q(b){function c(b){var e=new a,f;for(f in b)b.hasOwnProperty(f)&&(e[f]=b[f]);b=e.triangulateQuads().compileVBO(e.compileMap());
d.send("done",b)}var d;d=new z({message:function(a){c(a)}});b&&c(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(d){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var g=u.undef,a=CubicVR.Mesh,b=CubicVR.Texture,f=CubicVR.Material,e=CubicVR.SceneObject,c=CubicVR.Motion,h=CubicVR.Envelope,m=CubicVR.DeferredBin,o=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(b){var d=
b.parsed||function(){},e={},f;b.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if(b.message==="loaded"){var b=(new DOMParser).parseFromString(b.data,"text/xml"),c=o.xml2badgerfish(b);console.log(b);f.send("parse",c)}else if(b.message==="getMesh"){var c=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(c[g]=b.data.mesh[g]);c.bindBuffer(c.bufferVBO(b.data.vbo));e.getMesh&&e.getMesh(c)}else b.message==="parsed"&&d()}}));this.getSceneObject=function(a,
b){f.send("getMesh",a);e.getMesh=b}}function d(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,h={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return h[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete h[settings];else for(var b in h)h[b]===a&&delete h[b]};this.createSceneObjectFromMesh=function(c){var h=c.scene,m=c.object,n=c.assetBase||"",o=g.createSceneFileManager({url:c.mesh,parsed:function(){m&&
o.getSceneObject(m,function(c){for(var c=d(c,new a),g=0,m=c.materials.length;g<m;++g){for(var o=d(c.materials[g],new f),q=0,r=o.textures.length;q<r;++q){var t=o.textures[g];o.textures[g]=new b(n+t.img_path,t.filter_type)}c.materials[g]=o}c=new e(c);h.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(d,m,n,o){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var s=[],v=[];q.onmessage=function(m){function q(a,b){for(var c in a)b[c]=a[c]}function r(a){if(a.motion){for(var b=a.motion.controllers,d=[],e=0,f=b.length;e<f;++e){var g=b[e];if(g){for(var m=[],n=0,o=g.length;n<o;++n){var s=g[n];if(s){var t=s.keys[0];if(s.keys.length>1)t.prev=null,t.next=s.keys[1],t=s.keys[1];for(var u=1,v=s.keys.length-1;u<v;++u)t.prev=s.keys[u-1],t.next=s.keys[u+1],t=s.keys[u+1];if(s.keys.length>1)t=s.keys[s.keys.length-1],t.prev=s.keys[s.keys.length-2],t.next=null;s.firstKey=
s.keys[0];s.lastKey=s.keys[s.keys.length-1];s.keys=s.firstKey;t=new h;q(s,t);m[n]=t}else g[n]=null}d[e]=m}else b[e]=null}a.motion.controllers=d;b=new c;q(a.motion,b);a.motion=b}}function x(b){var c=new e;q(b,c);if(b.obj!==null){var f=v[b.obj.id];if(f===g)if(f=new a,q(b.obj,f),c.obj=f,v[b.obj.id]=f,o){if(f.points.length>0){o.addMesh(d,d+":"+f.id,f);for(var h=0,m=f.faces.length;h<m;++h){var n=f.faces[h],r=n.material;n.material=s[r]!==g?s[r]:0}}}else c.obj.triangulateQuads(),c.obj.calcNormals(),c.obj.compile(),
c.obj.clean();else c.obj=f}c.trans=new Transform;if(b.children&&b.children.length>0&&(c.children=[],b.children)){f=0;for(h=b.children.length;f<h;++f)m=x(b.children[f]),c.bindChild(m)}return c}var u;u=m.data.message;if(u=="materials"){var z=JSON.parse(m.data.data),m=0;for(u=z.length;m<u;++m){var C=new f(z[m].name),E=C.material_id;q(z[m],C);C.material_id=E;s[z[m].material_id]=E;for(var E=0,G=z[m].textures.length;E<G;++E){var N=z[m].textures[E];if(N){var J=Texture_ref[N.img_path];J===g?(N=new b(N.img_path,
N.filter_type,o,d),C.textures[E]=N):C.textures[E]=Textures_obj[J]}else C.textures[E]=0}}}else if(u=="scene"){z=JSON.parse(m.data.data);m=0;for(u=z.sceneObjects.length;m<u;++m){C=z.sceneObjects[m];C.obj!==null&&nop();if(C.reassembled===g)r(C),C.reassembled=!0;z.sceneObjects[m]=x(C)}C=new Scene;m=C.camera;u=m.transform;q(z.camera,m);q(z.camera.transform,u);r(m);C.camera=m;C.camera.transform=u;C.camera.frustum=new Frustum;m=0;for(u=z.sceneObjects.length;m<u;++m){E=z.sceneObjects[m];C.bindSceneObject(E);
try{E.getAABB()}catch(O){}}m=0;for(u=z.lights.length;m<u;++m)E=new Light,q(z.lights[m],E),E.trans=new Transform,r(E),C.bindLight(E);n(C)}else console.log("message from collada worker:",m.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:d,prefix:m,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:s,prepareMesh:q,file:r,sceneFile:n};self.addEventListener("message",function(b){if(b.data.message===
"init"){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});window.CubicVR.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
