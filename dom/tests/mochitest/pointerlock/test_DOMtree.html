<!DOCTYPE HTML>
<html>
  <!--
  https://bugzilla.mozilla.org/show_bug.cgi?id=633602

  Test DOM tree in full screen
  -->
  <head>
    <title>Bug 633602 - file_DOMtree.html</title>
    <script type="application/javascript" src="/tests/SimpleTest/EventUtils.js">
    </script>
    <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js">
    </script>
    <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
    <style>
    </style>
  </head>
  <body onload="start();">
    <a target="_blank"
       href="https://bugzilla.mozilla.org/show_bug.cgi?id=633602">
      Mozilla Bug 633602
    </a>
    <pre id="test">
      <script type="text/javascript">
        /*
         * Test for Bug 633602
         * Checks if element being locked is attached to the DOM Tree
         * Also checks if pointer is unlocked when element is removed from
         * the DOM Tree
         */

        SpecialPowers.setBoolPref("full-screen-api.enabled", true);
        SpecialPowers.setBoolPref("full-screen-api.allow-trusted-requests-only",
                                 false);
        SimpleTest.waitForExplicitFinish(3);

        var div = document.createElement("div")
          , withouthDOM = false
          , withDOM = false
          , removedDOM = false;

        function checkStats() {
          ok(withouthDOM, "If an element is NOT in the " +
            "DOM Tree pointer should NOT be locked");
          ok(withDOM, "Mouse should be locked when DOM element " +
            "is in the tree.");
          ok(removedDOM, "Pointer should be unlocked when " +
            "an element is removed the DOM Tree");
        }

        document.addEventListener("mozpointerlockchange", function (e) {
          if (document.mozPointerLockElement === div) {
            withDOM = true;
            document.body.removeChild(div);
            removedDOM = document.mozPointerLockElement ? false : true;
            document.mozCancelFullScreen();
          }
          
        }, false);

        document.addEventListener("mozpointerlockerror", function (e) {
          withouthDOM = true;
        }, false);

        document.addEventListener("mozfullscreenchange", function (e) {
          if (document.mozFullScreen &&
              document.mozFullScreenElement === div) {
              div.mozRequestPointerLock();
          } 
          else {
            console.log("document.mozPointerLockElement: " + document.mozPointerLockElement);
            checkStats();
            SimpleTest.finish();
          }
        }, false);

        function start() {
          SimpleTest.waitForFocus(function() {
            div.mozRequestPointerLock();
            document.body.appendChild(div);
            div.mozRequestFullScreen();
          });
        }
      </script>
    </pre>
  </body>
</html>
